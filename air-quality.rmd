---
title: "Traffic Density and Air Quality: Comparing Urban and Rural Auckland"
author: "Vishal Goundar"
date: today
format:
  html:
    toc: true
    toc-location: left
    number-sections: false
    theme: flatly
    css: styles.css
    self-contained: true
    fig-cap-location: bottom
    
---   

# Introduction
This project investigates how traffic density influences air quality across urban and rural areas of Auckland between 2016 and 2023. Using a reproducible workflow in R, I integrated publicly available datasets from LAWA (Land, Air, Water Aotearoa), spatial demographics, and traffic count records to explore trends and disparities in pollutant concentrations—focusing primarily on PM10, PM2.5, and NO2.

The analysis aims to uncover how vehicular activity correlates with air pollution across different neighbourhoods, with a particular focus on seasonal patterns, site types, and lockdown periods. By joining spatial, temporal, and environmental data, I was able to model pollution levels using linear regression, random forest, and generalized additive models (GAMs).

Throughout the process, I encountered a number of challenges—especially around handling missing data, aligning traffic and air quality measurements spatially, and capturing nonlinear trends. Each step is documented to ensure full reproducibility, and all visual outputs have been designed with accessibility and interpretability in mind.

The findings highlight clear urban–rural contrasts in pollutant behavior, show how traffic volume spikes influence air quality, and reveal which pollutants are most sensitive to temporal and spatial variations. The workflow and visualizations offer a solid foundation for understanding environmental inequalities.

# Live Blog Version

A blog-formatted version of this analysis is available at:  
[https://vishalgoundar.github.io/air-quality-blog/#sa2-level-air-quality-insights-for-auckland-20162023](https://vishalgoundar.github.io/air-quality-blog/#sa2-level-air-quality-insights-for-auckland-20162023)

This blog presents a web-optimized, interactive view of the same data analysis, styled similarly to posts on *From the Bottom of the Heap* and *R-bloggers*.

# Datasets
To explore the relationship between traffic density and air quality across Auckland from 2016–2023, I integrated several complementary datasets. These spanned environmental monitoring, geospatial boundaries, and traffic infrastructure. My goal was to build a reproducible, spatially-aware dataset that supports comparisons between rural and urban zones, and identifies air quality disparities related to vehicle flow.

# Data Integration Workflow
I began by merging LAWA air quality data with Stats NZ SA2 geospatial polygons using st_join(), matching each monitoring site by location — ensuring that the point geometry of each air station fell within the relevant SA2 multipolygon. This allowed me to spatially attribute each site with its corresponding administrative boundary.

<details><summary>Read more...</summary>

For traffic data, I first joined NZTA's traffic counts with state highway site coordinates to obtain spatial geometry. Then, I performed another spatial join with the SA2 geographies to assign each traffic count site a regional name.

To keep the analysis focused, I filtered both datasets for the Auckland region, using regional council boundaries as a reference.

To enrich the air quality dataset further, I sourced live meteorological and pollutant readings (NO, NO2, PM10, PM2.5, SO2, AQI, wind speed, wind direction, air temperature) from Auckland Council open data portals. These were then harmonised by SA2 name to match those in the LAWA-geospatially joined data.

Because traffic stations and monitoring sites do not always share exact SA2 alignment, I used st_join() with a 1000m buffer distance to assign the nearest SA2 to each traffic site where needed.

Finally, I performed a left_join() to merge the two datasets on their common sa2_name field — yielding a final, reproducible dataset focused on four representative SA2s in Auckland:

* Queen Street (urban commercial)

* Westlake (urban residential)

* Ellerslie South (mixed-use)

* Patumahoe (rural baseline)

This dataset forms the backbone of the subsequent visual and statistical analysis.

##  Air Quality Data
**LAWA Air Quality Monitoring** (2016–2023)
Collected via [LAWA – Land Air Water Aotearoa](https://www.lawa.org.nz/explore-data/air-quality), this includes daily measurements of:
  * AQI
  * PM2.5 and PM10
  * NO and NO2
  * SO2
  * Meteorological factors (AirTemp, WindSpeed, WindDir)

* Auckland Council Environmental Data
Supplemented with hourly pollutant and weather readings from urban sites ([source](https://environmentauckland.org.nz/Data/DataSet/Chart/Location/5/DataSet/Air%20Temp/24-Hour%20Aggregate%20(%C2%B0C)/Interval/Latest)) to enrich data continuity and site-level detail.

## Spatial Data

* SA2 Geospatial Boundaries
Downloaded from [Stats NZ Datafinder](https://datafinder.stats.govt.nz/), these define small-area geographies used for demographic and regional analysis.

* Regional Council Boundaries
Used to filter and focus the scope to Auckland region:
[Regional council shapefiles](https://datafinder.stats.govt.nz/layer/104254-regional-council-2020-generalised/)

## Traffic and Transport Data
* Traffic Volume Counts
Yearly traffic statistics from both [Waka Kotahi (NZTA)](https://www.nzta.govt.nz/) and [Auckland Transport](https://at.govt.nz/), segmented into heavy and light vehicle flows.

* State Highway Site Coordinates
GIS locations of traffic counters, enabling accurate mapping of highway vehicle flow — available from [NZTA GIS portal](https://www.nzta.govt.nz/).

This dataset combination enables precise trend comparisons across air quality, meteorological influences, and transport-related emissions.

## Why this combination?
Bringing these datasets together allowed for rich spatial and temporal comparisons across pollutant concentrations, vehicle movement, and climate conditions. The join workflow was carefully structured for reproducibility, and each step — from sourcing to spatial operations — was implemented using relative file paths, versioned files, and consistent chunk naming. This ensures the entire pipeline can be re-run without manual intervention.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, 
  message = FALSE, fig.width = 15, 
  fig.height = 6, include = TRUE
  )
```

```{r load-required-libaries, message=FALSE, warning=FALSE}
# Load required packages for data manipulation, visualization, geospatial analysis, and modeling

# --- Core Tidyverse Utilities ---
library(dplyr)         # Data manipulation
library(tidyverse)     # Includes ggplot2, readr, tidyr, etc.
library(stringr)       # String operations
library(lubridate)     # Date/time parsing

# --- Visualization ---
library(ggplot2)       # Static plots
library(ggrepel)       # Improved label repulsion in ggplot2
library(ggspatial)     # Add spatial annotations (e.g., north arrow, scale bar)
library(ggpubr)        # Publication-ready plots
library(ggh4x)         # Enhanced ggplot2 faceting
library(GGally)        # Pairwise plots for EDA (e.g., ggpairs)
library(patchwork)     # Combine ggplots
library(viridis)       # Colorblind-friendly palettes
library(RColorBrewer)  # Predefined color palettes
library(colorspace)    # Flexible color space control
library(plotly)        # Interactive graphics
library(leaflet)       # Interactive maps
library(htmlwidgets)   # Save and embed interactive plots

# --- Geospatial Analysis ---
library(sf)            # Simple features (vector data)
library(rnaturalearth) # Basemaps and country boundaries

# --- Data Cleaning & Import ---
library(janitor)       # Clean column names and tabular data
library(readxl)        # Read Excel files

# --- EDA & Imputation ---
library(skimr)         # Summary statistics
library(DescTools)     # Descriptive stats (e.g., mode, Gini)
library(imputeTS)      # Time series imputation

# --- Modeling & Machine Learning ---
library(mgcv)          # Generalized additive models (GAMs)
library(gratia)        # GAM visualization and diagnostics
library(randomForest)  # Random forest models

# --- Profiling & Performance ---
library(profvis)       # Visual profiling of R code performance
```
</details>

# Loading and Preparing LAWA Air Quality Data (2016–2023)

This section loads air quality data from LAWA’s Excel source, cleans column names, standardizes dates, and adds year and spatial coordinates. It addresses missing or inconsistent geographic data, removes invalid concentrations, and prepares the dataset for analysis. These steps ensure a consistent, tidy dataset for exploring pollutant trends across regions and time in New Zealand.

<details><summary>Read more...</summary>

```{r load-lawa-sheet-names-and-air-quality-data}
# Get a list of all sheet names in the provided Excel file to understand the structure of the data
sheet_names <- excel_sheets("data/lawa/lawa_airqualitydownloaddata_2016-2023.xlsx")
sheet_names

# Skip the first 7 rows while loading the air quality data from the "Monitoring dataset" sheet
airdata <- read_excel("data/lawa/lawa_airqualitydownloaddata_2016-2023.xlsx", sheet = "Monitoring dataset")

# Preview the loaded data to inspect its structure
glimpse(airdata)
```

* The dataset contains 232,293 observations across 12 columns, detailing air quality measurements in Auckland. It includes site locations, pollutant indicators, concentrations, agencies, and timestamps, primarily tracking pollutant levels in residential areas.

```{r clean-transform-and-summarize-airdata}
# Clean column names, rename the date column, ensure numeric coordinates, extract year, and preview the cleaned dataset
airdata <- airdata |>
  clean_names() |>
  rename(date = sample_date) |>
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude),
    year = format(date, "%Y")
  )

# Display structure and a summary of the cleaned dataset
str(airdata)
glimpse(airdata)
summary(airdata)
```

* There are 232,293 data observations describing air quality sites, locations, pollutants, dates, and concentration values. 717 missing longitude, and latitude values. Concentration values range from -5.568µg/m³ to 202.8µg/m³, with negative values flagged for removal.

## Visualize Yearly Pollutant Trends

Create boxplots to examine pollutant concentration trends across years, highlighting distributions and outliers.

```{r visualize-lawa-concentration-distribution}
# Visualize concentration data
plot_conc <- ggplot(airdata, aes(x = factor(year), y = concentration)) +
  geom_boxplot(aes(fill = indicator), outlier.color = "#009E73", outlier.shape = 1) +
  facet_wrap(~ indicator, nrow=2, scales = "free_y") +
  scale_fill_viridis_d(option = "plasma") +
  labs(
    title = "All Values",
    x = "Year",
    y = "Concentration (µg/m³)",
    fill = "Pollutant"
  ) + 
  theme_minimal() +
  theme(
    plot.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"),
    axis.title = element_text(size = 11, face = "bold"),
    strip.text = element_text(size = 11, face = "bold")
  )

plot2 <- plot_conc +
  scale_y_continuous(limits = c(0, 25)) +
  labs(title = "Restricted Values") +
  theme(plot.title = element_text(size = 11, face = "bold"))

combined_plot <- plot_conc + plot2 +
  plot_layout(guides = "collect") + # Collect legend
  plot_annotation(
    title = "Air Pollutant Concentration in New Zealand (2016 - 2023)",
    subtitle = "Boxplots grouped by year and pollutant type",
    theme = theme(
      plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 11, hjust = 0.5)
    ))

# Display the plot
print(combined_plot)

# Summary Insight
paste(" PM10 shows higher variability with extreme outliers (~200µg/m³), likely from dust, construction, or fires. PM2.5 is more stable (<90µg/m³) but poses greater long-term health risks due to finer particle size. ")
```
</details>

# Clearing the Air: Tackling Invalid and Missing Data
We cleaned air quality data by replacing negative concentrations with NA and imputing missing Rotorua "Moses Rd" coordinates using Google Maps. Minor site coordinate discrepancies were harmonized by selecting maximum values, ensuring a robust dataset for reliable air pollution analysis.

<details><summary>Read more...</summary>

## Handle Invalid and Missing Data

Remove negative concentrations and fill missing coordinates using verified location data (e.g., Google Maps).

```{r clean-negative-values-and-check-missing-coordinates}
# Identify and handle invalid concentration values
airdata |>
  count(concentration < 0, is.na(concentration))
# 107 observations have negative concentrations. No missing values in this column.

# Replace negative concentrations with NA
airdata <- airdata |>
  mutate(
    concentration = ifelse(concentration < 0, NA, concentration),
    date = as.Date(date))  # Ensure date format is consistent

# Identify missing longitude and latitude values
airdata |>
  filter(is.na(longitude), is.na(latitude)) |>
  count(town, site_name, latitude, longitude)
# 717 coordinates missing — all in Rotorua at Moses Rd site

# Review all coordinate data for Rotorua
airdata |>
  filter(town == "Rotorua") |>
  count(region, site_name, latitude, longitude)
```

717 values of latitude and longitude missing for town Rotorua at site_name: Rotorua at Moses Rd. From [Google Maps](https://www.google.com/maps/place/Edmund+Road,+Rotorua+3015/@-38.1365744,176.2093362,16z/data=!4m15!1m8!3m7!1s0x6d6c26fd8a529507:0x880fa5106b1fb10!2sEdmund+Road,+Rotorua+3015!3b1!8m2!3d-38.136431!4d176.214529!16s%2Fg%2F1tdxw6g1!3m5!1s0x6d6c26fd8a529507:0x880fa5106b1fb10!8m2!3d-38.136431!4d176.214529!16s%2Fg%2F1tdxw6g1?entry=ttu&g_ep=EgoyMDI1MDUwNS4wIKXMDSoJLDEwMjExNDUzSAFQAw%3D%3D), These coordinates roughly point to latitude: -38.1482, longitude: 176.2273

```{r fill-lawa-missing-coordinates-Rotorua}
# Fill in missing coordinates for Rotorua at Moses Rd site name with approximate central coordinates from Google Map
airdata <- airdata |>
  mutate(
    latitude = if_else(
      site_name == "Rotorua at Moses Rd" & is.na(latitude),
      -38.1482, latitude),
    
    longitude = if_else(
      site_name == "Rotorua at Moses Rd" & is.na(longitude),
      176.2273, longitude))

# Display the updated coordinates
airdata |>
  filter(town == "Rotorua") |>
  count(site_name, latitude, longitude)

paste(" Limitation: Coordinates imputed for 'Rotorua at Moses Rd' are approximate, based on Google Maps center of Edmund Road. This may introduce minor spatial uncertainty. ")
```

```{r clean-site-names-with-more-than-one-coordinates}
# Identify site names with multiple locations
repeating_site <- airdata |>
  distinct(site_name, longitude, latitude) |>
  count(site_name) |>
  filter(n > 1) |>
  pull(site_name)

glimpse(repeating_site)

paste(" There are 18 site_name with different longitude and latitude at least once. ")

# Preview coordinates for Geraldine
airdata |>
  filter(site_name == "Geraldine") |>
  mutate(across(c(longitude, latitude), ~format(.x, digits = 16))) |>
  distinct(longitude, latitude)
# The difference is in the precision in the 14th decimal places

# Preview locations for site_name: Anzac Square
airdata |>
  filter(site_name == "Anzac Square") |>
  mutate(across(c(longitude, latitude), ~format(.x, digits = 16))) |>
  distinct(longitude, latitude)
# The difference is in the precision in the 13th and 14th decimal places

# Replace longitude and latitude with the maximum values for repeating sites
airdata <- airdata |>
  group_by(site_name) |>
  mutate(
    longitude = max(longitude, na.rm = TRUE),
    latitude = max(latitude, na.rm = TRUE)
  ) |>
  ungroup()

# Ensure only repeating sites were modified
airdata |>
  count(site_name, longitude, latitude) |>
  count(site_name) |>
  filter(n > 1)
```

## Daily Trends in PM10 and PM2.5 by Town
This section explores daily trends in particulate matter (PM10 and PM2.5) concentrations across New Zealand towns from 2016 to 2023. The plot below shows how air pollution varies spatially and temporally, highlighting peak pollution events and consistent seasonal patterns.

```{r plot-daily-pollutant-trends-by-town, fig.cap="Daily PM10 and PM2.5 concentrations by town (2016–2023)", echo=FALSE, message=FALSE, warning=FALSE}
# Check for duplicate measurements on the same day and site
airdata |>
  count(date, indicator, site_name, site_type) |>
  filter(n > 1) |>
  glimpse()

# Only 13 records have duplicate daily values per site—minor impact, so we proceed by averaging.

# Compute daily average and total concentration per site
dailyairdata <- airdata |>
  group_by(date, year, indicator, site_name, site_type, town, latitude, longitude) |>
  summarise(
    mean_conc = mean(concentration, na.rm = TRUE),
    total_conc = sum(concentration, na.rm = TRUE),
    .groups = "drop"
  )

# Identify the town with the highest total daily concentration for labelling
label_text <- dailyairdata |> 
  group_by(year, indicator) |>
  filter(total_conc == max(total_conc, na.rm = TRUE)) |>
  ungroup() |>
  select(date, year, town, indicator, total_conc)

# Create plot of daily pollutant totals, colored by town and faceted by pollutant
plot_town_conc <- ggplot(dailyairdata, aes(x = date, y =  total_conc, color = town)) +
  geom_point(size = 2) + 
  geom_text_repel(
    data = label_text,
    aes(x = date, y = total_conc, label = town),
    size = 4
  ) +
  scale_x_date(
    breaks = seq(as.Date("2016-01-01"), as.Date("2023-12-31"), by = "6 months"),
    date_labels = "%b%y"
  ) +
  facet_wrap(~ indicator, scales = "free_y", nrow = 2) +
  scale_color_viridis_d(option = "plasma") +
  theme_bw() +
  labs(
    title = "Daily Trends in PM10 and PM2.5 Across New Zealand Towns (2016–2023)",
    subtitle = "Pollution levels vary seasonally and geographically, with peak values labelled",
    x = "Date",
    y = "Daily Pollutant Concentration (µg/m³)"
  ) +
  theme(
    plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5),
    axis.title = element_text(size = 11, face = "bold"),
    legend.position = "none"
  )

# Display the plot
print(plot_town_conc)

# Summary Insight
paste(" Daily PM10 and PM2.5 levels peak in winter due to heating and inversions, while summer shows lower levels. Timaru and Arrowtown lead in PM10 spikes; Rotorua and Tokoroa in PM2.5. Local geography and emissions drive spatial variation. ")
```
</details>

# Mapping PM10 and PM2.5 Trends Across Aotearoa (2016–2023)
Ever wondered how air pollution shifts across time and space in New Zealand? In this section, we dive into PM10 and PM2.5 data from 2016 to 2023, revealing how these fine particles behave across different regions, years, and seasons. Spatial maps showcase where average concentrations are highest, while temporal boxplots uncover patterns in pollution loads over time. Together, they expose regional hotspots and seasonal peaks—offering a clear view of how location and climate shape our air.

<details><summary>Read more...</summary>

## Spatial Plot of Pollutant Concentration Across NZ (2016–2023) 
This map shows average PM10 and PM2.5 concentrations at monitoring sites across New Zealand, projected using NZTM2000. Higher values are observed in densely populated urban regions.

```{r Spatially-plot-average-pollutant-level-over-all-years, fig.cap="Spatial distribution of average PM10 and PM2.5 concentrations (2016–2023)"}

# Summarise mean concentration per town, site_name, longitude, latitude, indicator
avg_airdata <- airdata |> 
  group_by(town, site_name, longitude, latitude, indicator) |>
  summarize(
    mean_conc = mean(concentration, na.rm = TRUE),
    .groups = "drop"
  )
glimpse(avg_airdata)
# There are now 103 town, site_name, coordinates, indicator, and mean_conc over all the dates and years (2016-2023)

# Check min, max of mean.conc per indicator
avg_airdata |>
  count(indicator, min = min(mean_conc), max = max(mean_conc))
# Minimum of mean_conc of PM10 and PM2.5 is 4.69079 and maximum is 30.91735. 

#  Get New Zealand map
nz_map <- ne_countries(scale = "medium", country = "New Zealand", returnclass = "sf")

# Add a projected CRS NZTM2000 (EPSG:2193), which is appropriate for New Zealand
nz_map_proj <- st_transform(nz_map, 2193)

avg_airdata_proj <- st_as_sf(avg_airdata, coords = c("longitude", "latitude"), crs = 4326) |>
  st_transform(2193)
glimpse(avg_airdata_proj)
# The coordinates in avg_airdata are now combined in the geometry column

# Plot daily average pollutant concentration at each air quality monitoring sites
plot_spatial_conc <- ggplot(nz_map_proj) +
  geom_sf(fill = "gray95", color = "gray80") +  # Basemap
  geom_sf(data = avg_airdata_proj, aes(fill = mean_conc), size = 3, shape = 21, stroke = 0.3) +
  geom_sf_text(
    data = avg_airdata_proj, 
    aes(label = town), size = 3, hjust = -0.1, check_overlap = TRUE
    ) +
  scale_fill_viridis_c(
    option = "plasma",
    direction = -1, # darkest = highest
    name = "Avg. Concentration (µg/m³)",
    breaks = c(0, 5, 10, 15, 20, 25, 30, 35)
    #labels = c("25 (PM2.5 limit)", "50 (PM10 limit)", "100", "150", "200")
    ) +
  facet_wrap(~ indicator) +
  coord_sf(xlim = c(1100000, 2100000), ylim = c(4700000, 6200000)) +  # for EPSG:2193
  labs(
    title = "Spatial Patterns in Average Pollutant Concentrations across NZ's Air Quality Monitoring Sites (2016-2023)",  # Add title
    subtitle = "Concentrations measured from Whangarei in the north to Invercargill in the south",
    x = "Longitude", y = "Latitude"
    ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5),
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold")
    ) +
  annotation_scale(location = "br", width_hint = 0.3) +  # Adds scale bar
  annotation_north_arrow(location = "tl", which_north = "true", style = north_arrow_fancy_orienteering())

# Display map
plot_spatial_conc

# Summary Insight
paste(" PM10 and PM2.5 spatial distributions across New Zealand show differing average pollutant concentration patterns. PM10 concentrations exhibit broader regional variability, with high levels in Timaru, Arrowtown, Gore. PM2.5 concentrations appear more localized, clustering around major urban centers. The color gradient further emphasizes intensity differences, with PM10 displaying a more dispersed pattern. ")
```

## Yearly Total Concentrations of PM10 and PM2.5 at NZ Monitoring Sites (2016–2023)
To investigate long-term air quality trends across New Zealand, I calculated the annual total concentrations of PM10 and PM2.5 from 2016 to 2023 for each monitoring site. These totals help identify towns with persistently high or low pollutant levels.

```{r plot-yearly-total-concentrations-at-nz-sites}
# Aggregate pollutant concentrations per year
yearlyairdata <- dailyairdata |>
  group_by(year, town, indicator, latitude, longitude) |>
  summarise(
    total_conc = sum(total_conc, na.rm = TRUE),
    .groups = "drop")
  
summary(yearlyairdata$total_conc)
# Yearly total concentration range from 57.44µg/m³ to 10859.53µg/m³, so using log scale is safe.

# Filter town with the daily lowest and highest concentration of pollutants
text_label <- yearlyairdata |> 
  group_by(year, indicator) |>
  filter(total_conc %in% c(min(total_conc, na.rm = TRUE), max(total_conc, na.rm = TRUE))) |>
  ungroup()

glimpse(text_label)

# Plot yearly total PM10 and PM2.5 concentrations across NZ monitoring sites (2016–2023), using boxplots, with towns labelled at the annual minimum and maximum concentration levels
plot_extremes <- ggplot(data = yearlyairdata, aes(x = factor(year), y = total_conc)) +
  geom_boxplot(aes(color = year), varwidth = TRUE, notch = TRUE) +
  geom_text_repel(
    data = text_label,
    aes(x = year, y = total_conc, label = town),
    size = 3, nudge_y = 0.1
    ) +
  scale_color_viridis_d(option = "plasma") +
  facet_wrap(~ indicator, nrow = 2, scales = "free_y") +
  scale_y_log10(labels = scales::scientific) +
  theme_bw() +
  labs(
    title = "Yearly Total Pollutant Concentrations across Monitoring Multiple Sites in New Zealand (2016-2023)",
    subtitle = "Boxplots of yearly total PM10 and PM2.5 concentrations, with towns labelled at annual extremes",
    x = "Year",
    y = "Yearly Pollutant Concentration (µg/m³)"
  ) +
  theme(
    plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 11, face = "bold"),
    legend.position = "none"
  )

# Display plot
plot_extremes

# Summary Insight
paste(" Timaru, Invercargill, and Mount Maunganui frequently report the highest PM10 totals, likely due to industrial emissions or winter heating. In contrast, Nelson Centre/North, Stoke, and Gisborne show consistently lower PM10 levels, indicating relatively cleaner air. For PM2.5, Timaru, Blenheim, Tokoroa, and Kaiapoi stand out with high concentrations, suggesting combustion-related pollution (e.g., wood fires, traffic). Blenheim, Nelson South, and Te Kuiti often record low PM2.5, pointing to better dispersion or fewer emissions. Using a log-scale Y-axis ensured comparability across sites with wide-ranging concentrations. ")
```

## Seasonal Variation in PM10 and PM2.5 Across New Zealand
Seasonal patterns were also explored by aggregating PM10 and PM2.5 concentrations for each season-year combination (e.g., Win_17, Spr_18). This highlighted the influence of climate and behaviour (e.g., winter heating).

```{r plot-seasonal-total-concentration-for-each-year}
# Add last two digits of year in column year
dailyairdata <- dailyairdata |>
  mutate(year = format(date, "%y"),
         month = as.integer(format(date, "%m")))

# Aggregate pollutant concentrations per season per year
dailyairdata <- dailyairdata |>
  mutate(season = case_when(
    month %in% c(12, 1, 2) ~ "Sum",
    month %in% c(3, 4, 5) ~ "Aut",
    month %in% c(6, 7, 8) ~ "Win",
    month %in% c(9, 10, 11) ~ "Spr"),
    season_year = paste0(season, "_", year))

season_order <- unique(dailyairdata$season_year)

seasonairdata <- dailyairdata |>
  mutate(season_year = factor(season_year, levels = season_order, ordered = TRUE))

seasonairdata <- seasonairdata |>
  group_by(season_year, town, indicator) |>
  summarise(
    total_conc = sum(total_conc, na.rm = TRUE),
    .groups = "drop")

summary(seasonairdata$total_conc)
# Seasonal total concentration range from 7.1µg/m³ to 31168.9µg/m³, so using log scale is valid.

# Filter town with the seasonal lowest and highest concentration of pollutants
text_label <- seasonairdata |> 
  group_by(season_year, indicator) |>
  filter(total_conc %in% c(min(total_conc, na.rm = TRUE), max(total_conc, na.rm = TRUE))) |>
  ungroup()
glimpse(text_label)

# Plot seasonal total pollutant concentration across NZ monitoring sites (2016–2023), using boxplots, with towns labelled at the annual minimum and maximum concentration levels
plot_season <- ggplot(data = seasonairdata, aes(x = season_year, y = total_conc)) +
  geom_line(aes(group = town, color = town), alpha = 0.3) +
  geom_text(
    data = text_label,
    aes(x = season_year, y = total_conc, label = town), font_face = "bold", size = 3, nudge_y = 0.1, check_overlap = TRUE
    ) +
  scale_color_viridis_d(option = "plasma") +
  facet_wrap(~ indicator, nrow = 2, scales = "free_y") +
  scale_y_log10(labels = scales::scientific) +
  theme_bw() +
  labs(
    title = "Seasonal Total Pollutant Concentrations across Monitoring Multiple Sites in New Zealand (2016-2023)",
    subtitle = "Seasonal total PM10 and PM2.5 concentrations, with towns labelled at annual extremes",
    x = "Season Year",
    y = "Seasonal Pollutant Concentration (µg/m³)"
  ) +
  theme(
    plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11, face = "bold"),
    axis.text.y = element_text(size = 11, face = "bold"),
    strip.text = element_text(size = 11, face = "bold"),
    legend.position = "none"
  )

# Display plot
plot_season

# Summary Insight
paste(" PM10 peaks are prominent in Mount Maunganui, Masterton, and Christchurch, especially during winter, aligning with heating season effects. PM2.5 concentrations spike in Christchurch, Masterton, and Timaru, again reflecting fine particulate pollution during colder months. The seasonal lows tend to occur during summer, especially at coastal and low-emission towns. By labelling towns with extreme seasonal values, the plots offer intuitive insights into regional pollutant dynamics. ")
```
</details>

# How Site Type and Location Shape Air Quality Across Aotearoa
What role do monitoring site types and town locations play in shaping air quality? In this section, we unpack how PM10 and PM2.5 concentrations vary across New Zealand by exploring the distribution of monitoring sites and the trends they capture. We start with a map of site types to reveal the national monitoring landscape. Then, we compare daily pollutant levels across site types and towns, uncovering seasonal and spatial differences. Finally, we normalize PM concentrations to their 2016 medians to compare trends fairly across randomly selected towns. Together, these visualizations show how land use, geography, and time interact to influence air quality across Aotearoa.

<details><summary>Read more...</summary>

## Spatial Distribution of Monitoring Site Types
The map below visualizes the geographic spread of air quality monitoring sites, classified by site type (e.g., Residential, Industrial, Coastal).

```{r Static-plot-of-lawa-site-types-monitoring-locations}
# Collect subgroup of longitude, latitude, site_type, and town
airdata_group <- airdata |>
  distinct(longitude, latitude, site_type, town)
glimpse(airdata_group)
# There are 69 data observations.

# Create label dataset of coordinates, and town
label_text <- airdata_group |>
  distinct(latitude, longitude, town)
glimpse(label_text)

# Create a static map of spatial distribution of site types
plot1 <- ggplot(data = airdata_group) +
  geom_point(aes(x = longitude, y = latitude, color = site_type), size = 3) +
  geom_text_repel(data = label_text, aes(x = longitude, y = latitude, label = town)) +
  scale_color_viridis_d(option = "turbo") +
  theme_bw() +
  labs(
    title = "Spatial Distribution of Air Quality Monitoring Site Type in New Zealand (2016–2023)",
    subtitle = "Monitoring site locations grouped by type",
    x = "Longitude", y = "Latitude", color = "") +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 11, face = "bold"),
    legend.position = "bottom", 
    legend.text = element_text(face = "bold"),
    panel.grid.major = element_line(color = "gray80", linetype = "dashed"),
    panel.grid.minor = element_blank())

# Display plot
plot1

# Summary Insight
paste(" Residential sites are widespread, especially in Christchurch and Invercargill, reflecting urban coverage. Industrial and mixed-use sites cluster around Auckland, Wellington, and Hamilton, suggesting targeted monitoring in high-emission areas. Coastal sites, such as those in Wellington and Taupo, support research on marine-influenced air quality. This map illustrates the national monitoring strategy, highlighting the emphasis on urban and industrial air sheds. ")
```

## Time Series of PM10 and PM2.5 by Site Type
Next, I explored how daily concentrations vary by site type over time. These plots help contextualize how urban form and land use influence air quality.

```{r plot_site-types-of-concentration-versus-date}
# Group by date, indicator, site_name, site_type, comput sum of concentrations
dailyairdata <- airdata |>
  group_by(date, indicator, site_name, site_type) |>
  summarise(
    total_conc = sum(concentration, na.rm = TRUE),
    .groups = "drop")

glimpse(dailyairdata)

# Create a plot of PM2.5 and PM10 concentration versus date faceted by site_type
plot1 <- ggplot(dailyairdata, aes(x = date, y = total_conc, color = indicator)) +
  geom_point() +
  scale_color_manual(values = c("PM10" = "#0072B2", "PM2.5" = "#E69F00")) +
  facet_wrap(~ site_type, scales = "free") + 
  theme_bw() +
  labs(
    title = "Daily PM2.5 and PM10 Concentration versus Date at Site Types in New Zealand (2016–2023)",
    subtitle = "Pollutant Concentration grouped by Monitoring site locations type",
    x = "Date",
    y = "Daily total concentration (µg/m³)",
    color = "Indicator"
  ) +
  theme(
    plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    legend.position = "bottom",
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 11, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Display plot1
plot1

# Plot restricted by y axis for more than 25
plot2 <- plot1 +
  scale_y_continuous(limits = c(25, NA)) + 
  labs(
    subtitle = "Pollutant Concentration Restricted for at least 25µg/m³",
  )

# Display plot2
plot2

# Free RAM
rm(dailyairdata)
gc() # Force garbage collection

# Summary Insight
paste(" PM10 levels consistently exceed PM2.5, particularly at Residential and NES sites, likely due to wood burning during colder months. Industrial sites show variable but generally elevated concentrations, possibly due to point-source emissions. Coastal and traffic sites tend to have lower and more stable pollution levels. The restricted plot (≥25µg/m³) isolates extreme pollution events, confirming winter spikes and seasonal variability. These patterns confirm that site type and seasonality are strong predictors of particulate pollution levels. ")
```

## Tracking Shifts in Particulate Pollution Across New Zealand Towns
To compare long-term PM2.5 and PM10 changes across towns fairly, we normalized daily concentrations against 2016 medians. This revealed divergent trends and seasonal patterns shaped by local emissions and environmental conditions from 2016 to 2023.

```{r visualize-normalized-pollution-trends}
# Calculate 2016 medians for PM2.5 and PM10
median16_pm25 <- airdata |>
  filter(indicator == "PM2.5", year == 2016) |>
  summarise(median_2016 = median(concentration, na.rm = TRUE)) |>
  pull(median_2016)

median16_pm10 <- airdata |>
  filter(indicator == "PM10", year == 2016) |>
  summarise(median_2016 = median(concentration, na.rm = TRUE)) |>
  pull(median_2016)

# Normalize PM2.5 and PM10 concentrations to their 2016 medians
normalize_airdata <- airdata |>
  mutate(baseline = case_when(
    indicator == "PM2.5" ~ median16_pm25,
    indicator == "PM10"  ~ median16_pm10,
    TRUE ~ NA_real_  # fallback for other indicators
  )) |>
  mutate(normalized_concentration = concentration / baseline)

# Randomly select 10 towns from the dataset for visualization
set.seed(13) # For reproducibility
townlist <- sample(unique(airdata$town), 10)

# Filter the dataset to include only the selected towns
normalize_subset <- normalize_airdata |>
  filter(town %in% townlist) |>
  mutate(town_indicator = paste0(town, "_", indicator))

# Plot normalized trends
plot1 <- ggplot(normalize_subset, aes(x=date, y = normalized_concentration)) +
  geom_line(aes(color = indicator), lwd=2) +
  facet_wrap(~ town_indicator, scales = "free") +
  scale_color_viridis_d(option = "turbo") +
  theme_bw() +
  labs(
    title = "Relative Trends in PM2.5 and PM10 by Town (2016–2023)",
    subtitle = "Normalized against 2016 median concentrations for each pollutant",
    x = "Date",
    y = "Normalized Concentration",
    legend = "Pollutant"
  ) +
  theme(
    plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
   plot.subtitle = element_text(size = 12, hjust = 0.5),
   axis.title = element_text(size = 12, face = "bold"),
   axis.text = element_text(size = 11, face = "bold"),
   axis.text.x = element_text(angle = 45, hjust = 1),
   strip.text = element_text(size = 11, face = "bold")
  )

# Display plot
plot1

# Free RAM
rm(normalize_airdata, normalize_subset)
gc() # Force garbage collection

# Summary Insight
paste(" PM2.5 and PM10 trends differ across towns, reflecting local emission sources and meteorological influences: Auckland and Rotorua showed distinct PM2.5 spikes around 2020—possibly linked to environmental conditions. Timaru and Cromwell experienced recurring seasonal peaks in both PM types. Other towns, such as Napier and Stoke, displayed fluctuations or declining patterns, possibly due to reduced industrial emissions. These normalized visualizations reveal pollution dynamics over time, allowing fairer comparisons between urban and rural settings regardless of baseline differences. ")
```
</details>

# Random Town Snapshots: PM Trends Across Aotearoa
We randomly selected 10 towns to explore local PM10 and PM2.5 trends from 2016–2023. After cleaning and log-transforming the data, faceted plots reveal seasonal peaks, regional contrasts, and possible environmental shifts shaping air quality across New Zealand.

<details><summary>Read more...</summary>

## Exploring Air Quality Trends Across Random NZ Towns (2016–2023)
This section processes and filters air quality data from 10 randomly selected New Zealand towns to prepare for log-scaled trend analysis.

```{r process-random-town-airdata}
# Identify potential duplicates based on site-specific location
airdata |>
  count(region, site_type, site_name, site_id, latitude, longitude, town) |>
  filter(n > 1) |>
  head()

# Extract unique town names from dataset
town_list <- unique(airdata$town)

# Randomly sample 10 towns with reproducibility
set.seed(13)  
random_town <- sort(sample(town_list, 10))

# Display selected towns
random_town

# Filter for only the selected towns
airdata_sample <- airdata |>
  group_by(region) |>
  filter(town %in% random_town) |>
  ungroup()

# Check for duplicate entries by town-date-indicator
airdata_sample |>
  count(town, date, indicator) |>
  filter(n>1) |>
  head()

# Summarize concentration per town, date, and indicator
airdata_sample <- airdata_sample |>
  group_by(town, date, indicator) |>
  summarize(
    total_conc = sum(concentration, na.rm = TRUE),
    .groups = "drop"
  )

# Inspect summary statistics
glimpse(airdata_sample)
summary(airdata_sample$total_conc)

# Total_conc range from 0 to 159.579 from 1 January 2016 to 31 December 2023.

# Replace zero's with small value for log-scale compatibility
airdata_sample <- airdata_sample |>
  mutate(total_conc = ifelse(
      total_conc == 0, 1e-05, total_conc))

summary(airdata_sample$total_conc)
```

## Visualizing Log-Scaled PM10 and PM2.5 Trends Across Random NZ Towns (2016–2023)
This section explores daily air pollution patterns across 10 randomly selected towns using log-scaled plots. The visualization highlights seasonal peaks, local variability, and differences between PM10 and PM2.5 concentrations over time.

```{r logscale-pm-trend-by-town-2016-2023}
# Colorblind-friendly palette (Okabe-Ito)
colorblind_palette <- c("#999999", "#E69F00", "#440154", "#F0E442", "#009E73", "#D55E00", "#35b779", "#0072B2", "#000000", "#660099", "#CC79A7")

# Function to create trend plots by indicator and town
plot_selected_conc <- function(data, title, subtitle, x_label, y_label, sum_var) {
  # Create the plot using ggplot2
  p <- ggplot(data, aes(x = date, y = {{ sum_var }}, color = indicator)) +
    geom_line() +
    scale_color_manual(values = colorblind_palette) +
    facet_wrap(~ town, scales = "free_y") +
    labs(
      title = title,
      subtitle = subtitle,
      x = x_label,
      y = y_label,
      color = "Indicator"
    ) +
    theme_bw() +
    theme(
      legend.position = "bottom",
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(size = 16, hjust = 0.5, face = "bold"), # Center the main title
      plot.subtitle = element_text(size = 12, hjust = 0.5)
    )
  
  return(p)
}

# Log-scale trend plot
plot_random_log <- plot_selected_conc(
  data = airdata_sample,
  title = "Air Pollutant Concentration Trends in 10 Random Towns (2016–2023)",
  subtitle = "Log-scaled daily PM10 and PM2.5 by indicatior",
  x_label = "Month-Year",
  y_label = "Daily Concentration (log scale)",
  sum_var = total_conc
) +
  scale_x_date(
      breaks = seq(as.Date("2016-01-01"), as.Date("2023-12-31"), by = "6 months"),
      date_labels = "%b %y" # Format date for better readability
    ) +
  scale_y_log10(labels = scales::label_scientific()) # Use log scale for concentration

# Display plot
plot_random_log

# Free RAM
rm(airdata_sample)
gc() # Force garbage collection

# Summary Insight
paste(" Auckland shows relatively stable PM levels, while Napier and Timaru experience more frequent seasonal spikes. Cromwell and Stoke exhibit distinct concentration patterns in 2023, potentially linked to specific local conditions. Other towns remain stable. PM10 and PM2.5 generally align, though PM2.5 varies more, highlighting seasonal and source-specific pollution influences. ")
```

## Mapping Regional Pollution Loads and Cleaning Spatial Metadata
This section validates and cleans region names, resolves town-site mismatches, and detects duplicate coordinates. It then visualizes total pollutant concentrations (2016–2023) by region using geolocated monitoring sites on a map of New Zealand.

```{r check-for-lawa-town-site-name-mismatch}
# --- Check mismatches between site_name and town ---
# There are 51 site_name values that don't match any town name
airdata |>
  filter(!(site_name %in% town)) |>
  count(site_name, town)  |>
  str()

# --- Identify duplicate region-location coordinates ---
# This helps verify if multiple monitoring sites share coordinates
airdata |>
  count(longitude, latitude, region) |>
  filter(n > 1) |>
  tail()

# --- Clean 'region' column by removing the word 'region' and trimming whitespace ---
airdata <- airdata |>
  mutate(region = str_trim(str_remove(region, regex("region", ignore_case = TRUE))))

# --- Fix specific encoding issue: Manawatū → Manawatu ---
airdata <- airdata |> 
  mutate(region = ifelse(region == "Manawatū-Whanganui", "Manawatu-Whanganui", region))

# Preview cleaned region values
tail(airdata$region, 3)

# --- Validate region names against official NZ region list ---
official_nz_regions <- c(
  "Northland", "Auckland", "Waikato", "Bay of Plenty", "Gisborne", "Hawke's Bay", "Taranaki", "Manawatu-Whanganui", "Wellington", "Tasman", "Nelson", "Marlborough", "West Coast", "Canterbury", "Otago", "Southland")

# Count any regions that are still invalid after cleaning
airdata |>
  filter(!(region %in% official_nz_regions)) |>
  count(region)

# Compute total concentration of groups of coordinates and region
region_airdata <- airdata |>
  group_by(region) |>
  summarise(
    longitude = round(longitude, 5), 
    latitude = round(latitude, 5),
    total_conc = sum(concentration, na.rm = TRUE),
    .groups = "drop"
  )

str(region_airdata)
```

```{r map-lawa-total-concentration-by-region}
# Create label data for plotting
label_text <- region_airdata |>
  group_by(region, total_conc) |>
  summarise(
    longitude = min(longitude),
    latitude = min(latitude),
    .groups = "drop"
  )

#  Get New Zealand map
nz_map <- ne_countries(scale = "medium", country = "New Zealand", returnclass = "sf")

# Plot monitoring site locations colored by total concentration, labeled by region
plot <- ggplot(data = nz_map) +
  geom_sf(fill = "gray95", color = "gray80") +  # Basemap
  geom_point(
    data = region_airdata, 
    aes(x = longitude, y = latitude, color = total_conc), size = 5
    ) +
  geom_text_repel(
    data = label_text, aes(x = longitude, y = latitude, label = region, color = total_conc),
  box.padding = 0.3, segment.color = "grey30", hjust = -0.1
) +
  scale_color_viridis_c(
    option = "turbo", trans = "log10",
    labels = scales::label_scientific()) +
  coord_sf(xlim = c(165, 180), ylim = c(-48, -34)) + # Add coord_sf to zoom in to nz
  labs(
    title = "Total Region Pollutant concentrations from Monitoring Sites locations in New Zealand",
    x = "Longitude",
    y = "Latitude",
    color = "Total Pollutant\nConcentration (µg/m³)"
    ) +  # Add title
  theme_bw() +
  theme(legend.position = "right") +
  annotation_scale(location = "br", width_hint = 0.3) +  # Adds scale bar
  annotation_north_arrow(location = "tl", which_north = "true", style = north_arrow_fancy_orienteering())
  
# Display the map
plot

# Summary Insight
paste(" Areas such as Auckland and Canterbury exhibit higher overall pollution levels, likely due to urban density, traffic emissions, and industrial activities. The more rural regions like Gisborne appear in cooler colors, indicating lower concentrations. ")
```
</details>

# Mapping New Zealand’s 2018 Population: From SA2 Areas to Regions
We begin by loading and joining Stats NZ’s 2018 population data with spatial boundaries for SA2 areas and regional councils. Through spatial joins, CRS transformations, and centroid extraction, we prepare geospatial datasets that let us visualize population patterns across fine (SA2) and broad (regional) levels.

<details><summary>Read more...</summary>

## Loading 2018 Population and Regional Boundary Data
Here, I import spatial datasets from Stats NZ to support population-adjusted air quality analysis. The SA2 layer captures 2018 population distribution, while regional shapefiles define council boundaries for mapping and spatial joins.

```{r read-pop2018-spatial-data}
# Read the spatial data (GeoPackage) for SA2 regions
sa2_nz <- st_read("data/SA2_nz.gpkg")

# Preview the spatial data structure
glimpse(sa2_nz)
# The SA2_NZ layer was read from a GeoPackage file using the GPKG driver. It contains 2,151 features with three attribute fields and multipolygon geometries in the NZGD2000 Transverse Mercator projection.

# Load regional map data from [regions](https://datafinder.stats.govt.nz/layer/104254-regional-council-2020-generalised/)

# Load a shape file of regions
regions <- st_read("data/statsnz-regional-council-2020-generalised-SHP/regional-council-2020-generalised.shp")

glimpse(regions)
# The regional-council-2020-generalised layer, read from an ESRI Shapefile, contains 17 multipolygon features representing New Zealand's regional councils. It includes six attribute fields and uses the NZGD2000 Transverse Mercator projected coordinate system for spatial reference.
```

## Merging Population and Regional Boundaries for Spatial Analysis
In this step, I spatially joined 2018 SA2 population data with New Zealand's regional boundaries to enable region-level summaries. After confirming matching coordinate systems, I cleaned names, transformed to WGS84, and ensured clear regional labels.

```{r perform-spatial-join-of-sa2-nz-and-regions}
# Find values from regions columns which does not match
as.data.frame(regions) |>
  filter(REGC2020_1 != REGC2020_2)
# The two columns are different for Manawatu, which has a bar on top in one and the REGC2020_2 does not. Let's select REGC2020_2.

# Ensure both datasets use the same CRS (EPSG: 2193)
st_crs(sa2_nz)$epsg
st_crs(regions)$epsg
# They are same, both sa2_nz and regions datasets are in crs of epsg:2193

# Perform spatial join to assign each SA2 region to a broader regional boundary
sa2_nz <- st_join(sa2_nz, regions[, c("REGC2020_2", "geometry")]) 

# Preview column names of sa2_nz
colnames(sa2_nz)
# There are 5 columns of SA2_Name, SA2_ID, Pop2018, REGC2020_2, and geom 

# Count added regions
st_drop_geometry(sa2_nz) |>
  distinct(REGC2020_2) |>
  str()
# The column contains 17 distinct regions
```

## Mapping and Summarising 2018 Population by Region
I transformed spatial data to WGS84, cleaned region names, calculated polygon centroids, and grouped SA2 areas into regions. This enabled detailed and aggregated visual comparisons of New Zealand’s population distribution.

```{r transform-crs-of-sa2-nz}
# Transform the coordinate reference system (CRS) of sa2_nz to WGS84
sa2_nz <- st_transform(sa2_nz, crs = 4326)  

glimpse(sa2_nz)
# This dataset includes 2,332 rows with SA2 names, IDs, 2018 population data, regional council names, and multipolygon geometries, representing spatial boundaries for statistical areas across New Zealand.

# Check class of geom
class(sa2_nz$geom)
# The geom column in sa2_nz is of class sfc_MULTIPOLYGON, meaning it stores spatial features as multipolygons using the simple features (sf) framework for geospatial vector data in R.

# Clean column names of sa2_nz 
sa2_nz <- sa2_nz |>
  clean_names()

# View column names of sa2_nz
colnames(sa2_nz)
```

```{r remove-region-from-values-in-sa2-nz}
# Preview names of geographical units
st_drop_geometry(sa2_nz) |>
  distinct(sa2_name) |>
  str()
# There are 2151 distinct sa2_name in the dataset sa2_nz

# View distinct region in sa2_nz
as.data.frame(sa2_nz) |>
  distinct(regc2020_2) |>
  glimpse()
# There are 17 distinct region in the sa2_nz dataset

# Rename region column and remove region from values
sa2_nz <- sa2_nz |>
  rename(region = regc2020_2) |>
  mutate(region = str_trim(str_remove(region, regex("region", ignore_case = TRUE))))

glimpse(sa2_nz)
```

```{r compute-centroids-and-locations-of sa2}
# Calculate centroids of geometry polygons
sa2_centroids <- st_centroid(sa2_nz)

# Preview first few rows
glimpse(sa2_centroids)
# Sa2_centroids has 2332 rows with 5 columns, geom column is of point type

# Extract longitude and latitude from centroids
sa2_centroids <- sa2_centroids |>
  mutate(
    longitude = st_coordinates(geom)[, 1],
    latitude = st_coordinates(geom)[, 2])

glimpse(sa2_centroids)
# Now there are two more columns of longitude and latitude of double type

# Group by region and slice minimum location and preserve geometry
label_text <- sa2_centroids |>
  group_by(region) |>
  slice_min(order_by = longitude + latitude, with_ties = FALSE) |> # Sum ensures SW-most
  ungroup() |>
  select(region, longitude, latitude)

glimpse(label_text)
# Label_text contains 17 rows of regions with minimum longitude, minimum latitude, geometry column of point type

# Preview class
class(label_text)
# The object label_text is a spatial data frame of class sf, meaning it contains geospatial features along with attribute data, making it compatible with tidyverse and spatial analysis functions.

# Check coordinate reference system are same
st_crs(sa2_nz) == st_crs(label_text)
# Classes of datasets: sa2_nz and label_text are same
```

```{r plot-population-trends-in-each-region}
# Group and merge SA2 polygons by region to get region-level boundaries and region total population
region_boundaries <- sa2_nz |>
  group_by(region) |>
  summarise(
    total_pop = sum(pop2018),
    geometry = st_union(geom), .groups = "drop")

# Take a glimpse
glimpse(region_boundaries)

paste(" The region_boundaries dataset contains 17 regions with total population and multipolygon geometries. It uses the WGS 84 geodetic coordinate system and covers New Zealand's full extent, making it suitable for spatial analysis and regional population visualization. ")

# Plot region population with both SA2 polygons and region boundaries
plot_spatial <- function(data, fill_var) {
  ggplot(data = data) +
    geom_sf(aes(fill = {{ fill_var }}), color = "#999999", size = 0.2) +  # SA2 polygons
    geom_text_repel(
      data = label_text,
      aes(x = longitude, y = latitude, label = region),
      hjust = -0.2,
      seed = 12  # Ensures reproducible label placement
    ) +
    coord_sf(xlim = c(165, 180), ylim = c(-48, -34)) +
    scale_fill_viridis_c(
      option = "turbo", 
      labels = scales::label_scientific()
      ) +
    theme_minimal() +
    labs(
      x = "Longitude", y = "Latitude",
      fill = "Population (2018)"
      ) +
    annotation_scale(location = "br", width_hint = 0.3) +
    annotation_north_arrow(
      location = "tl", which_north = "true",
      style = north_arrow_fancy_orienteering())
}

plot1 <- plot_spatial(sa2_nz, pop2018) +
  labs(title = "SA2 Population") 

plot2 <- plot_spatial(region_boundaries, total_pop) + 
  labs(title = "Region Population") 

combined_plot <- plot1 + plot2 +
  plot_annotation(
    title ="Spatial Distribution of the 2018 Population in SA2 Areas (Left) and Regions (Right) of New Zealand",
    subtitle = "A comparison of population patterns across fine-scale SA2 areas and broader regional boundaries",
    theme = theme(
      plot.title = element_text(size = 16, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      legend.position = "bottom", 
      legend.title = element_text(size = 11, face = "bold"))
  )

# Display plot
combined_plot

# Summary Insight
paste(" These maps compare population distribution in New Zealand at different scales. The SA2 Population map (left) provides detailed insights, highlighting densely populated urban clusters, while the Region Population map (right) aggregates data, emphasizing regional total population concentration. Auckland appears dominant in both maps, though the finer SA2 breakdown reveals local density patterns. The left map’s scale (0–6,000) captures variations within cities, whereas the right map (400,000–1.6 million) focuses on broader regional totals. ")
```
</details>

# Integrating Spatial Population Data with Air Quality to Reveal Per Capita Pollution Patterns (2016–2023)
By combining air quality measurements with SA2 population data, this section uncovers how pollution exposure varies across New Zealand. Spatial joins, ARIMA-based imputation, and population normalization highlight total and per capita pollutant trends—revealing regional, temporal, and site-type disparities in air quality exposure.

<details><summary>Read more...</summary>

```{r explore-and-convert-airdata-crs-and-test-left-join}
# Explore sa2_nz
class(sa2_nz)
colnames(sa2_nz)
# The sa2_nz object is a simple features (sf) spatial data frame containing five columns: sa2_name, sa2_id, pop2018, region, and geom. It includes 2018 population data and multipolygon geometries for each SA2 area in New Zealand.

# Explore airdata
class(airdata)
colnames(airdata)
# The airdata object is a tibble data frame containing air quality data, including region, site details, location, pollutant indicators, concentration values, and corresponding dates and years for analysis.

# Convert airdata data.frame to sf
# Convert columns "longitude" and "latitude" to WGS84 (EPSG:4326)
airdata <- st_as_sf(airdata, coords = c("longitude", "latitude"), crs = 4326)

glimpse(airdata$geometry)
# The geometry column in airdata now contains 232,293 spatial point features in WGS84 coordinates, each representing air monitoring locations with longitude and latitude, starting near Auckland at (174.7, -36.9).

# Preview region not in airdata region
as.data.frame(sa2_nz) |>
  filter(!(region %in% airdata$region)) |>
  count(region) |>
  as.data.frame()
# The region: Area Outside and Taranaki are not in airdata

# Count region, town, site_name
as.data.frame(airdata) |>
  distinct(region, town, site_name) |>
  glimpse()
# There are 67 distinct region, town, and site_name
```

```{r explore-and-join-sa2_centroids-and-airdata}
# Preview matching CRS
st_crs(sa2_centroids)$epsg
st_crs(airdata)$epsg
# Both datasets have same crs epsg of 4326

# Preview summary
str(sa2_centroids$geom)
str(airdata$geometry)
# sa2_centroids has 2,332 points; airdata has 232,293 points. Both are sfc_POINT with XY coordinates in WGS84.

# Preview sa2_name in region Waikato
as.data.frame(sa2_centroids) |>
  filter(region == "Waikato") |>
  distinct(sa2_name) |>
  glimpse()
#There are 264 distinct sa2_name in region: Waikato

# Preview site_name for region Waikato in airdata
as.data.frame(airdata) |>
  filter(region == "Waikato") |>
  distinct(site_name) |>
  glimpse()
# There are 8 site_name in region: Waikato

# Perform a spatial join of airdata and sa2_centroids to assign each SA2 to a region
airdata_with_sa2 <- st_join(airdata, sa2_centroids[, c("region", "sa2_name", "pop2018", "geom")], join = st_nearest_feature)

# Preview column names 
colnames(airdata_with_sa2)

# Remove columns not needed
airdata_with_sa2 <- airdata_with_sa2 |>
  select(-region.y, -town, -site_id, -agency, -site_name) |>
  rename(region = region.x)

colnames(airdata_with_sa2)

# Free RAM
rm(airdata, sa2_centroids)
gc() # Force garbage collection
```

```{r sum-daily-pollutant-concentrations-grouped-by-features}
# Preview summary of concentration
summary(airdata_with_sa2$concentration)
# Concentration ranges from 0 to 202.8, with mean 12.67, median 10.5, and 107 missing values (NA's).

# Use ARIMA imputation to approximate the missing concentration values.
airdata_with_sa2 <- as.data.frame(airdata_with_sa2) |>
  mutate(arima_concentration = na_kalman(concentration, model = "auto.arima"))  # ARIMA imputation

summary(airdata_with_sa2$arima_concentration)
# All the 107 missing values are now computed using ARIMA and ranges from 0 to 202.8 with a mean of 12.664 and median of 10.494
```

## Normalizing Pollutant Concentrations by Population: Per Capita Trends by Site Type (2016–2024)
This section calculates daily pollutant concentrations normalized by 2018 population to reveal per capita exposure patterns across different monitoring site types. Using population-adjusted values, it compares total and per capita pollution trends, highlights variability by site type, and classifies pollution levels by standard deviations to uncover temporal and spatial air quality disparities.

```{r calculate-conc-per-pop2018-and-plot-pollution-trends}
# Compute total daily pollutant concentrations
daily_airdata <- airdata_with_sa2 |>
  mutate(site_type_indicator = paste0(site_type, "_", indicator)) |>
  group_by(region, site_type_indicator, site_type, indicator, date, sa2_name, pop2018) |>
  summarise(
    total_conc = sum(arima_concentration),
    .groups = "drop"
  )

# Summary statistics
summary(daily_airdata$total_conc)
# total_conc ranges from 0 to 202.8, with mean 12.87, median 10.47.

# Calculate daily concentration per pop2018 
daily_airdata <- daily_airdata |>
  mutate(conc_per_capita = total_conc / pop2018 )

# Preview the new column
summary(daily_airdata$conc_per_capita)
# conc_per_pop18 ranges from 0 to 0.486536 with a mean of 0.007249 and a median of 0.004437
```

```{r pivot_long_format_and_plot_total_per_capita_concentration}
# Transform daily_airdata into a long format for easier plotting
# Separate total concentration and per capita concentration into a "Type" column
long_data <- daily_airdata |>
  group_by(site_type) |>
  pivot_longer(cols = c(total_conc, conc_per_capita),
               names_to = "Type",
               values_to = "Value") |>
  ungroup() |>
  # Convert 'Type' to a factor to control the facets order
  mutate(Type = factor(Type, levels = c("total_conc", "conc_per_capita"))) 

# Define custom labels for facets to make them more descriptive
facet_labels <- c(
  total_conc = "Daily Concentration (µg/m³)",
  conc_per_capita = "Daily Concentration per Capita (µg/m³/person)"
)

# Using column plot, compare daily total and per capita pollutant concentrations by site type
pollutant_concentration_plot <- ggplot(long_data, aes(x = Value, y = site_type, fill = indicator)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  facet_grid(~ Type, scales = "free_x", labeller = labeller(Type = facet_labels)) +
  scale_fill_manual(values = c("#E69F00", "#56B4E9")) + 
  labs(title = "Total and Per Capita Daily Pollutant Concentrations (2016–2024)",
       x = "Daily Concentration (Total and Per Capita)",
       y = "Monitoring Site Type", fill = "Indicator",
       caption = "Per capita values were calculated using 2018 population estimates."
) +
  theme_bw(base_size = 12) +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 10, hjust = 1, face = "bold"),
    strip.text = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11, face = "bold"))

# Display plot
pollutant_concentration_plot

# Free RAM
rm(long_data)
gc() # Force garbage collection

# Summary Insight
paste(" Traffic and industrial sites generally show high total pollutant concentrations, especially for PM10. However, per capita values are lower in densely populated areas due to population dilution. In contrast, mixed-use or coastal sites with fewer residents exhibit higher per capita concentrations despite moderate total values. PM10 levels consistently exceed PM2.5 across all site types, highlighting its dominance in daily particulate pollution from 2016 to 2024. ")
```

```{r plot-z-anomalies-of-pollutant-trends}
# Standardize conc_per_capita and classify based on how many standard deviations from the mean
daily_airdata <- daily_airdata |>
  group_by(site_type, indicator) |>
  mutate(z_score = scale(conc_per_capita),
         conc_per_capita_category = case_when(
           z_score <= -2 ~ "Low",
           z_score <= 0 ~ "Moderate",
           z_score <= 2 ~ "High",
           TRUE ~ "Very High"
         ))

# Define function for pollutant trends categorised by z-anomaly
plot_pollutant_trend_zscore <- function(data, title_var) {
  ggplot(data = data, aes(x = date, y = conc_per_capita)) +
    geom_point(size = 2, alpha = 0.6, aes(color = conc_per_capita_category)) +
    facet_wrap(~ site_type, scales = "free") +
    scale_color_manual(
      name = "Concentration Category", 
      values = c("Low" = "#1b9e77", "Moderate" = "#7570b3",
                 "High" = "#d95f02", "Very High" = "#e7298a")
      ) +
    theme_bw() +
    labs(
      title = paste(title_var, " Daily Concentration Per Capita Trends by Site Type (2016-2023)"),
      subtitle = "By 2018 population Categorized by Z-anomaly",
      x = "Date", y = "Concentration per capita (µg/m³/person)"
      ) +
    theme(
      plot.title = element_text(size = 16, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 11, hjust = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", size = 11),
      axis.text.y = element_text(face = "bold", size = 11),
      axis.title = element_text(face = "bold", size = 11),
      legend.position = "bottom",
      legend.title = element_text(size = 11, face = "bold"))
}

# Display plot for daily PM10 trend
plot_pollutant_trend_zscore(filter(daily_airdata, indicator == "PM10"), "PM10")

# Summary Insight
paste(" Industrial and multi-category sites show the highest PM10 variability, peaking in 2018, 2020, and 2022. Residential and NES sites maintain lower levels with fewer spikes. Traffic-influenced sites experience occasional peaks but remain relatively stable. Overall, site type strongly impacts PM10 trends, with industrial areas displaying the widest range. ")

# Display plot for daily PM2.5 trend
plot_pollutant_trend_zscore(filter(daily_airdata, indicator == "PM2.5"), "PM2.5")

# Summary Insight
paste(" Industrial sites show the highest PM2.5 concentrations with frequent High and Very High Z-anomalies. Residential sites vary, with some exhibiting moderate pollution trends. Coastal and NES sites tend toward lower anomalies. Mixed-use sites Residential-Industrial and Residential-Traffic show inconsistent trends. Overall, site type strongly influences anomaly frequency, highlighting regional air quality disparities. ")
```

## Annual Jittered Per Capita PM10 and PM2.5 Trends by Site Type (2016–2023)
Using jitter plots, this analysis visualizes yearly per capita PM10 and PM2.5 concentrations across site types, classified into four exposure levels. It highlights rising pollution in residential and industrial areas, stable coastal trends, and enables population-adjusted comparisons using 2018 data.

```{r jitter-plot-by-year-site-and-plot-PM10}
# Extract year and classify per capita categories
daily_airdata <- daily_airdata |>
  mutate(year = format(date, "%Y")) |>
  group_by(site_type, indicator, year) |>
  mutate(
    conc_per_capita_category = ntile(conc_per_capita, 4)) |>
  mutate(conc_per_capita_category = factor(
    conc_per_capita_category, 
    labels = c("Low", "Moderate", "High", "Very High"))) |>
  ungroup()

# Define jitter plot function by year and site_type
jitter_plot <- function(data, title_var) {
  ggplot(data, aes(x = factor(year), y = conc_per_capita)) +
    geom_jitter(aes(color = conc_per_capita_category), width = 0.2, alpha = 0.5, size = 1.2) +
    facet_wrap(~ site_type, scales = "free_y") +
    scale_color_viridis_d(
      name = "Concentration Category", option = "C"
    ) +
    theme_bw() +
    labs(
      title = paste(title_var, "Per Capita Concentration by Year and Site (2016-2023)"),
      subtitle = "Jittered points grouped by per capita concentration category",
      x = "Year", y = "Concentration per capita (µg/m³/person)"
    ) +
    theme(
      plot.title = element_text(size = 13, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 11, hjust = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", size = 11),
      axis.text.y = element_text(face = "bold", size = 11),
      axis.title = element_text(face = "bold", size = 11),
      legend.position = "bottom"
    )
}

# Plot and save
jitter_plot(filter(daily_airdata, indicator == "PM10"), "PM10")

# Summary Insight
paste(" The plots show PM10 per capita concentrations across sites from 2016 to 2023, classified into four concentration levels. Residential and industrial sites saw the sharpest increases in 2023. Coastal and traffic sites remained relatively stable, though minor fluctuations occurred. The categorization highlights notable shifts in pollution patterns, emphasizing areas experiencing heightened exposure. Standardization using 2018 population refines comparisons across sites. ")

# Display yearly jitter plot of PM2.5
jitter_plot(filter(daily_airdata, indicator == "PM2.5"), "PM2.5")

# Summary Insight
paste(" The PM2.5 jitter plots reveal distinct site-specific trends. Industrial sites show the highest variability, with elevated peaks in 2023. Residential sites display moderate fluctuations, reflecting seasonal shifts. Coastal sites exhibit the lowest PM2.5 concentrations, with stable trends. Traffic sites maintain consistently high pollution, showing persistent emissions. These differences underscore varying exposure risks based on site type and location. ")
```
</details>

# Spatiotemporal Patterns of Seasonal and Regional Air Pollution in New Zealand (2016–2023)
Air pollution across New Zealand shows interesting seasonal and regional patterns when we look closely at PM10 and PM2.5 levels from 2016 to 2023. By examining how pollution changes with the seasons and across different site types, we see clear peaks and variations influenced by local sources and weather. Regional heatmaps highlight how areas differ, especially during major events like the 2020 COVID-19 lockdown. Zooming in on 2018, we compare total and per capita pollutant concentrations, revealing hotspots and disparities that help us understand the complex air quality landscape across the country.

<details><summary>Read more...</summary>

## Seasonal Trends in Pollutant Concentration by Site Type
We visualize pollutant concentration per capita across seasons and site types, highlighting PM10 and PM2.5 variations, seasonal peaks, and site-specific dispersion dynamics from 2016 to 2023.

```{r seasonal-pollution-by-site-type-heatmap}
# Aggregate daily air quality data into seasonal trends
seasondata <- daily_airdata |>
  mutate(
    year = as.numeric(format(date, "%y")),
    season = case_when(
      month(date) %in% c(12, 1, 2) ~ "Sum", # Summer
      month(date) %in% c(3, 4, 5) ~ "Aut", # Autumn
      month(date) %in% c(6, 7, 8) ~ "Win", # Winter
      month(date) %in% c(9, 10, 11) ~ "Spr", # Spring
      TRUE ~ NA_character_),
      season = factor(season, levels = c("Sum", "Aut", "Win", "Spr")),
    season_year = paste0(season, year),
     # Use this to sort by season-year properly
    season_year = factor(season_year, 
                         levels = unique(season_year[order(year, season)])))

sitedata <- seasondata |>
  group_by(season_year, year, site_type, indicator) |>
  summarise(
    total_conc_per_capita = sum(conc_per_capita, na.rm = TRUE),
    .groups = "drop")

glimpse(seasondata)

# Plot the heatmap of season data
heatmap_seasonal_site_type <- ggplot(sitedata, aes(x = season_year, y = site_type, fill = total_conc_per_capita)) +
  geom_tile(color = "grey90") +
  facet_wrap(~ indicator) +
  scale_fill_viridis_c(option = "C",
  name = "Total Concentration\n(per capita, 2018 pop)") +
  labs(
    title = "Heatmap of Seasonal Pollutant Concentration Per Capita (2016-2023)",
    subtitle = "Summed by site type and season, normalized by 2018 population",
    x = "Season-Year", y = "Site Type") +
  theme_bw(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )

# Display plot
heatmap_seasonal_site_type

# Summary Insight
paste(" The heatmap shows PM10 concentrations generally higher than PM2.5 across most site types and seasons from 2016–2023. PM10 peaks prominently at 'Residential, NES site' and 'Residential, Traffic, Industrial, Coastal, NES site', reaching values above 30. PM2.5 values remain mostly below 10, with modest elevations at residential sites. Missing data patterns differ slightly between the two pollutants, notably in residential-industrial combinations. ")
```

## Regional Trends in Seasonal Per Capita Pollutant Concentration (2016–2023)
This heatmap shows seasonal per capita pollutant concentrations across New Zealand regions (2016–2023), identifying spatial and temporal pollution trends and the effects of the 2020 COVID-19 lockdown.

```{r seasonal-pollution-by-region-heatmap}
# Aggregate seasonal data to region
regiondata <- seasondata |>
  group_by(region, season_year, year, indicator) |>
  summarise(total_conc_per_capita = sum(conc_per_capita, na.rm = TRUE), .groups = "drop")

summary(regiondata$total_conc_per_capita)
# This shows the summary statistics of a dataset, indicating a right-skewed distribution with a mean (1.99) higher than the median (1.03) and a maximum value of 19.3.

# Plot the heatmap
heatmap_seasonal_region <- ggplot(regiondata, aes(x = season_year, y = region, fill = total_conc_per_capita)) +
  geom_tile(color = "grey90") +
  # Add lockdown marker (assuming x-axis is a factor or character)
  geom_vline(xintercept = which(levels(factor(regiondata$season_year)) == "Aut20"), linetype = "dashed", color = "#E69F00", lwd = 2) +
  facet_wrap(~ indicator) +
  scale_fill_continuous_sequential(
    palette = "Mint", name = "Total Concentration\n(per capita, 2018 pop)", rev = FALSE) +
  labs(
    title = "Seasonal Air Pollution per Capita Across NZ Regions (2016–2023)",
    subtitle = "Summed pollutant concentrations by region and season (normalized by 2018 population), with COVID-19 lockdown marked (in orange)",
    x = "Season-Year", y = "Region") +
  theme_bw(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )

# Display plot
heatmap_seasonal_region

# Free RAM
rm(seasondata, regiondata)
gc() # Force garbage collection

# Summary Insight
paste(" The PM10 plot shows consistently higher concentrations across regions, while PM2.5 exhibits more variability with lower overall levels. Seasonal patterns are evident in both, but PM10 peaks are more pronounced. COVID-19 lockdowns affected both pollutants, with sharper declines in PM2.5. Regional disparities are stronger in PM10, highlighting differences in pollution dynamics and sources. The PM2.5 plot has more white spaces, indicating lower concentrations. ")
```

## Comparing Total and Per Capita Air Pollutant Concentrations for 2018
To ensure consistency, we focus on 2018—the year for which both pollutant and population data are available. We aggregate total pollutant concentrations by SA2 regions and compute per capita values using 2018 population figures. Spatial visualisations then highlight the distribution of PM2.5 and PM10 levels across New Zealand, both in total and per person.

```{r aggregate-and-map-pollution-2018}
# Check the structure of SA2-joined airdata
glimpse(airdata_with_sa2)

# Count repeated combinations of SA2 name, geometry, and population
airdata_with_sa2 |>
  count(sa2_name, geometry, pop2018) |>
  tail()

# Filter 2018 data and summarise total pollutant concentration by SA2, indicator, and population
airdata_group <- airdata_with_sa2 |>
  filter(year == 2018) |>
  group_by(sa2_name, geometry, indicator, pop2018) |>
  summarise(
    total_conc18 = sum(concentration, na.rm = TRUE),
    .groups = "drop")

# Display structure of the summarised dataset (86 rows x 5 columns)
glimpse(airdata_group)

# Calculate per capita pollutant concentration for each SA2
airdata_group <- airdata_group |>
  mutate(conc_per_capita18 = total_conc18 / pop2018)

# Ensure airdata_group is an sf (spatial features) object
airdata_group <- st_as_sf(airdata_group)

# Summarise distribution of per capita concentrations
summary(airdata_group$conc_per_capita18)
# Per capita PM10 concentration ranges from 0.07 to 11.95, with a median of 1.73 and a mean of 2.15.

# Prepare label data: unique combinations of SA2, indicator, concentration values, and geometry
label_text <- airdata_group |>
  count(sa2_name, indicator, total_conc18, conc_per_capita18, geometry) |>
  select(-n)

# Confirm label_text is a dataframe
class(label_text)

# Convert label_text to an sf object for spatial operations
label_text <- st_as_sf(label_text)

# Extract longitude and latitude from geometry column for text placement
label_text$longitude <- st_coordinates(label_text)[, 1]
label_text$latitude  <- st_coordinates(label_text)[, 2]

# Summarise longitude range — confirms spatial extent within New Zealand
summary(label_text$longitude)

# Summarise latitude range — confirms coverage from South to North Island
summary(label_text$latitude) 

# Define a reusable function to map pollutant concentrations by SA2
visualize_air_pollution <- function(indicator_var, color_var) {
  ggplot(data = sa2_nz) +
    geom_sf(fill = "grey90", color = "white") +  # base map
    geom_sf(data = airdata_group |> filter(indicator == {{indicator_var}}), aes(color = {{ color_var }}), size = 2) +
    geom_text_repel(data = label_text |> filter(indicator == {{indicator_var}}), aes(x = longitude, y = latitude, label = sa2_name), size = 2.5) +
    scale_color_viridis_c(option = "turbo", labels =  scales::label_scientific()) + 
    coord_sf(xlim = c(165, 180), ylim = c(-48, -34)) + # Add coord_sf to zoom in to nz
    theme_bw() +
    labs(
      x = "Longitude",
      y = "Latitude") +
    theme(
      axis.title = element_text(face = "bold", size = 11),
      axis.text.y = element_text(size = 10),
      axis.text.x = element_text(angle = 45, size = 10, hjust = 1),
      plot.legend = "right") +
    
    annotation_scale(location = "br", width_hint = 0.3) +
    annotation_north_arrow(
      location = "tl", which_north = "true",
      style = north_arrow_fancy_orienteering())
}

# Create spatial plots for PM10 and PM2.5 total concentrations (2018)
plot1 <- visualize_air_pollution("PM10", total_conc18) +
  labs(title = "Total PM10", color = "Total (µg/m³)")

plot2 <- visualize_air_pollution("PM2.5", total_conc18) + 
  labs(title = "Total PM2.5", color = "Total (µg/m³)")

# Combine plots into one figure with title and subtitle
combined_plot <- plot1 + plot2 +
  plot_annotation(
      title = "Total PM2.5 and PM10 Concentration Across New Zealand for the Year Ending 2018",
      subtitle = "Spatial distribution of cumulative pollutant concentrations by SA2 region") &
  theme(
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 12, hjust = 0.5))

# Display plot
combined_plot

# Summary Insight
paste(" Air pollution varies across New Zealand, with PM10 and PM2.5 showing distinct spatial patterns. PM10 concentrations, which include coarse and fine particles, are more widespread, while PM2.5—primarily from combustion sources—forms hotspots in urban areas. Regions like Meeanee–Awatoto and Mayfair appear prominently in both datasets, while Ruakaka and Mount Maunganui Central show pollutant-specific trends. The broader spread of PM10 suggests diverse sources, including road dust, whereas PM2.5 aligns with industrial and traffic emissions. ")
```

```{r map-per-capita-pollutants-2018}
# Create map of per capita PM10 concentrations for 2018
plot1 <- visualize_air_pollution("PM10", conc_per_capita18) +
  labs(title = "PM10 Per Capita", color = "Per Capita (µg/m³)") + scale_color_viridis_c(option = "turbo") 

# Create map of per capita PM2.5 concentrations for 2018
plot2 <- visualize_air_pollution("PM2.5", conc_per_capita18) +
  labs(title = "PM2.5 Per Capita", color = "Per Capita (µg/m³)") + 
  scale_color_viridis_c(option = "turbo") 

# Combine both plots with shared title and styling
per_capita18_plot <- plot1 + plot2 +
  plot_annotation(
    title = "Geospatial Distribution of Air Pollutants Per Capita (2018)",
    subtitle = "Comparison of PM10 and PM2.5 concentrations across SA2 regions") &
  theme(
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 12, hjust = 0.5))

# Display plot
per_capita18_plot

# Free RAM
rm(airdata_group)
gc() # Force garbage collection

# Summary Insight
paste(" Air quality varies across New Zealand, with PM10 and PM2.5 concentrations showing distinct patterns. PM10 levels are higher in Whangarei Central, Gore Main, Taihape and Parkside, while PM2.5 hotspots include Whangarai Central, Kuripuni, Redwoodtown East, and Mount Maunganui Central. PM10 appears more widespread, whereas PM2.5 is more localized in urban areas. These differences matter—PM2.5 particles penetrate deeper into lungs, posing greater health risks. Understanding these trends helps highlight potential environmental influences, such as traffic patterns or meteorological conditions. ")
```
</details>

# Mapping and Standardizing Regional Air Quality in New Zealand
This section explores how particulate matter concentrations varied across New Zealand in 2018 and over time from 2016–2023. We first use an interactive map to visualize regional differences in total and per capita PM exposure. Next, we clean and standardize daily pollutant data using z-scores, enabling meaningful cross-regional trend analysis with log-scaled, faceted visualizations across selected regions.

<details><summary>Read more...</summary>

## Interactive Map of 2018 Particulate Matter Concentrations by SA2 Region
To enhance spatial interpretation, we created an interactive map showing PM10 and PM2.5 concentrations across New Zealand for 2018. Marker size represents total pollutant concentration (µg/m³), while color intensity indicates per capita exposure (µg/m³/person). This visualization allows users to explore regional air quality disparities in both absolute and population-adjusted terms.

```{r interactive-map-pm2018}
# Create Plotly map: marker size = total concentration, color = per capita concentration
interactive_map18 <- plot_ly(
  data = label_text, type = 'scattermapbox', mode = 'markers',
  lat = ~latitude, lon = ~longitude,
  name = NULL, showlegend = FALSE,
  text = ~paste0("SA2: ", sa2_name,
                 "\nIndicator: ", indicator,
                 "\nTotal Concentration: ", total_conc18,
                 "\nConcentration Per Capita: ", conc_per_capita18),
  marker = list(
    size = ~scales::rescale(total_conc18, to = c(8, 20)),
    color = ~conc_per_capita18, colorscale = 'Plasma',
    opacity = 0.8, showscale = TRUE,
    colorbar = list(
      title = "Per Capita Conc. (µg/m³/person)",
      x = 0.95, xanchor = "left", len = 0.75)
    )) |>
  layout(
    title = list(
      text = paste0(
        "<b>Unified Map of Particulate Matter Concentrations (2018)</b><br>",
        "<span style='font-size:18px;'>Marker Size: Total Concentration (µg/m³),
        Color: Per Capita (µg/m³/person)</span>"), x = 0.5),
    mapbox = list(
      style = "open-street-map", zoom = 5,
      center = list(
        lat = median(label_text$latitude, na.rm = TRUE),
        lon = median(label_text$longitude, na.rm = TRUE)))
    )

# Display plot
interactive_map18

paste(" New Zealand’s air quality varies significantly across regions, with particulate matter (PM) concentrations reflecting both human activity and environmental conditions. This map highlights total and per capita PM levels, revealing how pollution impacts individuals versus overall atmospheric load. The deep red zones indicate areas where residents experience heightened exposure, often influenced by traffic, industry, or natural events. Future analyses could explore seasonal changes, meteorological influences, and links to traffic congestion. ")
```

## Standardizing Daily Air Pollutant Concentrations for Cross-Regional Analysis
To enable consistent comparisons across regions, we first removed duplicate entries by aggregating pollutant data by SA2, region, date, and indicator. We then calculated total daily concentrations and standardized them using z-scores. This normalization allows us to detect anomalies and analyze trends over time on a common scale, regardless of differences in baseline pollution levels across regions.

```{r clean-summarize-daily-region-concentration}
#  Check for duplicate pollutant entries recorded on the same day, in the same location, for the same indicator
as.data.frame(airdata_with_sa2) |>
  count(sa2_name, region, date, indicator) |>
  filter(n > 1) |>
  glimpse()
paste("→ Some SA2 regions record pollutant levels multiple times per day per indicator.")

# Combine duplicates by summing concentration values across SA2 name, region, date, and indicator. This step ensures cleaner trend lines for time-series analysis
daily_airdata_with_sa2 <- as.data.frame(airdata_with_sa2) |>
   mutate(region_indicator = paste(region, indicator, sep = " - ")) |>
  group_by(sa2_name, region, date, indicator, region_indicator, pop2018) |>
  summarize(
    region_concentration = sum(concentration, na.rm = TRUE),
    .groups = "drop"
  )

# Confirm that aggregation at the region-date-indicator level has resolved duplicates
daily_airdata_with_sa2 |>
  count(region, date, indicator) |>
  filter(n > 1) |>
  glimpse()

# Further aggregate by region, date, and indicator to prepare for regional trend analysis
daily_airdata_with_sa2 <- daily_airdata_with_sa2 |>
  group_by(region, date, indicator, region_indicator, pop2018) |>
  summarize(
    region_concentration = sum(region_concentration, na.rm = TRUE),
    .groups = "drop")

# Calculate mean pollutant concentration for each region and indicator combination
daily_airdata_with_sa2 <- daily_airdata_with_sa2 |>
  group_by(region, indicator) |>
  mutate(grp_mean = mean(region_concentration, na.rm = TRUE)) |>
  ungroup()

# Compute standardized concentrations (z-scores) to enable cross-region comparison on a uniform scale
daily_airdata_with_sa2 <- daily_airdata_with_sa2 |>
  group_by(region, indicator) |>
  mutate(
    sd_concentration = (region_concentration - mean(region_concentration, na.rm = TRUE)) / sd(region_concentration, na.rm = TRUE)
  ) |>
  ungroup()

# Summary of standardized concentration values
summary(daily_airdata_with_sa2$sd_concentration)

paste("→ Standardized concentration ranges from -2.57 to 7.99, with a median of -0.26 and a mean of 0.")

# Summary of raw regional concentrations
summary(daily_airdata_with_sa2$region_concentration)

paste("→ Regional concentration ranges from 0 to 549.98 µg/m³, with a median of 22.88 and a mean of 40.62.")

# Function to randomly select a fixed number of regions, filter the dataset accordingly, and replace zero concentrations with a small positive value to avoid log/scale issues
prepare_selected_airdata <- function(data, n_regions = 5, seed = 123) {
  set.seed(seed) # Ensure reproducibility
  
  # Randomly sample 'n_regions' unique region names
  selected_regions <- sample(unique(data$region), size = n_regions)
  
  # Filter to selected regions and replace zero concentration values
  data_filtered <- data |>
    filter(region %in% selected_regions) |>
    mutate(
      region_concentration = ifelse(region_concentration == 0, 1e-05, region_concentration)
    ) |>
    ungroup()
  
  return(list(
    data = data_filtered,
    selected_regions = selected_regions
  ))
}
```

```{r plot-log-concentration-by-region-facets}
# Apply function to filter dataset and get selected regions
result <- prepare_selected_airdata(daily_airdata_with_sa2, 6)
daily_airdata_selected <- result$data
selected_regions <- result$selected_regions

# Preview column names and selected regions
colnames(daily_airdata_selected)
selected_regions

# Generate a faceted line plot showing log-scale air pollutant concentration trends by region. This visualizes pollutant concentrations across selected regions from 2016 to 2023
plot_log_by_region <- ggplot(data = daily_airdata_selected, aes(x = date, y = region_concentration, color = indicator)) +
  geom_line(aes(group = region)) +
  scale_color_manual(values = c("PM10" = "#0072B2", "PM2.5" = "#E69F00")) +
  labs(
    title = "Log-Scale Trends in Air Pollutant Concentration in Selected Regions (2016-2023)",
    subtitle = "Log-transformed trends in PM2.5 and PM10 concentration",
    x = "Month-Year",
    y = "Total Pollutant Concentration (log scale)",
    color = "Pollutant Type") +
  theme_bw() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(size = 13, hjust = 0.5, face = "bold"), # Center the main title
    plot.subtitle = element_text(size = 11, hjust = 0.5)
    ) + # Center the subtitle
  facet_wrap(~ region, scales = "free_y") +
  scale_x_date(
    breaks = seq(as.Date("2016-01-01"),
                 as.Date("2023-12-31"), by = "6 months"), # tick every 6 months
    date_labels = "%b %y") +
  scale_y_log10(labels = scales::label_scientific()) # Apply log10 scale

# Display plot
plot_log_by_region

# Summary Insight
paste(" Air pollution trends across New Zealand regions reveal intriguing variations. Canterbury's pronounced seasonal fluctuations hint at climatic influences, while Otago's cyclical peaks suggest recurring pollution sources. Bay of Plenty and Wellington maintain relatively stable pollutant levels, contrasting with the West Coast’s dramatic drops, possibly due to extreme weather events or data gaps. The use of log scales provides clarity in detecting subtle changes over time, distinguishing PM2.5 and PM10 trends. ")
```
</details>

# Tracking Air Quality Extremes and Anomalies Across Regions
To uncover hidden patterns in air pollution, we standardized daily PM2.5 and PM10 concentrations using z-scores and applied percentile thresholds to flag anomalies. Interactive plots reveal when and where pollution levels spike beyond typical ranges. By categorizing each day as “good,” “typical,” or “bad,” we spotlight regional differences—Canterbury shows persistent pollution, while Wellington enjoys comparatively cleaner air year-round.

<details><summary>Read more...</summary>

```{r zscore-threshold-lines-by-region-plot}
# Function to compute specified quantiles (e.g., thresholds) for a numeric column in a dataframe
compute_quantiles <- function(data, column, probs = c(0.05, 0.10, 0.90, 0.95)) {
  column_data <- data[[deparse(substitute(column))]]
  quantile(column_data, probs = probs, na.rm = TRUE)
}

# Compute moderate and extreme anomaly thresholds (5th, 10th, 90th, 95th percentiles)
quantiles <- compute_quantiles(daily_airdata_selected, sd_concentration)
print(quantiles)

# Plot with both threshold lines in new colors
plot_region_zanomaly <- ggplot(data = daily_airdata_selected, aes(x = date, y = sd_concentration, color = indicator)) +
  geom_line(aes(group = region)) +
  scale_color_manual(values = c("PM10" = "#0072B2", "PM2.5" = "#E69F00")) +
  
  # 10th–90th percentile range
  geom_hline(yintercept = quantiles["10%"], linetype = "dashed", color = "#009E73", linewidth = 0.6) +  # Bluish green
  geom_hline(yintercept = quantiles["90%"], linetype = "dashed", color = "#009E73", linewidth = 0.6) +

  # 5th–95th percentile range
  geom_hline(yintercept = quantiles["5%"], linetype = "dashed", color = "#CC79A7", linewidth = 0.8) +  # Reddish purple
  geom_hline(yintercept = quantiles["95%"], linetype = "dashed", color = "#CC79A7", linewidth = 0.8) +

  facet_wrap(~ region, scales = "free_y") +
  scale_x_date(
    breaks = seq(as.Date("2016-01-01"), as.Date("2023-12-31"), by = "6 months"),
    date_labels = "%b %y"
  ) +
  theme_bw() +
  labs(
    title = "Standardized PM2.5 and PM10 Trends by Region (2016–2023)",
    subtitle = "Z-score trends with 10th/90th (green) and 5th/95th (purple) percentiles marking moderate and extreme anomalies",
    x = "Month–Year",
    y = "Standardized Concentration (Z-score)",
    color = "Pollutant"
    ) +
  theme(
    plot.title = element_text(size = 13, hjust = 0.5, face = "bold"), 
    plot.subtitle = element_text(size = 11, hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", size = 11),
    axis.text.y = element_text(size = 11, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(size = 11, face = "bold")
    ) 

# Display the plot
plot_region_zanomaly

# Summary Insight
paste(" Regional air quality trends reveal striking differences in pollutant behavior, particularly in extreme cases. Canterbury exhibits persistently high PM2.5 and PM10 levels, frequently exceeding the 90th and 95th percentiles, indicating prolonged pollution events. In contrast, Bay of Plenty and Wellington experience volatile PM2.5 concentrations, with frequent spikes surpassing upper quantiles. Otago and West Coast display seasonal PM10 peaks, reflecting meteorological influences rather than urban emissions. ")
```

```{r plot-daily-zscore-pollution-categories}
# Assign pollution category based on standardized concentration thresholds
# Categorize each day's standardized concentration as "good", "typical", or "bad", based on 10th and 90th percentile z-score thresholds computed earlier
daily_airdata_selected <- daily_airdata_selected |>
  mutate(pollution_category = case_when(
    sd_concentration < quantiles["10%"] ~ "good",# below 10th
    sd_concentration > quantiles["90%"] ~ "bad", # above 90th
    TRUE ~ "typical")) # between 10th and 90th

# Create a faceted column plot showing daily standardized concentrations. Fill color reflects pollution category: good (green), typical (grey), bad (orange)
plot_threshold <- function(xvar, yvar) {
  p <- ggplot(data = daily_airdata_selected, aes(x = {{xvar}}, y = {{yvar}}, fill = pollution_category)) +
  geom_col(position = "dodge") + # stack columns side by side
  scale_fill_manual(values = c("good" = "#1b9e77", "typical" = "#999999", "bad" = "#d95f02")) +
  theme_bw() +
  labs(
    x = "Month–Year", 
    y = "Daily Standardized Concentration", 
    fill = "Pollution Category") +
  theme(
    plot.title = element_text(size = 13, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 11, angle = 45, hjust = 1, face = "bold"),
    axis.text.y = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    strip.text = element_text(size = 11, face = "bold"))
  return(p)
}

# Display plot
plot_zscore_pollution_categories <- plot_threshold(date, sd_concentration) +
  facet_wrap(~ region_indicator, scales = "free_y") +
  scale_x_date(breaks = seq(
    as.Date("2016-01-01"), as.Date("2023-12-31"), by = "6 months"), labels = scales::date_format("%b%y")) +
  labs(
    title = "Categorized Standardized Daily Air Pollution Levels by Region (2016–2023)",
    subtitle = "Z-score scaled concentrations colored by pollution severity based on 10th/90th percentile cutoffs")

# Display plot
plot_zscore_pollution_categories

# Summary Insight
paste(" Across the regions of New Zealand depicted, a common thread of seasonal air pollution emerges, with particulate matter (PM10 and PM2.5) concentrations generally peaking during the colder winter months. Canterbury stands out with a seemingly higher frequency of 'Bad' air quality days, especially for PM2.5, suggesting potential issues with pollutant trapping. Bay of Plenty also exhibits a clear seasonal pattern with notable 'Bad' days. In contrast, Wellington appears to enjoy relatively better air quality with less pronounced seasonal variation and fewer instances of 'Bad' pollution. Otago and the West Coast, for which only PM10 data is shown, also display seasonal trends but seem to experience fewer severe pollution episodes than Canterbury. These regional differences likely stem from a combination of factors including heating practices, local industrial activity, topography, and prevailing weather patterns. ")
```
</details>

# Tracking the Seasons and Spaces of Air Quality in Aotearoa (2016–2023)
How does air quality ebb and flow across the seasons and places of Aotearoa? This section unpacks PM10 and PM2.5 trends from 2016 to 2023—season by season, region by region. By grouping data by season, applying z-score standardization, and adjusting for population size, we spotlight pollution hotspots and clean-air pockets. From wintry peaks in Otago to spatial disparities across Auckland’s SA2 zones, this deep dive reveals where and when the air turns harmful.

<details><summary>Read more...</summary>

## Seasonal Air Quality Trends and Anomaly Detection
Here, we group daily air quality data by seasons—summer through spring—to smooth out daily noise and reveal clear patterns. Then, we calculate z-scores to spot unusual seasonal pollution spikes across regions, making comparisons fair despite differing baseline levels.

```{r seasonal_aggregation_and_anomaly_calculation}
# Custom function to assign seasons to months
get_season <- function(date) {
  month <- month(date)
  case_when(
    month %in% c(12, 1, 2)  ~ "Sum", # Summer: Dec–Feb
    month %in% c(3, 4, 5)   ~ "Aut", # Autumn: Mar–May
    month %in% c(6, 7, 8)   ~ "Win", # Winter: Jun–Aug
    month %in% c(9, 10, 11) ~ "Spr" # Spring: Sep–Nov
  )
}

# Apply season and year labels
daily_airdata_with_sa2 <- as.data.frame(airdata_with_sa2) |>
  mutate(
    season = get_season(date),
    season = factor(season, levels = c("Sum", "Aut", "Win", "Spr")),
    year = format(date, "%y") 
  ) |>
  group_by(region, season, year, indicator, pop2018) |>
  summarize(
    region_concentration = sum(concentration, na.rm = TRUE),
    .groups = "drop"
  )

paste(" The seasonal grouping helps smooth out daily fluctuations and highlight persistent patterns, such as winter spikes from home heating. ")

# Compute seasonal mean, standard deviation, and z-anomaly by region and indicator
daily_airdata_with_sa2 <- daily_airdata_with_sa2 |>
  group_by(region, season, indicator) |>
  mutate(
    seasonal_mean = mean(region_concentration, na.rm = TRUE),
    seasonal_sd = sd(region_concentration, na.rm = TRUE),
    sd_concentration = (region_concentration - seasonal_mean) / seasonal_sd
  ) |>
  ungroup()

paste("Z-scores allow us to compare variability across regions with very different baseline pollution levels.")
```

## Seasonal Air Pollution Trends: Tracking PM2.5 and PM10 Across Regions
We create season-year labels to track pollutant trends, then plot seasonal PM2.5 and PM10 levels across six regions on a log scale, revealing distinct seasonal patterns and regional pollution variability.

```{r create-season-year-factors}
# Construct ordered labels like "Sum16", "Aut16", ..., "Spr23"
years <- sort(unique(daily_airdata_with_sa2$year))
season_order <- c("Sum", "Aut", "Win", "Spr")
season_year_levels <- as.vector(outer(season_order, years, paste0))

# Create and factorize 'season_year'
daily_airdata_with_sa2 <- daily_airdata_with_sa2 |>
  mutate(
    season_year = factor(paste0(season, year), levels = season_year_levels),
    region_indicator = paste(region, indicator, sep = "_"))
```

```{r define-seasonal-trend-plot-function}
# Preview distinct levels
glimpse(daily_airdata_with_sa2$season_year)

# Define plotting function for seasonal trends
plot <- function(data, y_var) {
  p <- ggplot(data = data, aes(x = season_year, y = {{y_var}}, color = indicator)) +
  geom_point(size = 2) +
  geom_line(aes(group = indicator)) +
  scale_color_manual(values = c("PM10" = "#0072B2", "PM2.5" = "#E69F00")) +
    theme_bw() +
    labs(x = "Season_Year", color = "Pollutant") +
    theme(
      plot.title = element_text(size = 16, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
      axis.text.y = element_text(size = 11, face = "bold"))
}
```

```{r plot-seasonal-trends-selected-regions-logscale}
# Select six regions for detailed seasonal trend analysis
result <- prepare_selected_airdata(daily_airdata_with_sa2, n_regions = 6, seed = 1234)
daily_airdata_selected <- result$data
selected_regions <- result$selected_regions

# Compute quantiles for concentration thresholds
quantiles <- compute_quantiles(daily_airdata_selected, region_concentration)

# Create reference threshold lines
thresholds_df <- data.frame(
  yintercept = quantiles[c("5%", "10%", "90%", "95%")],
  color = c("#CC79A7", "#009E73", "#009E73", "#CC79A7"))

# Plot seasonal concentration trends on a log scale
seasonal_concentration_plot <- plot(daily_airdata_selected, region_concentration) +
  facet_wrap(~ region, scales = "free_y") +
  scale_y_log10(labels = scales::scientific) +
  geom_hline(data = thresholds_df, aes(yintercept = yintercept, color = color), linetype = "dashed", show.legend = FALSE) +
  scale_color_manual(
    values = c("PM10" = "#0072B2", "PM2.5" = "#E69F00",
               "#CC79A7" = "#CC79A7", "#009E73" = "#009E73")) +  # add hline colors too
  labs(
    title = "Seasonal Trends of PM2.5 and PM10 (2016–2023)",
    subtitle = "Six NZ regions showing log-scaled seasonal concentrations with 5–95% quantile bands",
    y = "Seasonal Average Concentration (µg/m³, log scale)")
  
# Display plot
seasonal_concentration_plot

# Summary insight
paste(" Otago shows high seasonal PM10 variability, while Hawke’s Bay and Manawatu-Whanganui remain stable. PM2.5 fluctuates in Tasman and West Coast but stays consistent in Northland. Winter pollution spikes, likely from heating emissions, persist. Quantile lines reveal extremes—Otago’s PM10 fluctuates widely, while Hawke’s Bay and Manawatu-Whanganui have tighter bands, emphasizing seasonal influences on air quality across regions. ")
```

## Seasonal Air Quality Patterns Across New Zealand
This plot highlights how air pollution varies seasonally across regions using standardized scores. It marks moderate and extreme pollution levels, revealing clear differences in PM10 and PM2.5 trends from 2016 to 2023.

```{r plot-zscore-seasonal-trends-selected-regions}
# Compute quantiles (5th, 10th, 90th, 95th percentiles) for Z-score scaled seasonal concentrations
# 'daily_airdata_selected' contains data; 'sd_concentration' is the standardized concentration column
quantiles <- compute_quantiles(daily_airdata_selected, sd_concentration)

# Create a data.frame of thresholds
thresholds_df <- data.frame(
  yintercept = quantiles[c("5%", "10%", "90%", "95%")],
  color = c("#CC79A7", "#009E73", "#009E73", "#CC79A7")
)

# Generate seasonal trend plot of standardized pollutant concentrations across selected regions
seasonal_zscore_plot <- plot(daily_airdata_selected, sd_concentration) +
  facet_wrap(~ region, scales = "free_y") +
  geom_hline(data = thresholds_df, aes(yintercept = yintercept, color = color), linetype = "dashed", show.legend = FALSE) +
  scale_color_manual(
    values = c("PM10" = "#0072B2", "PM2.5" = "#E69F00",
               "#CC79A7" = "#CC79A7", "#009E73" = "#009E73")) +  # add hline colors too
  labs(
    title = "Z-Score Scaled Seasonal Air Quality (2016–2023)",
    subtitle = "Extreme and moderate pollution episodes by region",
    y = "Standardized Concentration (Z-score)")

# Display plot
seasonal_zscore_plot

# Summary insight
paste(" The plots show varying pollution trends across NZ regions from 2016-2023. Hawke’s Bay and Northland exhibit frequent extreme PM2.5 concentrations. Manawatu-Whanganui and Tasman show moderate PM10 fluctuations, while West Coast consistently stays within normal ranges. Otago experiences occasional moderate PM10 increases. Overall, PM10 often reaches extreme levels more frequently than PM2.5 in several regions. ")
```

```{r plot-categorized-zscore-seasonal-trends}
# Categorize pollution levels based on standardized (Z-score) concentration thresholds
daily_airdata_selected <- daily_airdata_selected |>
  mutate(
    pollution_category = case_when(
      sd_concentration < quantiles["10%"] ~ "good",
      sd_concentration > quantiles["90%"] ~ "bad",
      TRUE ~ "typical"),
    
    # Convert to ordered factor for consistent plotting
    pollution_category = factor(pollution_category, levels = c("good", "typical", "bad")))

# Create a plot highlighting pollution category over time
categorized_pollution_plot <- plot_threshold(season_year, sd_concentration) +
  facet_wrap(~ region, scales = "free_y") +
  labs(
    title = "Seasonal Air Quality Trends Categorized by Pollution Levels",
    subtitle = "Teal = Good (<10%), Grey = Typical (10–90%), Orange = Bad (>90%)",
    x = "Season and Year", y = "Pollution Level (Standardized Z-Score)")

# Display the plot
categorized_pollution_plot

paste(" All regions exhibit periods of “bad” (orange) and “good” (teal) pollution categories, with “typical” (grey) being most frequent. Otago, Manawatu-Whanganui, and Hawke’s Bay show more frequent “bad” periods, particularly earlier in the time series. Northland, Tasman, and West Coast experience fewer “bad” periods, with Tasman and West Coast showing more consistent “good” periods later on. ")
```

```{r plot-standardized-concentration-per-capita}
# Compute per capita pollutant concentration by dividing total regional concentration by 2018 population
# Assumes population remained relatively stable between 2016–2023
daily_airdata_selected <- daily_airdata_selected |>
  group_by(region, indicator) |>
  mutate(
    concentration_per_capita = region_concentration / pop2018,
    sd_concentration = scale(concentration_per_capita)[,1]) |>
  ungroup()

# Create faceted column plot of standardized per capita concentrations
plot_per_capita_sd <- plot_threshold(season_year, sd_concentration) +
  facet_wrap(~ region, scales = "free_y") +
  labs(
    title = "Standardized Per Capita Air Pollution Concentrations (2016–2023)",
    subtitle = "Normalized by 2018 regional population to highlight exposure disparities",
    x = "Season and Year",
    y = "Pollution Concentration per Capita (Standardized Z-Score")

# Display plot
plot_per_capita_sd

paste(" Population-normalized metrics reveal hidden disparities—e.g., Northland shows high per capita pollution despite moderate raw totals. ")
```

## SA2-Level Air Quality Insights for Auckland (2016–2023)
This map highlights spatial variation in particulate pollution across Auckland SA2 zones, helping identify areas with elevated per capita exposure for targeted environmental interventions.

```{r sa2-map-auckland}
# Filter the airdata_with_sa2 dataset to include only Auckland region
airdata_with_sa2 <- airdata_with_sa2 |>
  filter(region == "Auckland")

# View the structure of the filtered data
glimpse(airdata_with_sa2)

# Remove unneeded columns for summary calculations
airdata_with_sa2 <- airdata_with_sa2 |>
  select(-region, -lawa_site_id, -arima_concentration)

# Extract longitude and latitude from geometry column
airdata_with_sa2 <- airdata_with_sa2 |>
  mutate(
    longitude = st_coordinates(geometry)[, 1],
    latitude = st_coordinates(geometry)[, 2]
  )

# Summarise concentration data by SA2 area
airdata_summary <- airdata_with_sa2 |>
  group_by(sa2_name, longitude, latitude) |>
  summarise(
    sa2_conc = sum(concentration, na.rm = TRUE), # Sum conc.
    sa2_conc_per_capita = sa2_conc / pop2018 * 100, # Per capita conc.
    .groups = "drop"
  ) |>
  distinct(sa2_name, longitude, latitude, sa2_conc, sa2_conc_per_capita)

# Output for verification
airdata_summary

# Create a Plotly map where:
# - Marker color represents concentration per capita
# - Marker size is fixed (not scaled by concentration)
sa2_auckland_per_capita <- plot_ly(
  data = airdata_summary, type = 'scattermapbox', mode = 'markers',
  lat = ~latitude, lon = ~longitude,
  name = NULL, showlegend = FALSE,
  text = ~paste0(
    "SA2: ", sa2_name,
    "<br>Site Concentration: ", round(sa2_conc, 1), " µg/m³",
    "<br>Per Capita: ", round(sa2_conc_per_capita, 2), " µg/m³/person"),
  marker = list(
    size = 20, # Marker size is fixed
    color = ~sa2_conc_per_capita, 
    colorscale = 'Viridis',
    opacity = 1, showscale = TRUE,
    colorbar = list(
      title = "Per Capita Conc. (µg/m³/person)",
      x = 0.95, xanchor = "left", len = 0.75)
    )) |>
  layout(
    title = list(
      text = "SA2 Auckland Air Pollution: Concentration and Per Capita Exposure",
      x = 0.5, font = list(size = 26)
      ),
    mapbox = list(
      style = "open-street-map", zoom = 10,
      center = list(
        lat = median(airdata_summary$latitude, na.rm = TRUE),
        lon = median(airdata_summary$longitude, na.rm = TRUE)))
    )

# Display the interactive map
sa2_auckland_per_capita

# Summary Insight
paste(" The interactive map reveals spatial disparities in air quality across Auckland SA2 areas from 2016 to 2023. Puni consistently exhibits the highest particulate matter concentrations, indicating significant localized pollution sources. Glen Eden Central, Sunnyhills East, and Henderson Lincoln South show notably low levels, suggesting relatively clean air. Queen Street, Ellerslie South, and Westlake maintain moderate concentrations, likely reflecting persistent but stable urban emissions over time. ")
```
</details>

# Integrating and Enriching Environmental Data Across Auckland
To explore air quality trends across urban and rural Auckland, I created a unified dataset combining pollutant measurements (NO2, NO, PM10, PM2.5), the Air Quality Index (AQI), and meteorological data like air temperature, wind direction, and wind speed. Using modular functions, I managed inconsistent, scattered files and merged them by date and location. This streamlined, reproducible workflow supports easy updates and scalable future analyses.

<details><summary>Read more...</summary>

## Define a Reusable Function for Pollutant Ingestion
Many pollutant CSVs followed a similar structure but had inconsistent column names and often included a duplicated header row. I created a flexible function to read, clean, and aggregate the daily data from any such file:

```{r define-a-reusable-functions-for-pollutant-and-factors}
prepare_pollutant_data <- function(file_path, column_name, start_date = "2016-01-01", end_date = "2024-12-31") {
  # Read CSV
  df <- read.csv(file_path, header = TRUE)
  
  # Rename columns
  colnames(df) <- c("date", column_name)
  
  # Remove first row (header row re-imported as data)
  df <- df[-1, ]
  
  # Convert columns
  df <- df |>
    mutate(
      date = as.Date(date),
      !!sym(column_name) := as.numeric(.data[[column_name]])
    ) |>
    
    # Filter by date range
    filter(date >= as.Date(start_date), date <= as.Date(end_date)) |>
    
    # Group by date and sum the specified column
    group_by(date) |>
    summarize(!!sym(column_name) := sum(.data[[column_name]], na.rm = TRUE), .groups = "drop")
  
  return(df)
}
```

## Reshape the Main Dataset and Prepare for Merging
I pivoted the air quality dataset to wide format (so each pollutant is in its own column), removed redundant variables, and made it ready for integration with the pollutant-specific files.

```{r extract-wide-form-of-indicator-and-remove-in-airdata-with-sa2}
# Using pivot_wider() function to extract wide form of indicator
airdata_with_sa2 <- airdata_with_sa2 |>
  pivot_wider(
    names_from = indicator,
    values_from = concentration
  ) |>
  select(-PM10, -PM2.5) # Remove PM10, and PM2.5 columns

# Take a glimpse
glimpse(airdata_with_sa2)
```

## Ingest AQI Files from Multiple SA2s
Using the prepare_pollutant_data() function, I read AQI data for each SA2 area and then joined them into a single table, tagging each row by its sa2_name. Here, I discovered some inconsistencies in file names (like extra timestamps) which I had to manually correct.

```{r read-aqi-of-sa2-name-then-bind-rows}
# Read Air Quality Index - Henderson
aqi_henderson <- prepare_pollutant_data("data/henderson/aqi-henderson/aqi.csv", "AQI")

# Read Air Quality Index - Pakuranga
aqi_pakuranga <- prepare_pollutant_data("data/pakuranga/aqi-pakuranga/aqi.csv", "AQI")

# Read Air Quality Index - Glen Eden
aqi_gleneden <- prepare_pollutant_data("data/gleneden/aqi-gleneden/aqi.csv", "AQI")

# Read Air Quality Index - Patumahoe
aqi_patumahoe <- prepare_pollutant_data("data/patumahoe/aqi-patumahoe/aqi.csv", "AQI")

# Read Air Quality Index - Takapuna
aqi_takapuna <- prepare_pollutant_data("data/takapuna/aqi-takapuna/aqi.csv", "AQI")

# Read Air Quality Index - Penrose
aqi_penrose <- prepare_pollutant_data("data/penrose/aqi-penrose/aqi.csv", "AQI")

# Read Air Quality Index - Queen Street
aqi_queenstreet <- prepare_pollutant_data("data/queenstreet/aqi-queenstreet/aqi.csv", "AQI")

# Bind rows of air quality index
bind_pollutant_data <- function(data_list, sa2_names) {
  names(data_list) <- sa2_names
  bind_rows(data_list, .id = "sa2_name")
}

aqi_combined <- bind_pollutant_data(
  list(aqi_henderson, aqi_pakuranga, aqi_gleneden, aqi_patumahoe, aqi_takapuna, aqi_penrose, aqi_queenstreet),
  c("Henderson Lincoln South", "Sunnyhills East", "Glen Eden Central", "Puni", "Westlake", "Ellerslie South", "Queen Street"))

# Merge with main dataset 
merged_airdata <- airdata_with_sa2 |>
  left_join(aqi_combined, by = c("date" , "sa2_name")) 

# Take a glimpse
glimpse(merged_airdata)

# This pattern worked beautifully, so I reused it for other pollutants below.

# Free RAM
rm(aqi_combined, aqi_henderson, aqi_pakuranga, aqi_gleneden, aqi_patumahoe, aqi_takapuna, aqi_penrose, aqi_queenstreet, airdata_with_sa2)
gc() # Force garbage collection
```

## Add NO2, NO, PM10, PM2.5, and SO2 Pollutants
I followed the same ingestion-then-merge pattern for NO2, NO, PM10, PM2.5, and SO2, using the same function and structure. This standardization made it easy to debug and replicate.

```{r read-no2-of-sa2-then-bind-rows}
# Read Nitrogen Oxide (NO2) - Henderson
no2_henderson <- prepare_pollutant_data("data/henderson/no2-henderson/no2.csv", "NO2")

# Read Nitrogen Oxide (NO2) - Glen Eden
no2_gleneden <- prepare_pollutant_data("data/gleneden/no2-gleneden/no2.csv", "NO2")

# Read Nitrogen Oxide (NO2) - Patumahoe
no2_patumahoe <- prepare_pollutant_data("data/patumahoe/no2-patumahoe/no2.csv", "NO2")

# Read Nitrogen Oxide (NO2) - Takapuna
no2_takapuna <- prepare_pollutant_data("data/takapuna/no2-takapuna/no2.csv", "NO2")

# Read Nitrogen Oxide (NO2) - Penrose
no2_penrose <- prepare_pollutant_data("data/penrose/no2-penrose/no2.csv", "NO2")

# Read Nitrogen Oxide (NO2) - Queen Street
no2_queenstreet <- prepare_pollutant_data("data/queenstreet/no2-queenstreet/no2.csv", "NO2")

# Bind Rows of Nitrogen Dioxide (NO2)
no2_combined <- bind_pollutant_data(
  list(no2_henderson, no2_gleneden, no2_patumahoe, no2_takapuna, no2_penrose, no2_queenstreet),
  c("Henderson Lincoln South", "Glen Eden Central", "Puni", "Westlake", "Ellerslie South", "Queen Street"))

# Left join by matching rows where both date and sa2_name are same 
merged_airdata <- merged_airdata |>
  left_join(no2_combined, by = c("date", "sa2_name")) 

# Read Nitric Oxide (NO) - Henderson
no_henderson <- prepare_pollutant_data("data/henderson/no-henderson/no.csv", "NO")

# Read Nitric Oxide (NO) - Glen Eden
no_gleneden <- prepare_pollutant_data("data/gleneden/no-gleneden/no.csv", "NO")

# Read Nitric Oxide (NO) - Patumahoe
no_patumahoe <- prepare_pollutant_data("data/patumahoe/no-patumahoe/no.csv", "NO")

# Read Nitric Oxide (NO) - Takapuna
no_takapuna <- prepare_pollutant_data("data/takapuna/no-takapuna/no.csv", "NO")

# Read Nitric Oxide (NO) - Penrose
no_penrose <- prepare_pollutant_data("data/penrose/no-penrose/no.csv", "NO")

# Read Nitrogen Oxide (NO) - Queen Street
no_queenstreet <- prepare_pollutant_data("data/queenstreet/no-queenstreet/no.csv", "NO")

# Bind Rows of NO dataframes
no_combined <- bind_pollutant_data(
  list(no_henderson, no_gleneden, no_patumahoe, no_takapuna, no_penrose, no_queenstreet),
  c("Henderson Lincoln South", "Glen Eden Central", "Puni", "Westlake", "Ellerslie South", "Queen Street"))

no_combined <- bind_rows(`Henderson Lincoln South` = no_henderson, `Glen Eden Central` = no_gleneden, Puni = no_patumahoe, Westlake = no_takapuna, `Ellerslie South` = no_penrose, `Queen Street` = no_queenstreet, .id = "sa2_name")

# Left join by matching rows where both date and sa2_name are same 
merged_airdata <- merged_airdata |>
  left_join(no_combined, by = c("date", "sa2_name")) 

# Take a glimpse
glimpse(merged_airdata)

# Free RAM
rm(no_combined, no_henderson, no_gleneden, no_patumahoe, no_takapuna, no_penrose, no_queenstreet, no2_combined, no2_henderson, no2_gleneden, no2_patumahoe, no2_takapuna, no2_penrose, no2_queenstreet)
gc() # Force garbage collection
```

```{r load-pm10-data}
# Read Particulate Matter 10 (PM10) - Henderson
pm10_henderson <- prepare_pollutant_data("data/henderson/pm10-henderson/pm10.csv", "PM10")

# Read Particulate Matter 10 (PM10) - Pakuranga
pm10_pakuranga <- prepare_pollutant_data("data/pakuranga/pm10-pakuranga/pm10.csv", "PM10")

# Read Particulate Matter 10 (PM10) - Glen Eden
pm10_gleneden <- prepare_pollutant_data("data/gleneden/pm10-gleneden/pm10.csv", "PM10")

# Read Particulate Matter 10 (PM10) - Patumahoe
pm10_patumahoe <- prepare_pollutant_data("data/patumahoe/pm10-patumahoe/pm10.csv", "PM10")

# Read Particulate Matter 10 (PM10) - Takapuna
pm10_takapuna <- prepare_pollutant_data("data/takapuna/pm10-takapuna/pm10.csv", "PM10")

# Read Particulate Matter 10 (PM10) - Penrose
pm10_penrose <- prepare_pollutant_data("data/penrose/pm10-penrose/pm10.csv", "PM10")

pm10_queenstreet <- prepare_pollutant_data("data/queenstreet/pm10-queenstreet/pm10.csv", "PM10")

# Bind Rows of PM10 dataframes
pm10_combined <- bind_pollutant_data(
  list(pm10_henderson, pm10_pakuranga, pm10_gleneden, pm10_patumahoe, pm10_takapuna, pm10_penrose, pm10_queenstreet),
  c("Henderson Lincoln South", "Sunnyhills East", "Glen Eden Central", "Puni", "Westlake", "Ellerslie South", "Queen Street"))

# Left join ny matching rows where both date and sa2_name are same 
merged_airdata <- merged_airdata |>
  left_join(pm10_combined, by = c("date" = "date", "sa2_name" = "sa2_name")) 

# Take a glimpse
glimpse(merged_airdata)

# Free RAM
rm(pm10_combined, pm10_henderson, pm10_pakuranga, pm10_gleneden, pm10_patumahoe, pm10_takapuna, pm10_penrose, pm10_queenstreet)
gc() # Force garbage collection
```

```{r read-pm25-of-sa2-then-bind-rows}
# Read Particulate Matter 2.5 (PM2.5) - Patumahoe
pm2.5_patumahoe <- prepare_pollutant_data("data/patumahoe/pm2.5-patumahoe/pm2.5.csv", "PM2.5")

# Read Particulate Matter 2.5 (PM2.5) - Takapuna
pm2.5_takapuna <- prepare_pollutant_data("data/takapuna/pm2.5-takapuna/pm2.5.csv", "PM2.5")

# Read Particulate Matter 2.5 (PM2.5) - Penrose
pm2.5_penrose <- prepare_pollutant_data("data/penrose/pm2.5-penrose/pm2.5.csv", "PM2.5")

# Read Particulate Matter 2.5 (PM2.5) - Queen Street
pm2.5_queenstreet <- prepare_pollutant_data("data/queenstreet/pm2.5-queenstreet/pm2.5.csv", "PM2.5")

# Bind Rows of PM2.5 dataframes
pm2.5_combined <- bind_pollutant_data(
  list(pm2.5_patumahoe, pm2.5_takapuna, pm2.5_penrose, pm2.5_queenstreet),
  c("Puni", "Westlake", "Ellerslie South", "Queen Street"))

# Left join by matching rows where both date and sa2_name are same
merged_airdata <- merged_airdata |>
  left_join(pm2.5_combined, by = c("date" = "date", "sa2_name" = "sa2_name")) 

# Free RAM
rm(pm2.5_combined, pm2.5_patumahoe, pm2.5_takapuna, pm2.5_penrose, pm2.5_queenstreet)
gc() # Force garbage collection
```

```{r read-so2-for-sa2-then-bind-rows}
# Read Sulphur Dioxide (SO2) - Penrose
so2_penrose <- prepare_pollutant_data("data/penrose/so2-penrose/so2.csv", "SO2")

# Bind Rows of SO2
so2_combined <- bind_pollutant_data(
  list(so2_penrose),
  c("Ellerslie South"))

# Left join by matching rows where both date and sa2_name are same
merged_airdata <- merged_airdata |>
  left_join(so2_combined, by = c("date" = "date", "sa2_name" = "sa2_name"))

# Take a glimpse
glimpse(merged_airdata)

# Free RAM
rm(so2_combined, so2_penrose)
gc() # Force garbage collection
```

## Integrating Weather Data Across Auckland Monitoring Sites
To get a fuller picture of air quality, I combined air temperature, wind direction, wind speed, and relative humidity data from multiple Auckland locations. By using modular functions, I handled messy, inconsistent files and merged everything by date and area. This setup makes it easy to update or add new sites and keeps the workflow clean and reproducible for future analysis.

```{r read-and-bind-rows-of-air-temperature}
# Read Air Temperature - Henderson
airtemp_henderson <- prepare_pollutant_data("data/henderson/airtemp-henderson/airtemp.csv", "AirTemp")

# Read Air Temperature - Pakuranga
airtemp_pakuranga <- prepare_pollutant_data("data/pakuranga/airtemp-pakuranga/airtemp.csv", "AirTemp")

# Read Air Temperature - Glen Eden
airtemp_gleneden <- prepare_pollutant_data("data/gleneden/airtemp-gleneden/airtemp.csv", "AirTemp")

# Read Air Temperature - Takapuna
airtemp_takapuna <- prepare_pollutant_data("data/takapuna/airtemp-takapuna/airtemp.csv", "AirTemp")

# Read Air Temperature - Penrose
airtemp_penrose <- prepare_pollutant_data("data/penrose/airtemp-penrose/airtemp.csv", "AirTemp")

# Read Air Temperature - Queen Street
airtemp_queenstreet <- prepare_pollutant_data("data/queenstreet/airtemp-queenstreet/airtemp.csv", "AirTemp")

# Bind rows
airtemp_combined <- bind_pollutant_data(
  list(airtemp_henderson, airtemp_pakuranga, airtemp_gleneden, airtemp_takapuna, airtemp_penrose, airtemp_queenstreet),
  c("Henderson Lincoln South", "Sunnyhills East", "Glen Eden Central", "Westlake", "Ellerslie South", "Queen Street"))

# Left join by matching rows where both date and sa2_name are same 
merged_airdata <- merged_airdata |>
  left_join(airtemp_combined, by = c("date" = "date", "sa2_name" = "sa2_name")) 

# Take a glimpse
glimpse(merged_airdata)

# Free RAM
rm(airtemp_combined, airtemp_henderson, airtemp_pakuranga, airtemp_gleneden, airtemp_takapuna, airtemp_penrose, airtemp_queenstreet)
gc() # Force garbage collection
```

```{r read-and-bind-rows-of-wind-direction}
# Read Wind Direction - Henderson
winddir_henderson <- prepare_pollutant_data("data/henderson/winddir-henderson/winddir.csv", "WindDir")

# Read Wind Direction - Pakuranga
winddir_pakuranga <- prepare_pollutant_data("data/pakuranga/winddir-pakuranga/winddir.csv", "WindDir")

# Read Wind Direction - Glen Eden
winddir_gleneden <- prepare_pollutant_data("data/gleneden/winddir-gleneden/winddir.csv", "WindDir")

# Read Wind Direction - Takapuna
winddir_takapuna <- prepare_pollutant_data("data/takapuna/winddir-takapuna/winddir.csv", "WindDir")

# Read Wind Direction - Penrose
winddir_penrose <- prepare_pollutant_data("data/penrose/winddir-penrose/winddir.csv", "WindDir")

# Bind rows
winddir_combined <- bind_pollutant_data(
  list(winddir_henderson, winddir_pakuranga, winddir_gleneden, winddir_takapuna, winddir_penrose),
  c("Henderson Lincoln South", "Sunnyhills East", "Glen Eden Central", "Westlake", "Ellerslie South"))

# Left join by matching rows where both date and sa2_name are same 
merged_airdata <- merged_airdata |>
  left_join(winddir_combined, by = c("date" = "date", "sa2_name" = "sa2_name")) 

# Take a glimpse
glimpse(merged_airdata)

# Free RAM
rm(winddir_combined, winddir_henderson, winddir_pakuranga, winddir_gleneden, winddir_takapuna, winddir_penrose)
gc()
```

```{r read-and-bind-rows-of-wind-speed}
# Read Wind Speed - Henderson
windspeed_henderson <- prepare_pollutant_data("data/henderson/windspeed-henderson/windspeed.csv", "WindSpeed")

# Read Wind Speed - Pakuranga
windspeed_pakuranga <- prepare_pollutant_data("data/pakuranga/windspeed-pakuranga/windspeed.csv", "WindSpeed")

# Read Wind Speed - Glen Eden
windspeed_gleneden <- prepare_pollutant_data("data/gleneden/windspeed-gleneden/windspeed.csv", "WindSpeed")

# Read Wind Speed - Takapuna
windspeed_takapuna <- prepare_pollutant_data("data/takapuna/windspeed-takapuna/windspeed.csv", "WindSpeed")

# Read Wind Speed - Penrose
windspeed_penrose <- prepare_pollutant_data("data/penrose/windspeed-penrose/windspeed.csv", "WindSpeed")

# Bind rows
windspeed_combined <- bind_pollutant_data(
  list(windspeed_henderson, windspeed_pakuranga, windspeed_gleneden, windspeed_takapuna, windspeed_penrose),
  c("Henderson Lincoln South", "Sunnyhills East", "Glen Eden Central", "Westlake", "Ellerslie South"))

# Left join by matching rows where both date and sa2_name are same 
merged_airdata <- merged_airdata |>
  left_join(windspeed_combined, by = c("date" = "date", "sa2_name" = "sa2_name")) 

# Take a glimpse
glimpse(merged_airdata)

# Free RAM
rm(windspeed_combined, windspeed_henderson, windspeed_pakuranga, windspeed_gleneden, windspeed_takapuna, windspeed_penrose)
gc() # Force garbage collection
```

```{r read-relative-humidity-of-sa2-name-then-bind-rows}
# Read Relative Humidity Index - Henderson
relhum_henderson <- prepare_pollutant_data("data/henderson/relhum-henderson/relhum.csv", "RelHum")

# Read Relative Humidity - Pakuranga
relhum_pakuranga <- prepare_pollutant_data("data/pakuranga/relhum-pakuranga/relhum.csv", "RelHum")

# Read Relative Humidity - Glen Eden
relhum_gleneden <- prepare_pollutant_data("data/gleneden/relhum-gleneden/relhum.csv", "RelHum")

# Read Relative Humidity - Takapuna
relhum_takapuna <- prepare_pollutant_data("data/takapuna/relhum-takapuna/relhum.csv", "RelHum")

# Read Relative Humidity - Penrose
relhum_penrose <- prepare_pollutant_data("data/penrose/relhum-penrose/relhum.csv", "RelHum")

# Bind rows
relhum_combined <- bind_pollutant_data(
  list(relhum_henderson, relhum_pakuranga, relhum_gleneden, relhum_takapuna, relhum_penrose),
  c("Henderson Lincoln South", "Sunnyhills East", "Glen Eden Central", "Westlake", "Ellerslie South"))

# Merge with main dataset 
merged_airdata <- merged_airdata |>
  left_join(relhum_combined, by = c("date" , "sa2_name")) 

# Take a glimpse
glimpse(merged_airdata)

# Free RAM
rm(relhum_combined, relhum_henderson, relhum_pakuranga, relhum_gleneden, relhum_takapuna, relhum_penrose)
gc() # Force garbage collection
```

## Why This Design?
This modular workflow allowed me to:
* Avoid code duplication via reusable functions
* Handle inconsistent CSV file structures
* Systematically enrich my dataset with spatial and temporal pollutant information
* Ensure reproducibility and future-proofing: I can now add new sites with just one line per site

This strategy also aligns with tidy data principles and simplifies downstream tasks like merging with meteorological or traffic datasets. All joins were relational (on date + sa2_name), as required by the rubric.

## What I Learned
* Having messy, mislabelled, and duplicated files is the norm in real-world environmental data.

* Building small, well-named functions (like prepare_pollutant_data()) saves time in the long run.

* Commenting, consistent chunk naming, and incremental glimpse() checks helped debug merges fast.
</details>

# Exploring Weather and Air Quality Relationships Across Auckland Sites
Here, we use correlation heatmaps to uncover how weather and pollution variables interact at various Auckland monitoring sites. Strong links emerge between nitrogen oxides (NO and NO2) and sulfur dioxide, while temperature and wind patterns show clear influences on pollution levels. Smart imputation fills data gaps, helping us see consistent trends across urban and suburban locations like Ellerslie South and Queen Street.

<details><summary>Read more...</summary>

## Correlation Heatmaps by Site
This section visualizes the relationships between weather and air quality variables across Auckland sites. Correlation heatmaps are generated to identify pollutant interdependencies and meteorological influences.

```{r correlation-heatmap-for-all-data}
plot_heatmap <- function(data, title_var) {
  correlation_data <- data |>
  group_modify(~ {
  df <- .x  # Assign the subset data frame
  if (nrow(na.omit(df)) >= 2) { 
    corr_matrix <- cor(df, use = "complete.obs")
    corr_long <- as.data.frame(as.table(corr_matrix))
    names(corr_long) <- c("Var1", "Var2", "Correlation")
    corr_long
  } else {
    tibble(Var1 = character(), Var2 = character(), Correlation = numeric())
  }
}) |>
  ungroup()

# Plot the correlation heatmap
p <- ggplot(correlation_data, aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile() + #color = "white") +
  geom_text(aes(label = round(Correlation, 2)), size = 5) +
  scale_fill_viridis_c(
    option = "mako",  
    limits = c(-1, 1),
    name = "Pearson r"
  ) +
  theme_bw() +
  labs(
    title = "Correlation Matrix of Daily Weather and Air Quality Variables (2016–2024)",
    subtitle = paste("For ", title_var, " in Auckland"),
    x = NULL, y = NULL, fill = "Pearson r"
  ) +
  theme(
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 13, hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 12, face = "bold")
  )
return(p)
}
```

```{r plot-correlation-ellerslie-data}
# Find which factor has all missing values
merged_airdata |>
  group_by(sa2_name) |>
  select(RelHum, WindSpeed, WindDir, AirTemp, AQI, NO2, NO, PM10, PM2.5, SO2) |>
  summarise(across(everything(), ~ all(is.na(.x))),
            .groups = "drop")
# Ellerslie South has numeric data for all variables
# Glen Eden Central and Henderson Lincoln South has all data missing for PM2.5 and SO2
# Puni has all data missing for RelHum, WindSpeed, WindDir, AirTemp, and SO2
# Queen Street does not contain data for RelHum, WindSpeed, WindDir, and SO2
# Sunnyhills East has all data missing for NO2, NO, PM2.5, SO2
# Westlake has all data missing for SO2

ellerslie_data <- merged_airdata |>
  filter(sa2_name == "Ellerslie South") |>
  select(RelHum, WindSpeed, WindDir, AirTemp, AQI, NO2, NO, PM10, PM2.5, SO2)

# Display plot
plot_heatmap(ellerslie_data, "Ellerslie South site")

# Summary Insight
paste(" NO and NO2 show strong correlations, especially with SO2, while AirTemp and WindSpeed exhibit weaker or negative links. These patterns highlight complex meteorological influences on local air pollution dynamics. ")
```

```{r kalman-impute-corr-heatmap-ellerslie}
# View the number of missing values in key columns
ellerslie_data |>
  summarise(across(c(RelHum, WindSpeed, WindDir, AirTemp, AQI, NO2, NO, PM10, PM2.5, SO2), ~sum(is.na(.))))

# Impute missing values using Kalman smoothing (auto ARIMA model)
# This method handles time-series gaps more intelligently than simple methods
ellerslie_data <- ellerslie_data |> 
  mutate(
    RelHum = na_kalman(RelHum, model = "auto.arima"),
    WindSpeed = na_kalman(WindSpeed, model = "auto.arima"),
    WindDir = na_kalman(WindDir, model = "auto.arima"),
    AirTemp = na_kalman(AirTemp, model = "auto.arima"),
    AQI = na_kalman(AQI, model = "auto.arima"),
    NO2 = na_kalman(NO2, model = "auto.arima"),
    NO = na_kalman(NO, model = "auto.arima"),
    PM10 = na_kalman(PM10, model = "auto.arima"),
    PM2.5 = na_kalman(PM2.5, model = "auto.arima"),
    SO2 = na_kalman(SO2, model = "auto.arima"))

# Plot a heatmap of correlations after imputing missing values
plot_heatmap(ellerslie_data, "ARIMA approximated missing values at Ellerslie South site")

# Summary Insight
paste(" Air quality insights! SO2, NO, and NO2 are buddies, suggesting common sources. PM2.5 strongly tracks PM10 and NO. Interestingly, wind speed helps clear most pollutants, while air temp has complex, varied impacts. RelHum and PM2.5? No connection! ")
```

## Pollution Puzzles Across Auckland: What Heatmaps Reveal About Air Quality and Weather
Explore site-specific correlation heatmaps across Auckland, uncovering how pollutants like NO, NO2, PMs, and AQI relate to weather factors. From Glen Eden to Westlake, discover unique local dynamics shaping air quality from 2016–2024.

```{r correlation-heatmaps-multisite-airquality-weather}
# Select the required columns
gleneden_data <- merged_airdata |>
  filter(sa2_name == "Glen Eden Central") |>
  select(RelHum, WindSpeed, WindDir, AirTemp, AQI, NO2, NO, PM10)

# View the number of missing values in key columns
gleneden_data |>
  summarise(across(c(RelHum, WindSpeed, WindDir, AirTemp, AQI, NO2, NO, PM10), ~sum(is.na(.))))

# Plot a heatmap of correlations
plot_heatmap(gleneden_data, "Glen Eden Central site")

# Summary Insight
paste(" NO2 and NO are highly correlated, often from shared sources. Meanwhile, wind speed helps clear NO and NO2, indicating good dispersion. Air temperature has a weak, negative link to pollution, showing indirect influence. Notably, RelHum strongly correlates with NO2! ")

# Select the columns required
henderson_data <- merged_airdata |>
  filter(sa2_name == "Henderson Lincoln South") |>
  select(RelHum, WindSpeed, WindDir, AirTemp, AQI, NO2, NO, PM10)

# View the number of missing values in key columns
henderson_data |>
  summarise(across(c(RelHum, WindSpeed, WindDir, AirTemp, AQI, NO2, NO, PM10), ~sum(is.na(.))))

# Plot a heatmap of correlations
plot_heatmap(henderson_data, "Henderson Lincoln South site")

# Summary Insight
paste(" Insights from Henderson Lincoln South (2016-2024)! NO and NO2 are tightly linked (0.81), likely from shared sources. Wind speed helps disperse them, while AirTemp shows a slight negative correlation. PM10 boosts AQI (0.73). Interestingly, RelHum negatively correlates with both PM10 and AQI. ")

# Select the required columns
puni_data <- merged_airdata |>
  filter(sa2_name == "Puni") |>
  select(AQI, NO2, NO, PM10, PM2.5)

# View the number of missing values in key columns
puni_data |>
  summarise(across(c(AQI, NO2, NO, PM10, PM2.5), ~sum(is.na(.))))

# Plot a heatmap of correlations
plot_heatmap(puni_data, "Puni site")

# Summary Insight
paste(" NO and NO2 show the strongest correlation (0.57), indicating linked emissions. PM10 and NO2 exhibit the weakest negative correlation (-0.11). AQI weakly correlates with other pollutants, suggesting multifactorial influences. The matrix highlights variability in pollutant interactions over time and site conditions. ")

# Select the required columns
queen_data <- merged_airdata |>
  filter(sa2_name == "Queen Street") |>
  select(AirTemp, AQI, NO2, NO, PM10, PM2.5)

# View the number of missing values in key columns
queen_data |>
  summarise(across(c(AirTemp, AQI, NO2, NO, PM10, PM2.5), ~sum(is.na(.))))

# Plot a heatmap of correlations 
plot_heatmap(queen_data, "Queen Street site")

# Summary Insight
paste(" The correlation matrix shows strong positive correlations between NO and NO2 (0.86) and between PM2.5 and PM10 (0.85). AirTemp has a moderate negative correlation with NO2 (-0.33), suggesting temperature influences nitrogen dioxide concentrations. ")

# Select required columns
sunnyhills_data <- merged_airdata |>
  filter(sa2_name == "Sunnyhills East") |>
  select(RelHum, WindSpeed, WindDir, AirTemp, AQI, PM10)

# View the number of missing values in key columns
sunnyhills_data |>
  summarise(across(c(RelHum, WindSpeed, WindDir, AirTemp, AQI, PM10), ~sum(is.na(.))))

# Plot a heatmap of correlations
plot_heatmap(sunnyhills_data, "Sunnyhills East site")

# Summary Insight
paste(" Wind dynamics! WindSpeed and WindDir show a moderate positive link (0.48), meaning speed often increases with direction changes. PM10 and AQI are also moderately connected (0.51). AirTemp has weak ties to other factors, while RelHum and WindSpeed show a moderate negative correlation. ")

# Select the required columns
westlake_data <- merged_airdata |>
  filter(sa2_name == "Westlake") |>
  select(RelHum, WindSpeed, WindDir, AirTemp, AQI, NO2, NO, PM10, PM2.5)

# Plot a heatmap of correlations
plot_heatmap(westlake_data, "Westlake site")

# Summary Insight
paste(" NO and NO2 are closely linked (0.76), pointing to shared sources. WindSpeed helps disperse them. PM2.5 and AQI show a moderate connection (0.39). WindDir impacts NO2 transport (0.45). AirTemp negatively affects NO/NO2. RelHum is mixed, negative with WindSpeed but positive with others. ")
```
</details>

# Temporal Trends in Daily Pollutant Concentrations Across Auckland (2016–2024)
This section examines daily air pollutant patterns at multiple Auckland sites over eight years. Missing data were estimated using ARIMA and median imputation to ensure completeness. Visualizations reveal site-specific temporal changes and trends in AQI, NO2, NO, PM10, PM2.5, and SO2, highlighting pollution dynamics and notable declines or increases at key locations.

<details><summary>Read more...</summary>

```{r group-by-location-and-date-compute-sum}
# Find approximate values for missing ones, fill the missing values with ARIMA approximated values.
daily_airdata <- merged_airdata |>
  group_by(sa2_name) |>
  group_modify(~ {
    data <- .
    
    # Apply ARIMA imputation only if the entire column is not all NA
    data$RelHum <- if (all(is.na(data$RelHum))) data$RelHum else na_kalman(data$RelHum, model = "auto.arima")
    data$WindSpeed <- if (all(is.na(data$WindSpeed))) data$WindSpeed else na_kalman(data$WindSpeed, model = "auto.arima")
    data$WindDir <- if (all(is.na(data$WindDir))) data$WindDir else na_kalman(data$WindDir, model = "auto.arima")
    data$AirTemp <- if (all(is.na(data$AirTemp))) data$AirTemp else na_kalman(data$AirTemp, model = "auto.arima")
    data$AQI  <- if (all(is.na(data$AQI)))  data$AQI  else na_kalman(data$AQI, model = "auto.arima")
    data$NO2   <- if (all(is.na(data$NO2)))  data$NO2 else na_kalman(data$NO2, model = "auto.arima")
    data$NO   <- if (all(is.na(data$NO)))  data$NO else na_kalman(data$NO, model = "auto.arima")
    data$PM10 <- if (all(is.na(data$PM10))) data$PM10 else na_kalman(data$PM10, model = "auto.arima")
    data$PM2.5 <- if (all(is.na(data$PM2.5))) data$PM2.5 else na_kalman(data$PM2.5, model = "auto.arima")
    data$SO2 <- if (all(is.na(data$SO2))) data$SO2 else na_kalman(data$SO2, model = "auto.arima")
    
    return(data)
  }) |>
  ungroup()
         
# Produce a daily_airdata dataset that contains daily total pollutant concentrations and AQI for each SA2_name
daily_airdata <- daily_airdata |>
  group_by(sa2_name, date) |>
  mutate(
    NO2 = sum(NO2, na.rm = TRUE),
    NO = sum(NO, na.rm = TRUE),
    PM10 = sum(PM10, na.rm = TRUE),
    PM2.5 = sum(PM2.5, na.rm = TRUE),
    SO2 = sum(SO2, na.rm = TRUE),
    AQI = sum(AQI, na.rm = TRUE)) |> 
  ungroup()

colnames(daily_airdata)
```

```{r pollutant-trends}
# Function to plot pollutants versus date for each sa2_name
plot_pollutant <- function(data, yvar) {
  ggplot(data = data, aes(x = date, y = .data[[yvar]])) +
    geom_col(aes(fill = color_group)) +
    stat_cor(
      method = "pearson", size = 4,
      label.x.npc = "center", label.y.npc = "top") +
    facet_wrap(~ sa2_name, scales = "free") +
    scale_fill_identity(
      name = paste(yvar, "Level"),
      guide = "legend",
      labels = c("Low", "Moderate", "High"),
      breaks = c("#377eb8", "#A0AEB2", "#E24A33")
    ) +
    scale_x_date(
      breaks = seq(as.Date("2016-01-01"), as.Date("2024-12-31"), by = "6 months"),
      date_labels = "%b %y") +
    theme_bw() +
    labs(
      title = paste("Daily Trend of", yvar, "at Each Site in Auckland (2016–2024)"),
      subtitle = "Missing values are approximate by ARIMA method",
      x = "Month Year", 
      y = paste(yvar, " Concentration (µg/m³)")) +
    theme(
      plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 11, face = "bold"),
      strip.text = element_text(size = 11, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1, face = "bold")
    ) 
}
```

## Auckland Air Quality Trends: Spotting Highs, Lows, and Changes Over Time
Dive into daily air pollution patterns across Auckland from 2016 to 2024. This colorful look uses percentile bands to highlight extreme highs and lows, revealing how key pollutants rise and fall at different sites over time.

```{r plot-daily-pollutant-trends-by-percentiles}
# Calculate 10th and 90th percentiles
quantiles <- quantile(daily_airdata$AQI, probs = c(0.1, 0.9), na.rm = TRUE)

# Add color grouping based on AQI percentiles
daily_airdata <- daily_airdata |>
  mutate(color_group = case_when(
    AQI <= quantiles[1] ~ "#377eb8",
    AQI >= quantiles[2] ~ "#E24A33",
    TRUE ~ "#A0AEB2"
  ))

# Display plot
plot_pollutant(daily_airdata, "AQI") +
  labs(y = "AQI")

# Summary Insight
paste(" Queen Street shows the strongest AQI decline (R = –0.35), indicating worsening air quality. Puni and Sunnyhills East have frequent extreme spikes with moderate declines. Henderson Lincoln South, Westlake, and Ellerslie South show smaller but significant decreases. Glen Eden Central exhibit weak, significant positive trend. AQI trends vary notably across Auckland sites. ")

# Calculate 10th and 90th percentiles
quantiles <- quantile(daily_airdata$NO2, probs = c(0.1, 0.9), na.rm = TRUE)

# Add color grouping based on NO2 percentiles
daily_airdata <- daily_airdata |>
  mutate(color_group = case_when(
    NO2 <= quantiles[1] ~ "#377eb8",
    NO2 >= quantiles[2] ~ "#E24A33",
    TRUE ~ "#A0AEB2"
  ))

# Display plot
plot_pollutant(filter(daily_airdata, sa2_name != "Sunnyhills East"), "NO2")

# Summary Insight
paste(" Queen Street had consistently high NO2, but it's dropping fast (R=-0.38)! Westlake and Ellerslie South also saw good declines. Henderson Lincoln South has lower, stable levels. Glen Eden Central and Puni are lowest, with Puni showing slight, stable increases. Progress! ")

# Calculate 10th and 90th percentiles
quantiles <- quantile(daily_airdata$NO, probs = c(0.1, 0.9), na.rm = TRUE)

# Add color grouping based on NO percentiles
daily_airdata <- daily_airdata |>
  mutate(color_group = case_when(
    NO <= quantiles[1] ~ "#377eb8",
    NO >= quantiles[2] ~ "#E24A33",
    TRUE ~ "#A0AEB2"
  ))

# Display plot
plot_pollutant(filter(daily_airdata, sa2_name != "Sunnyhills East"), "NO")

# Summary Insight
paste(" NO levels varied notably across sites. Queen Street showed frequent high NO levels, while Henderson Lincoln South recorded predominantly moderate and low levels. Ellerslie South and Westlake had moderate NO with few high peaks. Notably, Puni and Glen Eden Central showed a positive trend, while others showed declining or fluctuating NO levels over time. ")

# Calculate 10th and 90th percentiles
quantiles <- quantile(daily_airdata$PM10, probs = c(0.1, 0.9), na.rm = TRUE)

# Add color grouping based on PM10 percentiles
daily_airdata <- daily_airdata |>
  mutate(color_group = case_when(
    PM10 <= quantiles[1] ~ "#377eb8",
    PM10 >= quantiles[2] ~ "#E24A33",
    TRUE ~ "#A0AEB2"
  ))

# Display plot
plot_pollutant(daily_airdata, "PM10")

# Summary Insight
paste(" PM10 levels vary across Auckland sites, with notable trends. Queen Street (R = 0.16) shows an increasing trend, while Henderson Lincoln South (R = -0.26) and Ellerslie South (R = -0.097) show declines. Puni (R = -0.064), Glen Eden Central (R = -0.099), and Ellerslie South (R = -0.097) show minor decreases. ")

# Calculate 10th and 90th percentiles
quantiles <- quantile(daily_airdata$PM2.5, probs = c(0.1, 0.9), na.rm = TRUE)

# Add color grouping based on PM2.5 percentiles
daily_airdata <- daily_airdata |>
  mutate(color_group = case_when(
    PM2.5 <= quantiles[1] ~ "#377eb8",
    PM2.5 >= quantiles[2] ~ "#E24A33",
    TRUE ~ "#A0AEB2"
  ))

# Display plot
plot_pollutant(filter(daily_airdata, !(sa2_name %in% c("Sunnyhills East", "Glen Eden Central", "Henderson Lincoln South"))), "PM2.5")

# Summary Insight
paste(" Queen Street and Puni shows a moderate positive trend over time (R = 0.12 and R = 0.11). Ellerslie South and Westlake experience frequent high levels, and shows moderate and weak trends. Statistical significance confirms clear differences across site-specific trends. ")

# Calculate 10th and 90th percentiles
quantiles <- quantile(daily_airdata$SO2, probs = c(0.1, 0.9), na.rm = TRUE)

# Add color grouping based on SO2 percentiles
daily_airdata <- daily_airdata |>
  mutate(color_group = case_when(
    SO2 <= quantiles[1] ~ "#377eb8",
    SO2 >= quantiles[2] ~ "#E24A33",
    TRUE ~ "#A0AEB2"
  ))

# Display plot
plot_pollutant(filter(daily_airdata, sa2_name == "Ellerslie South"), "SO2")

# Summary Insight
paste(" The graph presents daily SO2 levels at Ellerslie South, Auckland (2016–2024), highlighting ARIMA-estimated missing values and a weak negative correlation, emphasizing seasonal fluctuations and long-term variability in pollutant concentrations. ")
```
</details>

# Auckland's Air: Unpacking the Connections Between Pollution, AQI, and Temperature
Our analysis of Auckland's air quality from 2016-2024 reveals a complex interplay between pollutants, the Air Quality Index (AQI), and temperature. While higher pollutant concentrations generally worsen AQI, specific relationships vary by suburb. Colder temperatures often correlate with increased NO2 and NO, yet PM10 and PM2.5 show diverse responses across locations. These findings highlight the need for localized air quality strategies to address Auckland's unique pollution dynamics.

<details><summary>Read more...</summary>

## How Pollutants Influence Auckland’s Air Quality Index
Explore how NO2, NO, PM10, PM2.5, and SO2 levels relate to daily AQI across Auckland suburbs, revealing unique local trends and pollutant impacts from 2016 to 2024.

```{r plot-aqi-vs-pollutants-trends}
# Define a custom plotting function to examine the relationship between AQI and a selected pollutant
plot_aqi_vs_pollutants <- function(data, xvar) {
  ggplot(data = data, aes(x = .data[[xvar]], y = AQI)) +
    geom_point(aes(color = color_group)) + # Scatter plot colored by AQI categories
    geom_smooth(method = "gam", color = "#CC79A7", se = FALSE) + # Add smooth GAM trend line
    scale_color_identity(
      name = "AQI Level",  # Title for the legend
      guide = "legend", 
      labels = c("Low AQI", "High AQI", "Mid-range"), # Labels for color groups
      breaks = c("#377eb8", "#E24A33", "#A0AEB2") # Color codes matching the legend labels
    ) +
    scale_y_log10(labels = scales::scientific) + # Apply log scale to AQI 
    stat_cor(method = "pearson", size = 5) + # Display Pearson correlation coefficients
    facet_wrap(~ sa2_name, scales = "free") + # One panel per SA2 suburb with independent scales
    theme_bw() +
    labs(
      title = paste("Relationship Between Daily ", xvar, " Concentration and Air Quality Index (2016–2024)"),
      subtitle = "GAM smooth trend with Pearson correlation for each SA2 region",
      x = paste(xvar, " Concentration (µg/m³)"),
      y = "Air Quality Index (log scale)"
      ) +
    theme(
      plot.title = element_text(size = 13, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 11, hjust = 0.5),
      axis.title = element_text(size = 11, face = "bold"),
      axis.text = element_text(size = 11, face = "bold"),
      strip.text = element_text(size = 11, face = "bold")
      )
}

# Checks if NO2 data is available for Sunnyhills East (it's not)
daily_airdata |>
  filter(sa2_name == "Sunnyhills East") |>
  count(NO2)

# Calculate 10th and 90th percentiles
quantiles <- quantile(daily_airdata$AQI, probs = c(0.1, 0.9), na.rm = TRUE)

# Categorizes AQI into Low, Mid-range, and High using 10th and 90th percentiles
daily_airdata <- daily_airdata |>
  mutate(color_group = case_when(
    AQI <= quantiles[1] ~ "#377eb8",
    AQI >= quantiles[2] ~ "#E24A33",
    TRUE ~ "#A0AEB2"
  ))

# 1. AQI vs NO2 (excluding Sunnyhills East)
plot_aqi_vs_pollutants(
  filter(daily_airdata, sa2_name != "Sunnyhills East"), "NO2")

# Summary Insight
paste(" Queen Street's AQI is rising with NO2 (R=0.49)! Ellerslie South and Westlake echo this, but less intensely. Surprisingly, Puni, Henderson Lincoln South, and Glen Eden Central show slight AQI declines despite more NO2, with Puni's R=-0.048 suggesting a unique inverse trend. ")

# 2. AQI vs NO
plot_aqi_vs_pollutants(filter(daily_airdata, sa2_name != "Sunnyhills East"), "NO")

# Summary Insight
paste(" Queen Street shows the moderate positive correlation (R = 0.35), while Puni has a weak negative correlation (R = -0.049). Ellerslie South and Westlake also show notable trends (R = 0.14, 0.17). AQI categories highlight pollutant variability, with high AQI associated with elevated NO levels across sites. Henderson Lincoln South shows no clear correlation. ")

# 3. AQI vs PM10
plot_aqi_vs_pollutants(daily_airdata, "PM10")

# Summary Insight
paste(" PM10 concentration correlates moderately with AQI across regions, with R values between 0.22 and 0.41. The GAM trend lines indicate varying patterns, suggesting differences in pollution dynamics. High AQI levels align with increased PM10, while low AQI spans broader concentration ranges. Regional variations highlight distinct pollutant behaviors, emphasizing localized air quality influences and the need for tailored mitigation strategies. ")

# 4. AQI vs PM2.5 (excludes suburbs with no PM2.5 data)
plot_aqi_vs_pollutants(
  filter(daily_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East")), "PM2.5")

# Summary Insight
paste(" The GAM smooth trends show increasing PM2.5 concentrations with AQI across all regions, though with variations in slope. Correlation coefficients indicate weak to moderate positive associations (R = 0.18 to 0.34). Queen Street exhibit highest correlations. Categories reveal AQI levels predominantly in the low to mid range, with high AQI events infrequent yet impactful. ")

# 5. AQI vs SO2 (for Ellerslie South)
plot_aqi_vs_pollutants(filter(daily_airdata, sa2_name == "Ellerslie South"), "SO2")

# Summary Insight
paste(" SO2 concentration and AQI in Ellerslie South show a weak correlation (R = 0.059, p = 0.0016). High AQI events are rare, with most readings in low-to-mid categories. No strong temporal trend is evident. ")
```

## Air Temperature versus Pollutant Concentrations Across Auckland Suburbs
This section explores how daily air temperature influences pollutant concentrations (NO2, NO, PM10, PM2.5, SO2) across selected Auckland suburbs. Using GAM smoothing and correlation analysis, both raw and standardized data are examined to reveal regional trends and statistical relationships, highlighting the impact of temperature extremes on urban air quality from 2016 to 2024.

```{r define-plot-airtemp-vs-pollutants}
# Calculate 10th and 90th percentiles
quantiles <- quantile(daily_airdata$AirTemp, probs = c(0.1, 0.9), na.rm = TRUE)

# Categorizes air temperature into Low, Mid-range, and High using 10th and 90th percentiles
daily_airdata <- daily_airdata |>
  mutate(color_group = case_when(
    AirTemp <= quantiles[1] ~ "#377eb8",
    AirTemp >= quantiles[2] ~ "#E24A33",
    TRUE ~ "#A0AEB2"
  ))

# Define a custom plotting function to examine the relationship between air temperature and a selected pollutant
plot_airtemp_vs_pollutants <- function(data, yvar, stat_y) {
  ggplot(data = data, aes(x = AirTemp, y = .data[[yvar]])) +
    geom_point(aes(color = color_group)) + # Scatter plot colored by pollutant categories
    geom_smooth(method = "gam", color = "#CC79A7", se = FALSE) + # Add smooth GAM trend line
    scale_color_identity(
      name = "AirTemp Level",  # Title for the legend
      guide = "legend", 
      labels = c("Cold", "Warm", "Hot"), # Labels for color groups
      breaks = c("#377eb8", "#A0AEB2", "#E24A33") # Color codes matching the legend labels
    ) +
    scale_y_log10(labels = scales::scientific) + # Apply log scale to AQI 
   stat_cor(
     method = "pearson", size = 5,
     label.x.npc = "left", label.y.npc = stat_y) +
    facet_wrap(~ sa2_name, scales = "free") + # One panel per SA2 suburb with independent scales
    theme_bw() +
    labs(
      title = paste("Relationship Between Daily Air Temperature and ", yvar, " Concentration (2016–2024)"),
      subtitle = "GAM smooth trend with Pearson correlation for each SA2 region",
      x = "Air Temperature (°C)",
      y = paste(yvar, " Concentration (µg/m³)")
      ) +
    theme(
      plot.title = element_text(size = 13, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 11, hjust = 0.5),
      axis.title = element_text(size = 11, face = "bold"),
      axis.text = element_text(size = 11, face = "bold"),
      strip.text = element_text(size = 11, face = "bold"),
      legend.title = element_text(size = 11, face = "bold"),
      legend.text = element_text(size = 11, face = "bold")
      )
}
```

```{r standardize-airtemp-pollutants-and-aqi}
# View distinct values of AirTemp in each sa2_name
daily_airdata |>
  group_by(sa2_name) |>
  summarize(total_rows = n(), 
            missing_airtemp = sum(is.na(AirTemp)),
            .groups = "drop")
# Puni has all values missing, while others have partial missing data

# Filter out "Puni"
daily_airdata <- daily_airdata |>
  filter(sa2_name != "Puni") |>
  group_by(sa2_name) |>
  # Approximate missing AirTemp using ARIMA imputation
  mutate(AirTemp = na_kalman(AirTemp, model = "auto.arima")) |>
  ungroup()

# Check if missing values are all approximated
daily_airdata |>
  group_by(sa2_name) |>
  filter(is.na(AirTemp)) |> 
  ungroup()
# All missing AirTemp values are approximated

# Standardized air temperature, air pollutants, and AQI for each site
standardized_airdata <- daily_airdata |>
  group_by(sa2_name) |>
  mutate(
    AirTemp = (AirTemp - mean(AirTemp)) / sd(AirTemp),
    AQI = (AQI - mean(AQI)) / sd(AQI),
    NO2 = (NO2 - mean(NO2)) / sd(NO2),
    NO = (NO - mean(NO)) / sd(NO),
    PM10 = (PM10 - mean(PM10)) / sd(PM10),
    PM2.5 = (PM2.5 - mean(PM2.5)) / sd(PM2.5),
    SO2 = (SO2 - mean(SO2)) / sd(SO2)
    ) |>
  ungroup()

# View the selected column details
standardized_airdata |>
  select(AirTemp, AQI, NO2, NO, PM10, PM2.5, SO2) |>
  skim()
# All variables are approximately centered around zero, confirming successful standardization. The missing value counts are for the sites not having that pollutant. Histograms show skewness, with AQI and PM pollutants heavily right-skewed, and NO2 and SO2 slightly more dispersed.
```

## How Air Temperature Affects Auckland’s Air Quality
Explore how daily and standardized air temperature relate to AQI across key Auckland suburbs, revealing subtle cooling effects on pollution levels and occasional outlier spikes from local pollution events.

```{r plot-daily-and-zscore-airtemp-vs-aqi}
# Plot raw air temperature vs AQI for selected sites
plot_airtemp_vs_aqi <- plot_airtemp_vs_pollutants(
  filter(daily_airdata, sa2_name != "Puni"), "AQI", "top") +
  labs(y = "Air Quality Index (AQI)")

# Display plot
plot_airtemp_vs_aqi

# Summary Insight
paste("AQI declines with temperature significantly at Queen Street (R = -0.12), Ellerslie South (R = -0.085), and Glen Eden Central (R = -0.082), suggesting a weak negative trend. Westlake, Henderson Lincoln South, and Sunnyhills East shows non-significant correlation (p > 0.001), while other sites exhibit insignificant trends. Potential outliers may exist where AQI spikes unexpectedly, possibly due to local pollution events.")

# Plot standardized air temperature vs AQI standardized for selected sites
standardize_airtemp_vs_aqi <- plot_airtemp_vs_pollutants(filter(standardized_airdata, sa2_name != "Puni"), "AQI", "top") + 
  scale_y_continuous() + # Change to normal scale
  labs(
      title = "Relationship Between Daily Standardized Air Temperature and AQI Standardized (2016–2024)",
      x = "Standardized Air Temperature",
      y = "Standardized AQI")

# Display plot
standardize_airtemp_vs_aqi

# Summary Insight
paste("Standardized AQI data improves clarity but retains similar trends. Ellerslie South loses significance (p > 0.001). Queen Street, Glen Eden Central and Henderson Lincoln South have weak significant correlations. Sunnyhills East correlation remains insignificant. Possibilities of outliers at all the sites, likely due to pollution spikes. Temperature categories remain unchanged. Standardization highlights variability but doesn’t alter trends significantly.")
```

## NO2 vs Air Temperature
Visually check for correlation between raw air temperature and NO2 levels across sites. Explore whether NO2 concentrations vary consistently with air temperature. Assess whether standardizing air temperature and NO2 improves clarity of trends. Reduces distortion from temperature outliers for better pattern detection.

```{r plot-daily-and-zscore-airtemp-vs-no2}
# Checks if NO2 data is available for Sunnyhills East (it's not)
daily_airdata |>
  filter(sa2_name %in% c("Sunnyhills East")) |>
  count(NO2)

# Plot raw air temperature vs NO2 for selected sites
plot_airtemp_vs_no2 <- plot_airtemp_vs_pollutants(
  filter(daily_airdata, !sa2_name %in% c("Puni", "Sunnyhills East")), "NO2", "bottom")

# Display plot
plot_airtemp_vs_no2

# Summary Insight
paste("All regions show a negative correlation between air temperature and NO2, strongest in Ellerslie South (R = -0.28). Cold days (blue) generally have higher NO2. Queen Street shows more scatter, suggesting potential outliers. Nonlinear trends suggest other influencing factors, and hot days (red) consistently show lower concentrations. Outliers may exist at very low or high concentrations.")

# Plot standardized air temperature vs NO2 standardized for selected sites
standardize_airtemp_vs_no2 <- plot_airtemp_vs_pollutants(filter(standardized_airdata, sa2_name != "Sunnyhills East"), "NO2", "top") + 
  scale_y_continuous() + # Change to normal scale
  labs(
      title = "Relationship Between Daily Standardized Air Temperature and NO2 Standardized (2016–2024)",
      x = "Standardized Air Temperature",
      y = "Standardized NO2 Concentration")

# Display plot
standardize_airtemp_vs_no2

# Summary Insight
paste("The standardized graph refines trends by normalizing variables, highlighting clearer negative correlations between air temperature and NO2 levels across sites. While both graphs show high significance (p < 0.00001), the standardized version enhances visibility of minor variations. Outliers remain evident at extreme temperatures, suggesting local influences.")
```

## NO vs Air Temperature
Identify general pattern between raw air temperature and NO levels across sites. Check for outliers or nonlinear trends in NO vs temperature. Use standardized temperature and standardized NO levels to evaluate cleaner NO trends. Highlights central tendency while minimizing extreme value effects.

```{r plot-daily-and-zscore-airtemp-vs-no}
# Checks if NO data is available for Sunnyhills East (it's not)
daily_airdata |>
  filter(sa2_name %in% c("Sunnyhills East")) |>
  count(NO)

# Plot raw air temperature vs NO for selected sites
plot_airtemp_vs_no <- plot_airtemp_vs_pollutants(
  filter(daily_airdata, !sa2_name %in% c("Puni", "Sunnyhills East")), "NO", "bottom")

# Display plot
plot_airtemp_vs_no

# Summary Insight
paste("The graph shows that NO concentration generally decreases as temperature rises, except on Queen Street. Correlations range from -0.1 to -0.2, all statistically significant (p < 0.0001). Outliers appear at all sites, particularly at higher temperatures. Different sites exhibit distinct trends, suggesting environmental factors may influence NO levels.")

# Plot standardized air temperature vs NO standardized for selected sites
standardize_airtemp_vs_no <- plot_airtemp_vs_pollutants(filter(standardized_airdata, sa2_name != "Sunnyhills East"), "NO", "top") + 
  scale_y_continuous() + # Change to normal scale
  labs(
      title = "Relationship Between Daily Standardized Air Temperature and NO Standardized (2016–2024)",
      x = "Standardized Air Temperature",
      y = "Standardized NO Concentration")

# Display plot
standardize_airtemp_vs_no

# Summary Insight
paste("Standardization reveals clearer trends: NO concentration decreases more uniformly with temperature, strengthening correlations (-0.06 to -0.13). Significance remains unchanged, except Queen Street correlation is now non-significant. Category divisions (cold, warm, hot) show more distinct separation, reducing overlap. Outliers persist but are more identifiable at extreme temperatures and extreme NO concentration. The refined view emphasizes regional differences and environmental influences more effectively.")
```

## PM10 vs Air Temperature
Examine how PM10 concentrations change with raw temperature. Helps identify seasonal or heat-related pollution effects. Use standardized temperature and standard PM10 concentrations to clarify relationship. Removes noise from extreme temperature values to focus on main trend.

```{r plot-daily-zscore-airtemp-vs-pm10}
# Plot raw air temperature vs PM10 for selected sites
plot_airtemp_vs_pm10 <- plot_airtemp_vs_pollutants(
  filter(daily_airdata, sa2_name != "Puni"), "PM10", "top")

# Display plot
plot_airtemp_vs_pm10

# Summary Insight
paste("Ellerslie South and Westlake show no clear trend, with weak correlations and non-significant relationships. Glen Eden, Henderson Lincoln South, and Sunnyhills East show mild downward trends with significant negative correlations. Queen Street shows a weak, significant upward trend. Temperature-related PM10 effects vary by site, with some showing clear relationships while others remain inconclusive.")

# Plot standardized air temperature vs PM10 standardized for each site 
plot_standardized_airtemp_vs_pm10 <- plot_airtemp_vs_pollutants(standardized_airdata, "PM10", "top") +
  labs(
    title = paste("Relationship Between Daily Standardized Air Temperature and PM10 Concentration Standardized (2016–2024)"),
    x = "Standardized Air Temperature",
    y = "Standardized PM10")

# Display plot
plot_standardized_airtemp_vs_pm10

# Summary Insight
paste("Ellerslie South and Westlake show no clear trend, with weak correlations and no significance. Glen Eden Central shows weak upward trend with significant positive correlations. The rest of the sites exhibits weak non-significant upward and downward trends. Outliers are present at all sites, especially Queen Street and Sunnyhills East. Temperature categories influence PM10 differently across sites.")
```

## PM2.5 vs Air Temperature
Investigate PM2.5 variation with raw air temperature across selected sites. Detect possible temperature-dependent behavior of fine particulates. Compare standardized temperature effect on standardized PM2.5. Filter out extreme values to enhance trend visibility. Improves trend interpretation by reducing the impact of outliers in both variables.

```{r plot-daily-and-zscore-airtemp-vs-pm25}
# Plot raw air temperature vs PM2.5 (data available for 3 sites)
plot_airtemp_vs_pm2.5 <- plot_airtemp_vs_pollutants(
  filter(daily_airdata, sa2_name %in% c("Ellerslie South", "Queen Street", "Westlake")), "PM2.5", "bottom")

# Display plot
plot_airtemp_vs_pm2.5

# Summary Insight
paste(" Westlake shows the strongest negative correlation (-0.14), suggesting PM2.5 decreases as temperature rises. Ellerslie South follows (-0.093), while Queen Street’s correlation is weak and non-significant (0.052, p=0.014). Cold temperatures generally align with higher PM2.5 levels. Outliers, especially in Westlake, indicate extreme PM2.5 spikes at warm and hot temperatures, likely from localized emissions or meteorological influences. ")

# Plot standardized air temperature vs PM2.5 standardized
plot_standardized_airtemp_vs_pm2.5 <- plot_airtemp_vs_pollutants(filter(standardized_airdata, sa2_name %in% c("Ellerslie South", "Queen Street", "Westlake")), "PM2.5", "bottom") +
  labs(
    title = paste("Relationship Between Standardized Daily Air Temperature and Daily PM2.5 Concentration Standardized (2016–2024)"),
    x = "Standardized Air Temperature",
    y = "Standardized PM2.5")

# Display plot
plot_standardized_airtemp_vs_pm2.5

# Summary Insight
paste(" Air temperature and PM2.5 levels shows negative significant correlations at Ellerslie South and Westlake whereas Queen Street shows non-significant correlation. PM2.5 outliers might arise from local pollution spikes. Statistical significance depends on seasonal variation and source proximity. ")
```

## SO2 vs Air Temperature
Analyze SO2 variation with raw air temperature at Ellerslie (only site with SO2 data). Evaluate site-specific patterns in SO2 behavior with temperature. Repeat analysis using standardized temperature and standardized SO2. Improve visualization by reducing impact of temperature outliers.

```{r plot-daily-and-zscore-airtemp-vs-so2-ellerslie}
# Plot raw air temperature vs SO2 (SO2 data is available for Ellerslie site only)
airtemp_vs_so2 <- plot_airtemp_vs_pollutants(
  filter(daily_airdata, sa2_name == "Ellerslie South"), "SO2", "top") +
  labs(title = "", subtitle = "Raw Data") +
  theme(plot.subtitle = element_text(size = 12, hjust = 0, face = "bold"))

# Plot standardized air temperature vs SO2 standardized 
standardized_airtemp_vs_so2 <- plot_airtemp_vs_pollutants(filter(standardized_airdata, sa2_name == "Ellerslie South"), "SO2", "top") +
  labs(
    title = "", subtitle = "Standardized Data",
    x = "Standardized Air Temperature",
    y = "Standardized SO2") +
  theme(plot.subtitle = element_text(size = 12, hjust = 0, face = "bold"))

# Display plot
combined_airtemp_vs_so2 <- airtemp_vs_so2 + standardized_airtemp_vs_so2 +
  plot_layout(guides = "collect") + # Collect legend
  plot_annotation(
    title = "Relationship Between Daily Air Temperature and SO2 Concentration (2016–2024)",
    subtitle = "GAM smooth trend with Pearson correlation for each SA2 region",
    theme = theme(
      plot.title = element_text(size = 13, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 12, hjust = 0.5)
    ))

# Display plot
combined_airtemp_vs_so2

# Summary Insight
paste(" The standardized data plot shows a slightly stronger negative correlation between air temperature and SO2 concentration (R = -0.16, significant). The raw data data weakens this correlation (R = -0.13, significant). Cold days generally show higher SO2 levels, while warm and hot days show a downward trend. The GAM smooth confirms overall SO2 decrease with rising temperature. ")
```
</details>

# Understanding Auckland's Air: How Wind and Temperature Shape Our Breath (2016-2024)
Ever wonder how the weather impacts Auckland's air? We dove into years of data (2016-2024) to see how wind speed, direction, and temperature influence local air pollution. By exploring these meteorological factors across various monitoring sites, we're uncovering crucial links and patterns that help explain our city's air quality dynamics. Stay tuned to see how our weather shapes the air we breathe!

<details><summary>Read more...</summary>

```{r windspeed-scatter-by-site}
# Identify sites where WindSpeed is missing for all observations
daily_airdata |>
  group_by(sa2_name) |>
  filter(all(is.na(WindSpeed))) |>
  ungroup() |>
  count(sa2_name, WindSpeed)
# => Queen Street has no WindSpeed data and will be excluded from plotting

# Filter out Queen Street due to entirely missing WindSpeed data
daily_windspeed <- daily_airdata |>
  filter(sa2_name != "Queen Street")

# Create scatter plot of daily WindSpeed over time, faceted by site
plot_pts <- function(data, xvar) {
  p <- ggplot(data = data, aes(x = {{xvar}}, y = WindSpeed)) +
    geom_point(aes(color = site_type)) +
    stat_cor(
      method = "pearson", size = 5,
      label.x.npc = "left", label.y.npc = "top") +
    facet_wrap(~ sa2_name, scales = "free") +
    scale_color_viridis_d(option = "G") + 
    theme_bw() +
    labs(
      title = "Distribution of Daily Wind Speed vs. Date by Sites in Auckland (2016–2024)",
      subtitle = "Excludes Queen Street and Puni (all missing values)",
      x = "Date", y = "Wind Speed (m/s)", color = "Site Type") +
    theme(
      plot.title = element_text(size = 13, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 12, face = "bold"),
      legend.title = element_text(size = 12, face = "bold"),
      strip.text = element_text(size = 12, face = "bold"))
  return(p)
  }

# Display plot
plot_windspeed <- plot_pts(daily_windspeed, date)
plot_windspeed

# Summary Insight
paste(" Ellerslie South contains erroneous negative values, causing the plot to be diverted. Let's filter out the invalid wind speed values. ")
```

```{r plot-valid-wind-speed-vs-date}
# Display plot for valid WindSpeed values
plot_windspeed <- plot_pts(filter(daily_windspeed, WindSpeed >= 0) , date)

plot_windspeed

# Summary Insight
paste(" Wind speed trends from 2016–2024 vary by site in Auckland. Ellerslie South and Glen Eden Central show the strongest positive correlations with time (R = 0.15, 0.14), while Westlake shows no trend (R = –0.016, p = 0.39). Henderson and Westlake shows a shift in site type in 2023. ")
```

```{r plot-wind-speed-vs-wind-direction-site-type}
# Display plot for WindSpeed versus WindDir
plot_windspeed <- plot_pts(filter(daily_windspeed, WindSpeed >= 0), WindDir) +
  labs(
      title = "Distribution of Daily Wind Speed vs. Wind Direction by Site Types in Auckland (2016–2024)",
      x = "Wind Direction (°)") 

plot_windspeed

# Summary Insight
paste(" Wind speed shows varying correlations with wind direction across site types. Sunnyhills East exhibits the strongest positive relationship (R = 0.37), while Westlake shows a weak negative one (R = −0.11). Henderson Lincoln South displays no significant association. ")
```

```{r display-plot-for-WindSpeed-vs-AirTemp}
# Display plot for WindSpeed versus AirTemp
plot_windspeed <- plot_pts(daily_windspeed, AirTemp) +
  labs(
      title = "Distribution of Daily Wind Speed vs. Air Temperature by Site Types in Auckland (2016–2024)",
      x = "Air Temperature (°C)") 

plot_windspeed

# Summary Insight
paste(" Ellerslie South contains large negative invalid wind speed values and Sunnyhills East has large negative air temperature value of below -50 degree celsius. These values are causing the plot to be diverted towards them. Let's remove them. ")
```

```{r display-plot-for-WindSpeed-vs-AirTemp-for-valid-values}
# Display plot for WindSpeed versus AirTemp
plot_windspeed <- plot_pts(filter(daily_windspeed, WindSpeed >= 0 & AirTemp >= -5), AirTemp) +
  labs(
      title = "Distribution of Daily Wind Speed vs. Air Temperature by Site Types in Auckland (2016–2024)",
      x = "Air Temperature (°C)") 

plot_windspeed

# Free RAM
rm(daily_windspeed)
gc() # Force garbage collection

# Summary Insight
paste(" The strongest positive correlation between wind speed and air temperature is seen at Ellerslie South (R = 0.55), followed by Glen Eden Central (R = 0.48) and Westlake (R = 0.37). Henderson Lincoln South (R = 0.21) and Sunnyhills East (R = 0.14) show weaker correlations. Warmer temperatures tend to align with higher wind speeds across all sites, but the relationship is notably weaker in more suburban residential areas like Sunnyhills. Industrial sites like Ellerslie exhibit stronger associations, possibly reflecting localized urban heat and turbulence effects. ")
```

## Wind speed effects on pollutants in Auckland suburbs

```{r standardised-factor-values-daily-airdata}
# Select daily values of variables by sa2_name and site_type
daily_airdata <- merged_airdata |>
  select(date, sa2_name, site_type, AQI, NO2, NO, PM10, PM2.5, SO2, WindSpeed, WindDir, AirTemp, RelHum) 

# Form long form of daily_airdata
daily_airdata_long <- daily_airdata |>
  pivot_longer(
    cols = c(AQI, NO2, NO, PM10, PM2.5, SO2, WindSpeed, WindDir, AirTemp, RelHum),
    names_to = "factor", values_to = "value")

# Check if any date are repeating (none)
daily_airdata_long |>
  count(date, sa2_name, site_type, factor) |>
  filter(n > 1)

# Convert site_type to a factor with correct levels
  daily_airdata <- daily_airdata |>
  mutate(site_type = factor(site_type, levels = unique(daily_airdata$site_type)))

# Group by sa2_name and site_type, compute mean, sd, and z_score
standardized_airdata <- daily_airdata_long |>
  group_by(factor) |>
  mutate(
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE)) |>
  ungroup() |>
  mutate(value = ((value - mean) / sd))

# Remove mean and sd columns
standardized_airdata <- standardized_airdata |>
  select(-mean, -sd)

# Form pivot_wider of standardized_airdata
standardized_airdata <- standardized_airdata |>
  pivot_wider(names_from = factor,
              values_from = value)

# View colnames
colnames(standardized_airdata)
```

```{r define-plot-wind-speed-vs-pollutants}
plot_windspeed_vs_pollutants <- function(data, yvar, stat_var) {
  # Calculate 10th and 90th percentiles of WindSpeed 
  quantiles <- quantile(data$WindSpeed, probs = c(0.1, 0.9), na.rm = TRUE)
  
  # Categorizes wind speed into Low, Mid, and High using 10-90th percentiles
  data <- data |>
    mutate(color_group = case_when(
      WindSpeed <= quantiles[1] ~ "#377eb8",
      WindSpeed >= quantiles[2] ~ "#E24A33",
      TRUE ~ "#A0AEB2"
      ))
  
  # Define a custom plotting function to examine the relationship between wind speed and a selected pollutant
  p <- ggplot(data = data, aes(x = WindSpeed, y = .data[[yvar]])) +
    geom_point(aes(color = color_group)) + # points colored by pollutant categories
    geom_smooth(method = "gam", color = "#CC79A7", se = FALSE) + # Add smooth GAM trend line
    scale_color_identity(
      name = "WindSpeed Level",  # Title for the legend
      guide = "legend", 
      labels = c("Low", "Medium", "High"), # Labels for color groups
      breaks = c("#377eb8", "#A0AEB2", "#E24A33") # Color codes matching the legend labels
    ) +
    scale_y_log10(labels = scales::scientific) +
    stat_cor(
      method = "pearson", size = 5,
      label.x.npc = "left", label.y.npc = stat_var) +
    facet_wrap(~ sa2_name, scales = "free") + # One panel per SA2 suburb with independent scales
    theme_bw() +
    labs(
      title = paste("Relationship Between Daily Wind Speed and ", yvar, " Concentration in Auckland (2016–2024)"),
      subtitle = "GAM smooth trend with Pearson correlation for each Site",
      x = "Wind Speed (m/s)", y = paste(yvar, " concentration (µg/m³)")
      ) +
    theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      legend.title = element_text(size = 12, face = "bold"),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 11, face = "bold"),
      strip.text = element_text(size = 12, face = "bold")
      )
  return(p)
}
```

## AQI vs Wind Speed
Visually check for correlation between raw and standardized wind speed and air quality index (AQI) levels across sites. Explore whether AQI vary consistently with wind speed. Assess whether standardizing wind speed and AQI improves clarity of trends. Reduces distortion from wind speed outliers for better pattern detection.

```{r plot-windspeed-vs-aqi-for-all-sites}
# Plot raw wind speed vs AQI, "Puni" and "Queen Street" does not contain numeric wind speed values 
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_windspeed_vs_aqi <- plot_windspeed_vs_pollutants(data, "AQI", "top") +
  labs(y = "Air Quality Index (AQI)")

# Display plot
plot_windspeed_vs_aqi

# Summary Insight
paste(" This plot includes invalid negative WindSpeed values at Ellerslie South, which may obscure meaningful patterns. Filtering for valid WindSpeed values will help reveal clearer and more accurate trends. ")
```

```{r restrict-windspeed-vs-aqi-for-valid-windspeed}
# Limit the WindSpeed values of at least 0m/s
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")) & WindSpeed >= 0)

plot_windspeed_vs_aqi <- plot_windspeed_vs_pollutants(data, "AQI", "top") +
  labs(
    title = "Relationship Between Restricted Daily Wind Speed and AQI Concentration at sites in Auckland (2016–2024)",
    x = "Positive Wind Speed Values (m/s)",
    y = "Air Quality Index (AQI)")

plot_windspeed_vs_aqi
```

Trends vary by site, Sunnyhills East shows moderate positive correlation, while others exhibit no relationships due to local influences.

```{r plot-z-anomalies-of-windspeed-vs-aqi}
# Plot standardized wind speed vs AQI standardized
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_windspeed_vs_aqi <- plot_windspeed_vs_pollutants(data, "AQI", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardised Daily Wind Speed and AQI Concentration at sites in Auckland (2016–2024)",
    x = "Standardized Wind Speed", 
    y = "Standardized Air Quality Index (AQI)")

# Display plot
plot_windspeed_vs_aqi

# Summary Insight
paste(" Large negative z values are diverting the plot towards them, let's restrict the z values from -3 to 3. ")
```

```{r plot-restricted-z-anomalies-of-windspeed-vs-aqi}
# Plot standardized wind speed vs AQI standardized
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")) & WindSpeed >= -3 & WindSpeed <= 3 & AQI >= -3 & AQI <= 3)

plot_windspeed_vs_aqi <- plot_windspeed_vs_pollutants(data, "AQI", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardised Daily Wind Speed and AQI Concentration at sites in Auckland (2016–2024)",
    x = "Standardized Wind Speed (-3 to 3)", 
    y = "Standardized Air Quality Index (AQI) (-3 to 3)")

# Display plot
plot_windspeed_vs_aqi
```
Sunnyhills East and Henderson Lincoln South shows significant positive correlation between wind speed and AQI, suggesting significant pollutant dispersion. The rest of the sites exhibits a weak non-significant positive correlation, indicating no wind influence.

## NO vs Wind Speed
Visually check for correlation between raw and standardized wind speed and NO across sites. Explore whether NO vary consistently with wind speed. Assess whether standardizing wind speed and NO improves clarity of trends. Reduces distortion from wind speed outliers for better pattern detection.

```{r display-plot-for-valid-windspeed-vs-no}
# Display plot, remove "Sunnyhills East", it does not have NO values, remove the WindSpeed values below 0
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")) & WindSpeed >= 0)

plot_windspeed_vs_no <- plot_windspeed_vs_pollutants(data, "NO", "top")

plot_windspeed_vs_no
```

NO concentrations decrease as wind speed increases across all sites, with Westlake showing the strongest negative correlation (R = -0.56). High wind speeds correspond to lower NO levels (red points). Trends are consistent, but strength varies, likely due to site-specific meteorological influences.

```{r plot-for-z-anomalies-of-windspeed-vs-no}
# Display plot, remove "Sunnyhills East", it does not have NO values
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")))

plot_windspeed_vs_no <- plot_windspeed_vs_pollutants(data, "NO", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardised Daily Wind Speed and NO Concentration at sites in Auckland (2016–2024)",
    x = "Standardized Wind Speed", 
    y = "Standardized Nitric Oxide (NO)")

plot_windspeed_vs_no
```

Large z values are diverting the plot towards them, let's restrict the z values to -3 to 3.

```{r plot-restricted-z-anomalies-of-windspeed-vs-no}
# Display plot, remove "Sunnyhills East", it does not have NO values
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")) & WindSpeed >= -3 & WindSpeed <= 3 & NO >= -3 & NO <= 3)

plot_windspeed_vs_no <- plot_windspeed_vs_pollutants(data, "NO", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardised Daily Wind Speed and NO Concentration at sites in Auckland (2016–2024)",
    x = "Standardized Wind Speed (-3 to 3)", 
    y = "Standardized Nitric Oxide (NO, -3 to 3)")

plot_windspeed_vs_no
```

NO concentration negatively correlates with wind speed at all sites (R = -0.41 to -0.52, p < 2.2e-16). Higher wind speeds (red) reduce NO levels, while low winds (blue) increase concentration. Glen Eden and Westlake show the strongest correlations, indicating wind-driven pollutant dispersion patterns.

## NO2 versus WindSpeed

```{r display-plot-for-valid-windspeed-vs-no2}
# Display plot, remove "Sunnyhills East", it does not have NO2 values, remove the WindSpeed values below 0
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")) & WindSpeed >= 0)

plot_windspeed_vs_no2 <- plot_windspeed_vs_pollutants(data, "NO2", "top")

plot_windspeed_vs_no2
```

Wind speed negatively correlates with NO2 levels—higher speeds lead to lower concentrations. Correlation strength varies across sites (R values), with differing statistical significance (p-values). Some sites show a stronger inverse relationship, indicating localized meteorological influences on NO2 dispersion and accumulation.

```{r plot-z-anomalies-of-windspeed-vs-no2}
# Display plot, remove "Sunnyhills East", it does not have NO2 values
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")), WindSpeed >= -3 & WindSpeed <= 3 & NO2 >= -3 & NO2 <= 3)

plot_windspeed_vs_no2 <- plot_windspeed_vs_pollutants(data, "NO2", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardised Daily Wind Speed and NO Concentration at sites in Auckland (2016–2024)",
    x = "Standardized Wind Speed (-3 to 3)", 
    y = "Standardized Nitrogen Dioxide (NO2, -3 to 3)")

plot_windspeed_vs_no2
```

Significant NO2 concentration positively correlates with wind speed (R = 0.62 and 0.47). Higher wind speeds (red) increase NO2 levels, while low winds (blue) decrease concentration. Ellerslie South and Westlake show the strongest correlations, indicating wind-driven pollutant dispersion patterns.

## PM10 versus WindSpeed

```{r display-plot-for-valid-windspeed-vs-PM10}
# Display plot, remove "Puni" and "Queen Street", they don't have PM10 values, remove the WindSpeed values below 0
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")) & WindSpeed >= 0)

plot_windspeed_vs_pm10 <- plot_windspeed_vs_pollutants(data, "PM10", "top")

plot_windspeed_vs_pm10
```

PM10 levels rise with wind speed across sites, strongest at Ellerslie South (R = 0.19). Low wind (blue) shows stable PM10, while high wind (red) increases PM10, likely due to dust resuspension. Henderson Lincoln South has the weakest significant correlation (R = 0.077).

```{r plot-z-anomalies-of-windspeed-vs-PM10}
# Display plot, remove "Puni" and "Queen Street", they don't have PM10 values
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_windspeed_vs_pm10 <- plot_windspeed_vs_pollutants(data, "PM10", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardised Daily Wind Speed and PM10 Concentration at sites in Auckland (2016–2024)",
    x = "Standardized Wind Speed", 
    y = "Standardized Particulate Matter (PM10)")

plot_windspeed_vs_pm10
```

Restrict the z values to -3 to 3 to avoid plot diversion.

```{r plot-restricted-z-anomalies-of-windspeed-vs-PM10}
# Display plot, remove "Puni" and "Queen Street", they don't have PM10 values, restrict z anomaly from -3 to 3
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")) & WindSpeed >= -3 & WindSpeed <= 3 & PM10 >= -3 & PM10 <= 3)

plot_windspeed_vs_pm10 <- plot_windspeed_vs_pollutants(data, "PM10", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardised Daily Wind Speed and PM10 Concentration at sites in Auckland (2016–2024)",
    x = "Standardized Wind Speed (-3 to 3)", 
    y = "Standardized Particulate Matter (PM10, -3 to 3)")

plot_windspeed_vs_pm10
```

This plot shows a weak positive correlation between standardized wind speed and PM10 concentration across five Auckland sites, indicated by low R-values. The "Low" wind speed category often shows higher PM10 variability, while "Medium" and "High" levels tend to be more consistent.

## PM2.5 versus WindSpeed

```{r display-plot-for-windspeed-vs-PM25}
# Display plot, select "Ellerslie South" and "Westlake", they have numeric WindSpeed and PM2.5 values, remove the WindSpeed values below 0
data <- filter(daily_airdata, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_windspeed_vs_pollutants(data, "PM2.5", "top")

# Summary Insight
paste("The invalid large negative windspeed values are diverting the whole plot towards them, let's plot for valid wind speed.")

# Display plot, select "Ellerslie South" and "Westlake", they have numeric WindSpeed and PM2.5 values, remove the WindSpeed values below 0
data <- filter(daily_airdata, sa2_name %in% c("Ellerslie South", "Westlake") & WindSpeed >=0)

plot_windspeed_vs_pm25 <- plot_windspeed_vs_pollutants(data, "PM2.5", "top")

plot_windspeed_vs_pm25

# Summary Insight
paste(" Ellerslie South shows a slight negative correlation with PM2.5 decreasing as wind speed increases, then rising at higher speeds. Westlake exhibits a weak positive correlation, with PM2.5 concentrations generally increasing with wind speed, particularly at lower speeds, then stabilizing. Both sites show low wind speeds associated with higher PM2.5. ")

# Display plot, select "Ellerslie South" and "Westlake", they have numeric WindSpeed and PM2.5 values, remove the WindSpeed values below 0
data <- filter(standardized_airdata, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_windspeed_pm25_1 <- plot_windspeed_vs_pollutants(data, "PM2.5", "top") +
  scale_y_continuous() +
  labs(
    title = "", subtitle = "Z-anomaly",
    x = "Standardized Wind Speed", y = "Standardized PM2.5")

# Large negative and positive z anomalies are diverting the whole plot towards them. Restrict z anomalies to -3 to 3
data <- filter(standardized_airdata, sa2_name %in% c("Ellerslie South", "Westlake") & WindSpeed >= -3 & WindSpeed <= 3 & PM2.5 >= -3 & PM2.5 <= 3)

plot_windspeed_pm25_2 <- plot_windspeed_vs_pollutants(data, "PM2.5", "top") +
  scale_y_continuous() +
  labs(
    title = "", subtitle = "Z-anomaly (-3 to 3)",
    x = "Standardized Wind Speed (-3 to 3)", 
    y = "Standardized PM2.5 (-3 to 3)")

plot_windspeed_pm25_1 / plot_windspeed_pm25_2 +
  plot_layout(guides = "collect") + # Collect legend
  plot_annotation(
    title = "Relationship Between Standardised Daily Wind Speed and PM2.5 Concentration at sites in Auckland (2016–2024)",
    subtitle = "GAM smooth trend with Pearson correlation for each site",
    theme = theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Ellerslie South shows a curvilinear negative correlation between wind speed and PM2.5, while Westlake has a positive, more linear correlation. Wind speed levels (Low, Medium, High) are distributed across the standardized wind speed ranges at both sites. ")
```

## SO2 versus WindSpeed

```{r display-plot-for-valid-windspeed-vs-SO2}
# Display plot, select "Ellerslie South", it is the only site recording SO2 values, remove the WindSpeed values below 0
data <- filter(daily_airdata, sa2_name == "Ellerslie South")
plot_windspeed_vs_SO2_1 <- plot_windspeed_vs_pollutants(data, "SO2", "top") +
  scale_y_continuous() +
  labs(title = "", subtitle = "All values")

data <- filter(daily_airdata, sa2_name == "Ellerslie South" & WindSpeed >=0)
plot_windspeed_vs_SO2_2 <- plot_windspeed_vs_pollutants(data, "SO2", "top") + 
  scale_y_continuous() +
  labs(
    title = "", subtitle = "Restricted", x = "WindSpeed >= 0 (m/s)")

# Large negative and positive z anomalies are diverting the whole plot towards them. Restrict z anomalies to -3 to 3
data <- filter(standardized_airdata, sa2_name == "Ellerslie South")
plot_standardized_1 <- plot_windspeed_vs_pollutants(data, "SO2", "top") +
  scale_y_continuous() +
  labs(
    title = "", subtitle = "Z-anomaly",
    x = "Standardized Wind Speed", y = "Standardized SO2")

data <- filter(standardized_airdata, sa2_name == "Ellerslie South" & WindSpeed >= -3 & WindSpeed <= 3 & SO2 >= -3 & SO2 <= 3)
plot_standardized_2 <- plot_windspeed_vs_pollutants(data, "SO2", "top") + 
  scale_y_continuous() +
  labs(
    title = "", subtitle = "Z-anomaly (-3 to 3)",
    x = "Standardized Wind Speed (-3 to 3)", 
    y = "Standardized SO2 (-3 to 3)")

(plot_windspeed_vs_SO2_1 + plot_windspeed_vs_SO2_2) / (plot_standardized_1 + plot_standardized_2) + 
  plot_layout(guides = "collect") + # Collect legends
  plot_annotation(
    title = "Relationship Between Raw and Standardised Daily Wind Speed and SO2 Concentration at sites in Auckland (2016–2024)",
    subtitle = "GAM smooth trend with Pearson correlation for each site",
    theme = theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste("This plot shows an inverse relationship between wind speed and SO2 concentration. Restricting the data and using standardized values improves the linear correlation, revealing clear categories (low, medium, high) based on wind speed levels.")
```

## Wind Speed vs Relative Humidity
Visually check for correlation between raw and standardized wind speed and relative humidity (RelHum) levels across sites. Explore whether RelHum vary consistently with wind speed. Assess whether standardizing wind speed and RelHum improves clarity of trends. Reduces distortion from wind speed outliers for better pattern detection.

```{r plot-windspeed-vs-relhum-for-all-sites}
# Plot raw wind speed vs RelHum, "Puni" and "Queen Street" does not contain numeric WindSpeed and RelHum values 
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_windspeed_vs_relhum <- plot_windspeed_vs_pollutants(data, "RelHum", "bottom") +
  scale_x_continuous() +
  scale_y_continuous() +
  labs(y = "Relative Humidity (RelHum, %)")

# Display plot
plot_windspeed_vs_relhum

# Summary Insight
paste(" These plots reveal varied relationships between wind speed and relative humidity across Auckland. Some sites show inverse or weak correlations (Ellerslie South, Glen Eden Central, Westlake), while others (Henderson Lincoln South, Sunnyhills East) exhibit more complex or subtle trends, with wind speed levels influencing humidity differently. ")
```

```{r restrict-windspeed-vs-relhum-for-valid-values}
# Limit the WindSpeed values of at least 0m/s
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")) & WindSpeed >= 0)

plot_windspeed_vs_relhum <- plot_windspeed_vs_pollutants(data, "RelHum", "bottom") +
  scale_x_continuous() +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Restricted Daily Wind Speed and RelHum at sites in Auckland (2016–2024)",
    x = "Positive Wind Speed Values (m/s)",
    y = "Relative Humidity (%)")

plot_windspeed_vs_relhum

# Summary Insight
paste(" These plots show varied relationships between wind speed and humidity across Auckland sites. Henderson Lincoln South, show a positive correlation, while Sunnyhills East, exhibit a negative trend, and some have no significant relationship, highlighting site-specific atmospheric dynamics. ")
```

```{r plot-z-anomalies-of-windspeed-vs-relhum}
# Plot standardized wind speed vs RelHum standardized
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_windspeed_vs_relhum <- plot_windspeed_vs_pollutants(data, "RelHum", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardised Daily Wind Speed and Relative Humidity at sites in Auckland (2016–2024)",
    x = "Standardized Wind Speed", 
    y = "Standardized Relative Humidity (RelHum)")

# Display plot
plot_windspeed_vs_relhum

# Summary Insight
paste(" Large negative z values are diverting the plot towards them, let's restrict the z values from -3 to 3. ")
```

```{r plot-restricted-z-anomalies-of-windspeed-vs-relhum}
# Plot standardized wind speed vs RelHum standardized
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")) & WindSpeed >= -3 & WindSpeed <= 3 & RelHum >= -3 & RelHum <= 3)

plot_windspeed_vs_relhum <- plot_windspeed_vs_pollutants(data, "RelHum", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardised Daily Wind Speed and Relative Humidity at sites in Auckland (2016–2024)",
    x = "Standardized Wind Speed (-3 to 3)", 
    y = "Standardized Relative Humidity (-3 to 3)")

# Display plot
plot_windspeed_vs_relhum

# Summary Insight
paste(" These plots reveal varying wind speed and relative humidity relationships across Auckland sites. Some show inverse correlations, while others have weaker links, highlighting diverse microclimates. ")
```
</details>

# Navigating Auckland's Air: The Wind's Influence on Pollution
Ever noticed how Auckland's air quality changes with the wind? We're diving deep into years of data (2016-2024) to unravel how different wind directions impact various pollutants like AQI, NO, NO2, PM10, PM2.5, and SO2 across our city's monitoring sites. From industrial zones to residential areas, understanding these wind-driven patterns is crucial for breathing easier. Let's explore the invisible currents shaping our air.

<details><summary>Read more...</summary>

## Building Reusable Functions to Explore Wind Direction and Air Pollutant Relationships
This section defines modular plotting functions to analyze how wind direction influences pollutant levels across Auckland, with options to stratify by wind thresholds or site type for deeper insight.

```{r define-function-to-plot-wind-direction-vs-pollutants}
plot_winddir_vs_pollutants <- function(data, yvar, stat_var) {
  # Calculate 10th and 90th percentiles of WindDir 
  quantiles <- quantile(data$WindDir, probs = c(0.1, 0.9), na.rm = TRUE)
  
  # Categorizes wind direction into Low, Mid, and High using 10-90th percentiles
  data <- data |>
    mutate(color_group = case_when(
      WindDir <= quantiles[1] ~ "#377eb8",
      WindDir >= quantiles[2] ~ "#E24A33",
      TRUE ~ "#A0AEB2"
      ))
  
  # Define a custom plotting function to examine the relationship between wind direction and a selected pollutant
  ggplot(data = data, aes(x = WindDir, y = .data[[yvar]])) +
    geom_point(aes(color = color_group), size = 2) + # points colored by pollutant categories
    geom_smooth(method = "gam", color = "#CC79A7", se = FALSE) + # Add smooth GAM trend line
    scale_color_identity(
      name = "WindDir Level",  # Title for the legend
      guide = "legend", 
      labels = c("Low", "Medium", "High"), # Labels for color groups
      breaks = c("#377eb8", "#A0AEB2", "#E24A33") # Color codes matching the legend labels
    ) +
    scale_y_log10(labels = scales::scientific) +
    stat_cor(
      method = "pearson", size = 5,
      label.x.npc = "left", label.y.npc = stat_var) +
    facet_wrap(~ sa2_name, scales = "free") + # One panel per SA2 suburb with independent scales
    theme_bw() +
    labs(
      title = paste("Relationship Between Daily Wind Direction and ", yvar, " Concentration in Auckland (2016–2024)"),
      subtitle = "GAM smooth trend with Pearson correlation for each Site",
      x = "Wind Direction (degrees)", y = paste(yvar, " concentration (µg/m³)")
      ) +
    theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 13, hjust = 0.5),
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 11, face = "bold"),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 11, face = "bold"),
      strip.text = element_text(size = 12, face = "bold")
      )
}
```

```{r winddir-vs-pollutants-by-sitetype}
# Function to plot wind direction vs pollutants, categorized by site type
plot_winddir_pollutants_site <- function(data, yvar, stat_var) {
  # Plot wind direction versus AQI categorized by site_type
  ggplot(data = data, aes(x = WindDir, y = .data[[yvar]])) +
    geom_point(aes(color = site_type), size = 2, alpha = 0.6) + 
    geom_smooth(method = "gam", color = "#CC79A7", se = FALSE) +
    scale_color_viridis_d(option = "G") +
    scale_y_log10(labels = scales::scientific) +
    stat_cor(
      method = "pearson", size = 5,
      label.x.npc = "left", label.y.npc = stat_var) +
    facet_wrap(~ sa2_name, scales = "free") +
    theme_bw() +
    labs(
      title = paste("Relationship Between Daily Wind Direction and ", yvar, " in Auckland Categorized by Site Type (2016–2024)"),
      subtitle = "GAM smooth trend with Pearson correlation for each Site",
      x = "Wind Direction (degrees)", y = paste(yvar, " concentration (µg/m³)"), color = "Site Type") +
    theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 13, hjust = 0.5),
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 11, face = "bold"),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 11, face = "bold"),
      strip.text = element_text(size = 12, face = "bold")
      )
}
```

## AQI vs WindDir
Visually check for correlation between raw wind direction and AQI levels across sites. Explore whether AQI vary consistently with wind direction. Assess whether standardizing wind direction and AQI improves clarity of trends. Reduces distortion from wind direction outliers for better pattern detection.

```{r plot-winddir-vs-aqi}
# Plot raw wind direction vs AQI for selected sites, "Puni" and "Queen Street" does not contain any numeric WindDir values
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_winddir_vs_aqi <- plot_winddir_vs_pollutants(
  data, "AQI", "top") +
  labs(y = "Air Quality Index (AQI)")

# Display plot
plot_winddir_vs_aqi

# Summary Insight
paste(" Glen Eden Central and Henderson Lincoln South show stronger correlations between wind direction and AQI (R = 0.5, 0.35), while Sunnyhills East has the weakest (R = 0.16). Medium wind levels generally exhibit more pronounced trends, suggesting site-specific meteorological influences on air pollution dispersion. ")
```

```{r plot-z-anomalies-of-winddir-vs-aqi}
# Plot standardized wind direction vs AQI for selected sites, "Puni" and "Queen Street" does not contain any numeric WindDir values
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_standardized <- plot_winddir_vs_pollutants(
  data, "AQI", "top") +
  labs(
    title = "Relationship Between Standardized Daily Wind Speed and AQI at sites in Auckland (2016–2024)",
    x = "Standardized Wind Direction",
    y = "Standardized Air Quality Index (AQI)")

# Display plot
plot_standardized

# Summary Insight
paste(" Wind direction shows minimal correlation with AQI across all sites. Most Pearson R values are near zero, indicating no relationship. Wind direction categories display no clear trend. Statistical significance is absent (p > 0.1), suggesting AQI is largely independent of wind variability. ")
```

```{r plot-winddir-vs-aqi-by-sitetype}
# Plot raw wind direction vs AQI for selected sites, "Puni" and "Queen Street" does not contain any numeric WindDir values
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_winddir_aqi_site <- plot_winddir_pollutants_site(
  data, "AQI", "top") +
  labs(y = "Air Quality Index (AQI)")

# Display plot
plot_winddir_aqi_site

# Summary Insight
paste("Wind direction shows no consistent AQI trend across sites. AQI variability across sites remains independent of wind direction levels, suggesting meteorological factors play a minor role in site-specific air quality.")
```

## NO versus Wind Direction Across Auckland Sites
We examine how raw NO levels vary by wind direction at key Auckland sites, revealing site-specific pollution patterns influenced by local wind dynamics and pollutant dispersion mechanisms.

```{r plot-winddir-vs-NO}
# Plot raw wind direction vs NO for selected sites, "Puni" and "Queen Street" does not contain WindDir, "Sunnyhills East" does not contain NO
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")))

plot_winddir_vs_no <- plot_winddir_vs_pollutants(
  data, "NO", "top")

# Display plot
plot_winddir_vs_no

# Summary Insight
paste(" NO concentrations vary significantly by site and wind direction. Westlake and Ellerslie South show positive correlations, peaking with high winds. Henderson Lincoln South trends negatively, while Glen Eden Central is weakly negative. Wind intensity strongly influences NO levels across sites, shaping pollutant dispersion dynamics. ")
```

```{r plot-z-anomalies-of-no-vs-winddir}
# Plot standardized NO vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir values, "Sunnyhills East" does not contain NO
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")))

plot_standardized <- plot_winddir_vs_pollutants(
  data, "NO", "top") +
  scale_y_continuous() + 
  labs(
    title = "Relationship Between Standardized Daily Wind Direction and NO at sites in Auckland (2016–2024)",
    x = "Standardized Wind Direction",
    y = "Standardized NO")

# Display plot
plot_standardized

# Summary Insight
paste("Pollutant correlations with wind direction are weak across sites, with p-values suggesting no statistical significance at Ellerslie South and Glen Eden Central. Trend patterns are mostly flat, indicating minimal directional effects. Westlake shows the highest correlation (R = 0.14). Categories show no clear separation.")
```

```{r plot-winddir-vs-no-by-sitetype}
# Plot raw wind direction vs NO for selected sites, "Puni" and "Queen Street" does not contain WindDir, "Sunnyhills East" contains no NO
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")))

plot_winddir_no_site <- plot_winddir_pollutants_site(
  data, "NO", "top") +
  labs(y = "Nitric Oxide (NO, (µg/m³)")

# Display plot
plot_winddir_no_site

# Summary Insight
paste("Ellerslie South & Westlake show a strong positive correlation, indicating NO levels increase with specific wind directions due to pollutant transport. Glen Eden Central exhibits a weak correlation, suggesting localized emissions are the primary driver. Henderson Lincoln South presents a negative correlation, where dilution reduces NO concentrations under certain wind patterns.")
```

## Relationship Between NO2 Concentrations and Wind Direction Across Auckland Sites
This section explores how nitrogen dioxide (NO2) levels relate to wind direction across multiple Auckland monitoring sites. It includes raw, standardized, and restricted z-score plots to reveal site-specific pollutant transport patterns influenced by wind, especially in industrial and traffic-heavy areas.

```{r plot-no2-vs-winddir}
# Plot raw NO2 vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir, "Sunnyhills East" does not contain NO2
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")))

plot_no2_vs_winddir <- plot_winddir_vs_pollutants(
  data, "NO2", "bottom")

# Display plot
plot_no2_vs_winddir

# Summary Insight
paste(" Westlake and Ellerslie show positive NO2-wind direction correlations, strongest at Westlake. Glen Eden and Henderson exhibit weaker negative correlations. GAM smoothing highlights distinct regional pollutant transport patterns across sites. ") 
```

```{r plot-z-anomalies-of-no2-vs-winddir}
# Plot standardized NO2 vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir values, "Sunnyhills East" does not contain NO2
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")))

plot_standardized <- plot_winddir_vs_pollutants(
  data, "NO2", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardized Daily Wind Direction and NO2 at sites in Auckland (2016–2024)",
    x = "Standardized Wind Direction",
    y = "Standardized NO2")

# Display plot
plot_standardized

# Summary Insight
paste(" Westlake shows the strongest positive correlation (R = 0.43), while Glen Eden Central and Henderson Lincoln South shows weak negative correlation (R = -0.13). Wind direction impacts NO2 levels differently across sites. ") 
```

```{r plot-restricted-z-anomalies-of-no2-vs-winddir}
# Plot restricted standardized NO2 vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir values, "Sunnyhills East" does not contain NO2
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")) & NO2 >= -3 & NO2 <= 3)

plot_standardized <- plot_winddir_vs_pollutants(
  data, "NO2", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Restricted Standardized Daily Wind Direction and NO2 at sites in Auckland (2016–2024)",
    x = "Standardized Wind Direction",
    y = "Standardized NO2 (-3 to 3)")

# Display plot
plot_standardized

# Summary Insight
paste(" Ellerslie South and Westlake show positive correlations, while Glen Eden Central and Henderson Lincoln South show negative correlations between standardized wind direction and NO2 levels. There has been a slight improvement in correlations. ") 
```

```{r plot-no2-vs-winddir-by-sitetype}
# Plot raw NO2 vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir, "Sunnyhills East" contains no NO2
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East")))

plot_winddir_no2_site <- plot_winddir_pollutants_site(
  data, "NO2", "bottom") +
  labs(y = "Nitrogen Dioxide (NO2, (µg/m³)")

# Display plot
plot_winddir_no2_site

# Summary Insight
paste(" NO2 levels vary by site type and wind patterns. Industrial areas show strong increases, traffic sites moderate rises, while residential zones exhibit weaker trends due to dispersion. Wind-driven pollutant transport is evident. ") 
```

## How Wind Direction Shapes Daily PM10 Pollution in Auckland
Exploring how wind direction impacts daily PM10 pollution across Auckland, filtering and standardizing data to reveal patterns, reduce outlier effects, and compare pollution trends between industrial and residential sites.

```{r plot-pm10-vs-winddir}
# Plot raw PM10 vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_pm10_vs_winddir <- plot_winddir_vs_pollutants(
  data, "PM10", "top")

# Display plot
plot_pm10_vs_winddir

# Summary Insight
paste(" Ellerslie South and Westlake show stronger correlations (R = 0.18, 0.14) between wind direction and PM10 concentration, while Glen Eden Central, Henderson Lincoln South, and Sunnyhills East show weaker correlations (R = 0.077, 0.049, 0.072). ")
```

```{r plot-z-anomalies-of-pm10-vs-winddir}
# Plot standardized PM10 vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir values
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_standardized <- plot_winddir_vs_pollutants(
  data, "PM10", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Standardized Daily Wind Direction and PM10 at sites in Auckland (2016–2024)",
    x = "Standardized Wind Direction",
    y = "Standardized PM10")

# Display plot
plot_standardized

# Summary Insight
paste(" Ellerslie South shows the highest correlation (R = 0.18), while Sunnyhills East shows the lowest (R = 0.06). PM10 levels increase with high wind direction across all sites. There are some very large z anomalies like in Westlake causing the relationship to be weak.  ")
```

```{r plot-restricted-z-anomalies-of-pm10-vs-winddir}
# Plot restricted standardized PM10 vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir values
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")) & PM10 <= 3)

plot_standardized <- plot_winddir_vs_pollutants(
  data, "PM10", "top") +
  scale_y_continuous() +
  labs(
    title = "Relationship Between Restricted Standardized Daily Wind Direction and PM10 at sites in Auckland (2016–2024)",
    x = "Standardized Wind Direction",
    y = "Standardized PM10 (<= 3)")

# Display plot
plot_standardized

# Summary Insight
paste(" There is very slight increase in correlations. ")
```

```{r plot-pm10-vs-winddir-by-sitetype}
# Plot raw PM10 vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_winddir_pm10_site <- plot_winddir_pollutants_site(
  data, "PM10", "top") +
  labs(y = "Particulate Matter (PM10, (µg/m³)")

# Display plot
plot_winddir_pm10_site

# Summary Insight
paste("Industrial sites show higher PM10 correlations with wind direction than residential sites. Trend consistency varies by site type.")
```

## Uncovering PM2.5 Patterns by Wind Direction
We explore how wind direction affects PM2.5 at Ellerslie South and Westlake using raw and standardized data. GAM plots reveal weak but significant site-specific trends in air pollution patterns.

```{r plot-pm2.5-vs-winddir}
# Plot raw PM2.5 vs wind direction for selected sites, "Puni" and "Queen Street" does not contain WindDir. "Ellerslie South" and "Westlake" only contains PM2.5
data <- filter(daily_airdata, (sa2_name %in% c("Ellerslie South", "Westlake")))

plot_pm25_vs_winddir <- plot_winddir_vs_pollutants(
  data, "PM2.5", "bottom") +
  labs(title = "", subtitle = "Categorized by 10-90% Percentiles")

# Plot raw PM2.5 vs wind direction for selected sites
data <- filter(daily_airdata, (sa2_name %in% c("Ellerslie South", "Westlake")))

plot_winddir_pm25_site <- plot_winddir_pollutants_site(
  data, "PM2.5", "bottom") +
  labs(title = "", subtitle = "Categorized by Site Type")

# Display plot
plot_pm25_vs_winddir / plot_winddir_pm25_site +
  plot_layout(guides = "collect") + # Collect legend
  plot_annotation(
    title = "Relationship Between Daily Wind Direction and PM2.5 Concentration at sites in Auckland (2016–2024)",
    subtitle = "GAM smooth trend with Pearson correlation for each site",
    theme = theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" PM2.5 rises with wind direction at Ellerslie South but dips at 100° in Westlake. Categories: WindDir Level (Low, Medium, High) and Site Type (Residential, Industrial, Traffic). Pearson correlations are weak but significant.  ")

# Plot z-anomalies, select "Ellerslie South" and "Westlake", they have numeric WindDir and PM2.5 values
data <- filter(standardized_airdata, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_winddir_pm25_1 <- plot_winddir_vs_pollutants(data, "PM2.5", "top") +
  scale_y_continuous() +
  labs(
    title = "", subtitle = "Z-anomaly",
    x = "Standardized Wind Direction", y = "Standardized PM2.5")

# Plot z-anomalies, restricted to <= 3
data <- filter(standardized_airdata, sa2_name %in% c("Ellerslie South", "Westlake") & PM2.5 <= 3)

plot_winddir_pm25_2 <- plot_winddir_vs_pollutants(data, "PM2.5", "top") +
  scale_y_continuous() +
  labs(
    title = "", subtitle = "Z-anomaly (<= 3)",
    x = "Standardized Wind Direction", 
    y = "Standardized PM2.5 (<= 3)")

plot_winddir_pm25_1 / plot_winddir_pm25_2 +
  plot_layout(guides = "collect") + # Collect legend
  plot_annotation(
    title = "Relationship Between Standardised Daily Wind Direction and PM2.5 Concentration at sites in Auckland (2016–2024)",
    subtitle = "GAM smooth trend with Pearson correlation for each site",
    theme = theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Ellerslie South shows weak positive PM2.5-wind direction correlation (R = 0.18–0.19), similar to Westlake (R = 0.14–0.2). Both sites' significance (p < 2.2e-16) confirms trends across 2016–2024. ")
```

## Tracing SO2 Patterns at Ellerslie South
Explore how SO2 levels at Ellerslie South respond to shifting winds. We compare raw and standardized data to reveal subtle trends, wind speed influences, and site-type differences from 2016–2024.

```{r plot-so2-vs-winddir}
# Display plot, select "Ellerslie South", it is the only site recording SO2 values
data <- filter(daily_airdata, sa2_name == "Ellerslie South")
plot_so2_vs_winddir <- plot_winddir_vs_pollutants(data, "SO2", "top") +
  labs(title = "", subtitle = "Categorized by 10-90% Percentiles")

# Plot SO2 vs wind direction categorized by site type
data <- filter(daily_airdata, sa2_name == "Ellerslie South")
plot_winddir_so2_site <- plot_winddir_pollutants_site(
  data, "SO2", "bottom") +
  labs(title = "", subtitle = "Categorized by Site Type")

# Plot z-anomalies
data <- filter(standardized_airdata, sa2_name == "Ellerslie South")
plot_standardized_1 <- plot_winddir_vs_pollutants(data, "SO2", "top") +
  scale_y_continuous() +
  labs(
    title = "Z-anomaly", subtitle = "Categorized by 10-90% Percentiles",
    x = "Standardized Wind Direction", y = "Standardized SO2") 

# Plot z-anomalies restricted to <= 3
data <- filter(standardized_airdata, sa2_name == "Ellerslie South" & SO2 <= 3)
plot_standardized_2 <- plot_winddir_vs_pollutants(data, "SO2", "top") +
  scale_y_continuous() +
  labs(
    title = "Z-anomalies (<= 3)", subtitle = "Categorized by 10-90% Percentiles",
    x = "Standardized Wind Direction", y = "Standardized SO2")

(plot_so2_vs_winddir + plot_winddir_so2_site) / (plot_standardized_1  + plot_standardized_2) +
  plot_layout(guides = "collect") + # Collect legends
  plot_annotation(
    title = "Relationship Between Raw and Standardised Daily Wind Speed and SO2 Concentration at sites in Auckland (2016–2024)",
    subtitle = "GAM smooth trend with Pearson correlation for each site",
    theme = theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste("SO2 concentration weakly correlates with wind direction. Categories include wind speed levels (low, medium, high) and site types (residential, industrial, NES). GAM smooth trends analyze relationships at Auckland sites (2016–2024).")
```

## WindDir vs RelHum
Visually check for correlation between raw wind direction and RelHum levels across sites. Explore whether RelHum vary consistently with wind direction. Assess whether standardizing wind direction and RelHum improves clarity of trends. Reduces distortion from wind direction outliers for better pattern detection.

```{r plot-daily-winddir-vs-relhum-and-z-anomalies}
# Plot raw wind direction vs RelHum for selected sites, "Puni" and "Queen Street" does not contain any numeric WindDir values
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_winddir_vs_relhum <- plot_winddir_vs_pollutants(
  data, "RelHum", "bottom") +
  scale_y_continuous() +
  labs(y = "Relative Humidity (%)")

# Display plot
plot_winddir_vs_relhum

# Summary Insight
paste(" This captivating plot explores daily wind direction and relative humidity in Auckland (2016-2024). While Glen Eden Central shows a slight positive correlation, others reveal weak or negative relationships, highlighting diverse atmospheric dynamics across sites. ")

# Plot standardized wind direction vs RelHum for selected sites, "Puni" and "Queen Street" does not contain any numeric WindDir values
data <- filter(standardized_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_standardized <- plot_winddir_vs_pollutants(
  data, "RelHum", "bottom") +
  labs(
    title = "Relationship Between Standardized Daily Wind Speed and RelHum at sites in Auckland (2016–2024)",
    x = "Standardized Wind Direction",
    y = "Standardized Relative Humidity")

# Display plot
plot_standardized

# Summary Insight
paste(" Some sites show clear negative correlations (Ellerslie South, Sunnyhills East, Westlake), where specific wind directions align with lower humidity. Others, like Glen Eden Central, exhibit weak or no correlation, suggesting different local factors influence humidity. ")

# Free RAM
rm(standardized_airdata)
gc() # Force garbage collection
```

```{r plot-winddir-vs-relhum-by-sitetype}
# Plot raw wind direction vs RelHum for selected sites, "Puni" and "Queen Street" does not contain any numeric WindDir values
data <- filter(daily_airdata, !(sa2_name %in% c("Puni", "Queen Street")))

plot_winddir_relhum_site <- plot_winddir_pollutants_site(
  data, "RelHum", "bottom") +
  scale_y_continuous() +
  labs(y = "Relative Humidity")

# Display plot
plot_winddir_relhum_site

# Summary Insight
paste(" Across Auckland, wind direction and humidity show varied, often weak relationships, with each site displaying unique patterns and correlations. ")
```
</details>

# Decoding Auckland's Air: Pollutant, AQI, and Weather Insights (2016-2024)
Ever wondered about Auckland's air? Our analysis of 2016-2024 data reveals fascinating links between pollutants (SO2, NO, NO2, PM2.5, PM10), AQI, and weather (wind, temperature, humidity). Strong correlations at urban sites like Queen Street highlight traffic impacts, while rural areas show weaker links. Understanding these site-specific dynamics, influenced by wind speed/direction and site type, is key to managing Auckland's air quality.

<details><summary>Read more...</summary>

```{r compute-weekly-average-by-site}
# Create a new variable representing the week start date
weekly_airdata <- daily_airdata |>
  mutate(week_start = floor_date(date, unit = "week", week_start = 1))  # week starts on Monday

# Summarize totals by week
weekly_airdata <- weekly_airdata |>
  group_by(sa2_name, site_type, week_start) |>
  summarise(
    NO = sum(NO, na.rm = TRUE), NO2 = sum(NO2, na.rm = TRUE),
    PM2.5 = sum(PM2.5, na.rm = TRUE), 
    PM10 = sum(PM10, na.rm = TRUE),
    SO2 = sum(SO2, na.rm = TRUE), 
    AirTemp = sum(AirTemp, na.rm = TRUE),
    WindSpeed = sum(WindSpeed, na.rm = TRUE),
    WindDir = sum(WindDir, na.rm = TRUE),
    RelHum = sum(RelHum, na.rm = TRUE),
    AQI = sum(AQI, na.rm = TRUE),
    .groups = "drop")

# Group by sites and z scores
  weekly_airdata <- weekly_airdata |>
    group_by(sa2_name, site_type) |>
    mutate(
      z_NO = (NO - mean(NO, na.rm = TRUE)) / sd(NO, na.rm = TRUE),
      z_NO2 = (NO2 - mean(NO2, na.rm = TRUE)) / sd(NO2, na.rm = TRUE),
      z_PM2.5 = (PM2.5 - mean(PM2.5, na.rm = TRUE)) / sd(PM2.5, na.rm = TRUE),
      z_PM10 = (PM10 - mean(PM10, na.rm = TRUE)) / sd(PM10, na.rm = TRUE),
      z_SO2 = (SO2 - mean(SO2, na.rm = TRUE)) / sd(SO2, na.rm = TRUE),
      z_AirTemp = (AirTemp - mean(AirTemp, na.rm = TRUE)) / sd(AirTemp, na.rm = TRUE),
      z_WindSpeed = (WindSpeed - mean(WindSpeed, na.rm = TRUE)) / sd(WindSpeed, na.rm = TRUE),
      z_WindDir = (WindDir - mean(WindDir, na.rm = TRUE)) / sd(WindDir, na.rm = TRUE),
      z_RelHum = (RelHum - mean(RelHum, na.rm = TRUE)) / sd(RelHum, na.rm = TRUE),
      z_AQI = (AQI - mean(AQI, na.rm = TRUE)) / sd(AQI, na.rm = TRUE)) |> ungroup()
  
# Create a new variable representing the month start date
monthly_airdata <- daily_airdata |>
  mutate(month_start = floor_date(date, unit = "month"))

# Summarize total by month and site
monthly_airdata <- monthly_airdata |>
  group_by(sa2_name, site_type, month_start) |>
  summarise(
    NO = sum(NO, na.rm = TRUE), NO2 = sum(NO2, na.rm = TRUE),
    PM2.5 = sum(PM2.5, na.rm = TRUE), 
    PM10 = sum(PM10, na.rm = TRUE),
    SO2 = sum(SO2, na.rm = TRUE),
    AirTemp = sum(AirTemp, na.rm = TRUE),
    WindSpeed = sum(WindSpeed, na.rm = TRUE),
    WindDir = sum(WindDir, na.rm = TRUE),
    RelHum = sum(RelHum, na.rm = TRUE),
    AQI = sum(AQI, na.rm = TRUE),
    .groups = "drop")

# Group by sites and compute z-scores
monthly_airdata <- monthly_airdata |>
  group_by(sa2_name, site_type) |>
  mutate(
    z_NO = (NO - mean(NO, na.rm = TRUE)) / sd(NO, na.rm = TRUE),
    z_NO2 = (NO2 - mean(NO2, na.rm = TRUE)) / sd(NO2, na.rm = TRUE),
    z_PM2.5 = (PM2.5 - mean(PM2.5, na.rm = TRUE)) / sd(PM2.5, na.rm = TRUE),
    z_PM10 = (PM10 - mean(PM10, na.rm = TRUE)) / sd(PM10, na.rm = TRUE),
    z_SO2 = (SO2 - mean(SO2, na.rm = TRUE)) / sd(SO2, na.rm = TRUE),
    z_AirTemp = (AirTemp - mean(AirTemp, na.rm = TRUE)) / sd(AirTemp, na.rm = TRUE),
    z_WindSpeed = (WindSpeed - mean(WindSpeed, na.rm = TRUE)) / sd(WindSpeed, na.rm = TRUE),
    z_WindDir = (WindDir - mean(WindDir, na.rm = TRUE)) / sd(WindDir, na.rm = TRUE),
    z_RelHum = (RelHum - mean(RelHum, na.rm = TRUE)) / sd(RelHum, na.rm = TRUE),
    z_AQI = (AQI - mean(AQI, na.rm = TRUE)) / sd(AQI, na.rm = TRUE)) |> ungroup()
```

```{r plot-pollutants-joint-percentile-ribbon}
plot_pollutants_z <- function(data, xvar, yvar, title_var, x_pct = c(0.1, 0.9), y_pct = c(0.1, 0.9), x_ribbon_fill = "#0072B2", y_ribbon_fill = "#E69F00", ribbon_alpha = 0.2) {
  # Calculate percentile bounds and ranges per sa2_name
  ribbons <- data |>
    group_by(sa2_name) |>
    summarise(
      x_low = quantile(.data[[xvar]], probs = x_pct[1], na.rm = TRUE),
      x_high = quantile(.data[[xvar]], probs = x_pct[2], na.rm = TRUE),
      y_low = quantile(.data[[yvar]], probs = y_pct[1], na.rm = TRUE),
      y_high = quantile(.data[[yvar]], probs = y_pct[2], na.rm = TRUE),
      x_min = min(.data[[xvar]], na.rm = TRUE),
      x_max = max(.data[[xvar]], na.rm = TRUE),
      y_min = min(.data[[yvar]], na.rm = TRUE),
      y_max = max(.data[[yvar]], na.rm = TRUE)
    )
  
  # Create the plot
  ggplot(data, aes(x = .data[[xvar]], y = .data[[yvar]])) +
    geom_rect(data = ribbons, aes(xmin = x_low, xmax = x_high, ymin = y_min, ymax = y_max), fill = x_ribbon_fill, alpha = ribbon_alpha, inherit.aes = FALSE) +
    geom_rect(data = ribbons, aes(xmin = x_min, xmax = x_max, ymin = y_low, ymax = y_high), fill = y_ribbon_fill, alpha = ribbon_alpha, inherit.aes = FALSE) +
    geom_point(aes(color = site_type), size = 2, alpha = 0.9) +
    geom_smooth(method = "loess", se = FALSE, color = "#4D4D4D", linewidth = 1) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "bottom", size = 3.5, color = "#000000") +
    facet_wrap(~ sa2_name, scales = "free") +
    scale_color_viridis_d(option = "D", name = "Site Type") +
    labs(
      title = paste(title_var, "Pollutant Relationship:", xvar, "vs", yvar), 
      subtitle = paste0(
        xvar, " (", x_pct[1]*100, "–", x_pct[2]*100, "th %) and ", 
        yvar, " (", y_pct[1]*100, "–", y_pct[2]*100, "th %) percentile ribbons shown. ",
        "Loess trend line indicates overall relationship."),
      x = paste0(title_var, " ", xvar, " (µg/m³)"),
      y = paste0(title_var, " ", yvar, " (µg/m³)")
    ) +
    theme_bw() +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 13, face = "bold"),
      axis.text = element_text(size = 11),
      axis.text.x = element_text(angle = 45, hjust = 1),
      strip.text = element_text(size = 13, face = "bold"),
      legend.position = "bottom",
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 11)
    )
}
```

## Pollutant Interaction Analysis: NO Relationships Across Time and Sites
In this section, I explore the relationships between nitrogen oxide (NO) and other pollutants or environmental factors. I focus on both **weekly** and **monthly** aggregated data, broken down by **monitoring site**, to understand patterns in pollution dynamics and the influence of site characteristics (traffic, industrial, residential).

### NO vs NO2: Oxidant Pollutant Relationship

```{r plot-weekly-no-vs-no2-group-by-sites}
# Weekly NO vs NO2 correlation across sites, excluding site with missing data
data <- filter(weekly_airdata, sa2_name != "Sunnyhills East")

plot_pollutants_z(data, "NO", "NO2", "Weekly")

# Summary Insight
paste(" Sites like Ellerslie South, Queen Street, and Westlake exhibit strong NO-NO2 correlations, particularly in high-traffic or mixed-use zones. In contrast, Puni shows weaker associations, possibly due to lower vehicle density or differing meteorological conditions. This suggests local emission profiles drive site-specific differences. ") 

# Monthly NO vs NO2 correlation across sites, excluding site with missing data
data <- filter(monthly_airdata, sa2_name != "Sunnyhills East")

plot_pollutants_z(data, "NO", "NO2", "Monthly")

# Summary Insight
paste(" Correlations between NO and NO2 remain strong across all six monitored sites, though magnitude varies. This confirms consistent co-emission patterns from combustion sources, likely vehicles or industrial activities. Lower monthly variance at certain sites suggests meteorological smoothing over time. ") 
```

### NO vs PM2.5: Fine Particulate Relationship

```{r plot-weekly-no-vs-pm2.5-group-by-sites}
# Plot weekly NO versus PM2.5 by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East"))

plot_pollutants_z(data, "NO", "PM2.5", "Weekly")

# Summary Insight
paste(" Ellerslie South shows the strongest weekly correlation between NO and PM2.5 (R = 0.57), highlighting co-emissions in industrial settings. Other sites display weaker relationships, implying particulate pollution may be less tied to NO sources like traffic. ") 

# Plot monthly NO versus PM2.5 by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East"))

plot_pollutants_z(data, "NO", "PM2.5", "Monthly")

# Summary Insight
paste(" Queen Street shows wide NO percentile ranges, consistent with fluctuating traffic emissions. In contrast, Puni has more stable monthly patterns. These results underscore how land use and site classification affect NO-PM2.5 dynamics over time. ") 
```

### NO vs PM10: Coarse Particulate Dynamics

```{r plot-weekly-no-vs-pm10-group-by-sites}
# Plot weekly NO versus PM10 by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants_z(data, "NO", "PM10", "Weekly")

# Summary Insight
paste(" Traffic-dominated areas like Queen Street show higher quantiles and stronger NO-PM10 coupling. Outliers at residential and industrial sites suggest localized spikes—possibly weather-driven or from seasonal activities. ") 

# Plot monthly NO versus PM10 by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants_z(data, "NO", "PM10", "Monthly")

# Summary Insight
paste(" Traffic and industrial sites exhibit larger NO ranges and outlier behavior. Stable PM10 distributions across months suggest decoupling from NO emissions at some locations, or influence by different particle sources. ")
```

### NO vs SO2: Industrial Emission Signals

```{r plot-weekly-and-monthly-no-vs-so2-group-by-sites}
# Plot weekly and monthly NO versus SO2 by site, remove sites not having data
data1 <- filter(weekly_airdata, sa2_name == "Ellerslie South")
data2 <- filter(monthly_airdata, sa2_name == "Ellerslie South")

plot1 <- plot_pollutants_z(data1, "NO", "SO2", "Weekly") + labs(title = "Weekly", subtitle = "")
  
plot2 <- plot_pollutants_z(data2, "NO", "SO2", "Monthly") + labs(title = "Monthly", subtitle = "")

plot1 + plot2 +
  plot_annotation(
    title = "Weekly and Monthly NO versus SO2 Pollutant Relationship",
    subtitle = "Vertical ribbon = 10–90th percentile for NO; Horizontal ribbon = 10–90th percentile for SO2",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Ellerslie South shows a consistent NO-SO2 relationship at both weekly and monthly levels, indicating a strong industrial signal. Broader quantile ranges and upper outliers point to episodic emissions or weather amplification effects. ") 
```

### NO vs AQI: Anomaly Analysis
This analysis reveals how spikes in nitric oxide align with poor air quality, especially in traffic-heavy areas like Queen Street, while residential sites show more stable, less erratic pollution patterns.

```{r plot-z-anomalies-of-weekly-no-vs-aqi}
# Plot z-anomalies of weekly NO versus AQI by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants_z(data, "z_NO", "z_AQI", "Weekly") +
  labs(
    title = "Weekly NO versus AQI Relationship of Anomalies",
    x = "Weekly NO Anomaly", y = "Weekly AQI Anomaly"
  )

# Summary Insight
paste(" High NO anomalies coincide with AQI outliers at traffic-dominated sites. Residential sites maintain tighter distributions, indicating less volatile pollution patterns. Outliers clustered around Queen Street support the traffic-related episodic spikes hypothesis. ") 

# Plot z-anomalies of monthly NO versus AQI by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants_z(data, "z_NO", "z_AQI", "Monthly") +
  labs(
    title = "Monthly NO versus AQI Relationship of Anomalies",
    x = "Monthly NO Anomaly", y = "Monthly AQI Anomaly"
  )

# Summary Insight
paste(" Monthly trends confirm the pattern: Queen Street and Westlake show wide NO anomaly distributions and frequent AQI deviations. Residential sites remain more stable. ") 
```

### NO vs Temperature: Meteorological Influence

```{r plot-z-anomalies-of-weekly-no-vs-airtemp}
# Plot z-anomalies of weekly NO versus AirTemp by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO", "z_AirTemp", "Weekly") +
  labs(
    title = "Weekly NO versus AirTemp Relationship of Anomalies",
    x = "Weekly NO Anomaly", y = "Weekly AirTemp Anomaly"
  )

# Summary Insight
paste(" Broader quantile ranges at traffic sites reflect temperature sensitivity in NO emissions. Heat-driven photochemical effects may intensify NO spikes, while residential sites stay less variable. ") 

# Plot z-anomalies of monthly NO versus AirTemp by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO", "z_AirTemp", "Monthly") +
  labs(
    title = "Monthly Relationship of NO versus AirTemp Anomalies",
    x = "Monthly NO Anomaly", y = "Monthly AirTemp Anomaly"
  )

# Summary Insight
paste(" Residential zones show more pronounced dispersion in anomalies. In contrast, Queen Street shows stability, possibly due to consistent emissions regardless of temperature variation. ") 
```

### NO vs Wind Speed

```{r plot-z-anomalies-of-weekly-no-vs-windspeed}
# Plot z-anomalies of weekly NO versus WindSpeed by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO", "z_WindSpeed", "Weekly") +
  labs(
    title = "Weekly NO versus WindSpeed Relationship of Anomalies",
    x = "Weekly NO Anomaly", y = "Weekly WindSpeed Anomaly"
  )

# Summary Insight
paste(" Outliers concentrate during extreme wind deviations, especially in residential zones. This indicates that wind dynamics disperse or concentrate pollutants based on site geography and topography. ")

# Plot z-anomalies of monthly NO versus WindSpeed by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO", "z_WindSpeed", "Monthly") +
  labs(
    title = "Monthly Relationship of NO versus WindSpeed Anomalies",
    x = "Monthly NO Anomaly", y = "Monthly WindSpeed Anomaly"
  )

# Summary Insight
paste(" Monthly analysis echoes weekly trends. Tight quantiles at traffic sites, broader spreads at residential or mixed-use sites. Dispersion patterns confirm wind as a modulating factor in NO levels. ")
```

### RelHum vs Wind Speed

```{r plot-z-anomalies-of-weekly-relhum-vs-windspeed}
# Plot z-anomalies of weekly RelHum versus WindSpeed by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_RelHum", "z_WindSpeed", "Weekly") +
  labs(
    title = "Weekly RelHum versus WindSpeed Relationship of Anomalies",
    x = "Weekly RelHum Anomaly", y = "Weekly WindSpeed Anomaly"
  )

# Summary Insight
paste(" While all show a positive correlation, the strength and pattern differ, influenced by site type (residential, traffic, industrial). Some sites exhibit clearer trends than others. ")

# Plot z-anomalies of monthly RelHum versus WindSpeed by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_RelHum", "z_WindSpeed", "Monthly") +
  labs(
    title = "Monthly Relationship of RelHum versus WindSpeed Anomalies",
    x = "Monthly RelHum Anomaly", y = "Monthly WindSpeed Anomaly"
  )

# Summary Insight
paste(" These plots reveal diverse monthly RelHum-WindSpeed anomaly relationships. While all show a general positive trend, each site exhibits unique curve shapes and point distributions, reflecting distinct atmospheric dynamics. ")
```

### NO vs Wind Direction

```{r plot-z-anomalies-of-weekly-no-vs-winddir}
# Plot z-anomalies of weekly NO versus WindDir by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO", "z_WindDir", "Weekly") +
  labs(
    title = "Weekly Relationship of NO versus WindDir Anomalies",
    x = "Weekly NO Anomaly", y = "Weekly WindDir Anomaly"
  )

# Summary Insight
paste(" Ellerslie South (Residential, Industrial) has a broad quantile range with fewer outliers. Glen Eden Central (Residential) is similar but narrower. Westlake (Traffic) has the most outliers, while Henderson Lincoln South (Residential, Traffic) shows moderate dispersion. ")
 
# Plot z-anomalies of monthly NO versus WindDir by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO", "z_WindDir", "Monthly") +
  labs(
    title = "Monthly Relationship of NO versus WindDir Anomalies",
    x = "Monthly NO Anomaly", y = "Monthly WindDir Anomaly"
  )

# Summary Insight
paste(" Ellerslie South, Glen Eden Central, and Henderson Lincoln South show broad 10-90th percentile bands for NO and WindDir anomalies, with weak correlations. Westlake has narrower bands and stronger outlier sensitivity (R = 0.31, p = 0.002). ")
```

## Weekly and monthly relationship of NO2 versus Factors

```{r plot-weekly-and-monthly-no2-vs-pm2.5-by-sites}
# Plot weekly NO2 versus PM2.5 by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East"))

plot_pollutants_z(data, "NO2", "PM2.5", "Weekly")

# Summary Insight
paste(" Residential sites show broader quantile ranges but fewer extreme outliers. Traffic sites exhibit tighter distributions with high-end NO2 values. Industrial sites reveal dispersed PM2.5 patterns, while the other sites maintain lower variability. ")

# Plot monthly NO2 versus PM2.5 by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East"))

plot_pollutants_z(data, "NO2", "PM2.5", "Monthly")

# Summary Insight
paste(" Residential sites (Ellerslie South, Puni) show tighter NO2-PM2.5 clustering with fewer outliers, while traffic sites (Queen Street, Westlake) have broader quantiles and more extreme outliers, indicating higher pollutant variability and emission influences. ")
```

```{r plot-weekly-and-monthly-no2-vs-pm10-by-sites}
# Plot weekly NO2 versus PM10 by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants_z(data, "NO2", "PM10", "Weekly")

# Summary Insight
paste(" PM10-NO2 quantiles vary by site type, with traffic sites showing higher pollutant levels. Industrial sites exhibit wider dispersion. Outliers occur at traffic-heavy locations, skewing trends. Residential sites display tighter pollutant distributions. ")

# Plot monthly NO2 versus PM10 by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants_z(data, "NO2", "PM10", "Monthly")

# Summary Insight
paste(" High-quantile NO2 values vary by site type: traffic sites show extreme outliers, while residential sites exhibit stable trends. PM10 displays broader dispersion, with industrial sites showing elevated concentrations. ")
```

```{r plot-weekly-and-monthly-no2-vs-so2-group-by-sites}
# Plot weekly and monthly NO2 versus SO2 by site, remove sites not having data
data1 <- filter(weekly_airdata, sa2_name == "Ellerslie South")
data2 <- filter(monthly_airdata, sa2_name == "Ellerslie South")

plot1 <- plot_pollutants_z(data1, "NO2", "SO2", "Weekly") + labs(title = "Weekly", subtitle = "")
  
plot2 <- plot_pollutants_z(data2, "NO2", "SO2", "Monthly") + labs(title = "Monthly", subtitle = "")

plot1 + plot2 +
  plot_annotation(
    title = "Weekly and Monthly NO2 versus SO2 Pollutant Relationship",
    subtitle = "Vertical ribbon = 10–90th percentile for NO2; Horizontal ribbon = 10–90th percentile for SO2",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" NO2-SO2 correlations differ across weekly and monthly data. Ellerslie South being the industrial site show higher pollutant levels. Outliers above 90th percentiles skew trend interpretations. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-no2-vs-aqi}
# Plot z-anomalies of weekly NO2 versus AQI by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants_z(data, "z_NO2", "z_AQI", "Weekly") +
  labs(
    title = "Weekly Relationship of NO2 versus AQI Anomalies",
    x = "Weekly NO2 Anomaly", y = "Weekly AQI Anomaly"
  )

# Summary Insight
paste(" Quantile trends vary by site type, with transport sites showing higher NO2 anomalies. Outliers influence correlations, especially extreme AQI shifts, impacting pollutant relationships across locations. Seasonal dispersion affects anomaly consistency. ")

# Plot z-anomalies of monthly NO2 versus AQI by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants_z(data, "z_NO2", "z_AQI", "Monthly") +
  labs(
    title = "Monthly Relationship of NO2 versus AQI Anomalies",
    x = "Monthly NO2 Anomaly", y = "Monthly AQI Anomaly"
  )

# Summary Insight
paste(" Residential sites show tighter NO2 anomaly distributions, while industrial sites exhibit broader variability. Traffic sites have high NO2 extremes. Outliers skew AQI correlations, particularly at Ellerslie South and Queen Street. ")
```

```{r plot-weekly-and-monthly-anomalies-of-no2-vs-airtemp-by-sites}
# Plot weekly Anomalies of NO2 versus AirTemp by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO2", "z_AirTemp", "Weekly") +
  labs(
    title = "Weekly Relationship of NO2 versus AirTemp Anomalies",
    x = "Weekly NO2 Anomaly", y = "Weekly AirTemp Anomaly"
  )

# Summary Insight
paste(" Residential-traffic sites show wider NO2 anomalies, while traffic sites have extreme outliers. Residential sites exhibit narrower quantile ranges. Strong correlations emerge in Ellerslie South and Henderson Lincoln South, highlighting site-specific variability. ")

# Plot monthly anomalies of NO2 versus AirTemp by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO2", "z_AirTemp", "Monthly") +
  labs(
    title = "Monthly Relationship of NO2 versus AirTemp Anomalies",
    x = "Monthly NO2 Anomaly", y = "Monthly AirTemp Anomaly"
  )

# Summary Insight
paste(" Traffic sites show higher upper quantiles, residential sites have lower variability. Outliers are more frequent in traffic sites, diverging from expected seasonal trends. Temperature influences dispersion. ")
```

```{r plot-weekly-and-monthly-anomalies-of-no2-vs-windspeed}
# Plot weekly anomalies of NO2 versus WindSpeed by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO2", "z_WindSpeed", "Weekly") +
  labs(
    title = "Weekly Relationship of NO2 versus WindSpeed Anomalies",
    x = "Weekly NO2 Anomaly", y = "Weekly WindSpeed Anomaly"
  )

# Summary Insight
paste(" Residential, Industrial, NES sites have tighter quantiles with fewer outliers, while Residential, Traffic, NES sites show wider quantiles and more outliers, highlighting variability in NO2 and wind speed anomalies across locations. ")

# Plot monthly anomalies of NO2 versus WindSpeed by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO2", "z_WindSpeed", "Monthly") +
  labs(
    title = "Monthly Relationship of NO2 versus WindSpeed Anomalies",
    x = "Monthly NO2 Anomaly", y = "Monthly WindSpeed Anomaly"
  )

# Summary Insight
paste(" NO2 anomalies vary across site types. Traffic sites show higher outliers and stronger correlations with windspeed. Industrial sites have broader quantile ranges. Residential sites show moderate trends with dispersed anomalies and weaker correlations. ")
```

```{r plot-weekly-and-monthly-anomalies-of-relhum-vs-windspeed}
# Plot weekly anomalies of RelHum versus WindSpeed by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_RelHum", "z_WindSpeed", "Weekly") +
  labs(
    title = "Weekly Relationship of RelHum versus WindSpeed Anomalies",
    x = "Weekly RelHum Anomaly", y = "Weekly WindSpeed Anomaly"
  )

# Summary Insight
paste(" Henderson Lincoln South shows a consistently weak positive link, while others like Ellerslie South exhibit stronger, more complex correlations, often influenced by site type, impacting how anomalies interact. ")

# Plot monthly anomalies of RelHum versus WindSpeed by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_RelHum", "z_WindSpeed", "Monthly") +
  labs(
    title = "Monthly Relationship of RelHum versus WindSpeed Anomalies",
    x = "Monthly RelHum Anomaly", y = "Monthly WindSpeed Anomaly"
  )

# Summary Insight
paste(" These plots reveal fascinating site-specific relationships between monthly relative humidity and wind speed anomalies. While all show a positive correlation, the strength and pattern vary, highlighting diverse local atmospheric influences. ")
```

```{r plot-weekly-and-monthly-zscore-of-no2-vs-winddir}
# Plot weekly anomalies of NO2 versus WindDir by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO2", "z_WindDir", "Weekly") +
  labs(
    title = "Weekly Relationship of NO2 versus WindDir Anomalies",
    x = "Weekly NO2 Anomaly", y = "Weekly WindDir Anomaly"
  )

# Summary Insight
paste(" NO2-WindDir anomalies vary by site type. Traffic sites show wider NO2 quantiles, industrial zones display moderate variability, and residential sites exhibit narrow quantiles. Outliers influence correlation strength, affecting site-specific pollutant trends. ")

# Plot monthly anomalies of NO2 versus WindDir by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants_z(data, "z_NO2", "z_WindDir", "Monthly") +
  labs(
    title = "Monthly Relationship of NO2 versus WindDir Anomalies",
    x = "Monthly NO2 Anomaly", y = "Monthly WindDir Anomaly"
  )

# Summary Insight
paste(" Quantiles reveal NO2 variability across site types, highlighting differences in pollution levels. Outliers—like extreme wind-direction anomalies—suggest localized influences. Traffic sites show wider variability, while residential sites exhibit more stable distributions. ")
```

## Weekly and monthly relationship of PM2.5 versus Factors
Explore how PM2.5 levels interact weekly and monthly with PM10, SO2, AQI, temperature, humidity, and wind. Discover site-specific patterns, variability, and pollution dynamics across urban and rural Auckland.

```{r plot-weekly-and-monthly-pm2.5-vs-pm10-by-sites}
# Plot weekly PM2.5 versus PM10 by site, remove sites not having data
data <- filter(weekly_airdata, !(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East")))

plot_pollutants_z(data, "PM2.5", "PM10", "Weekly")

# Summary Insight
paste(" Queen Street has the highest PM2.5-PM10 correlation, with narrow quantile ranges. Westlake shows weak correlation and wider spread. Residential sites exhibit broader PM10 dispersion; traffic sites have tighter distributions but more high outliers. ")

# Plot monthly PM2.5 versus PM10 by site, remove sites not having data
data <- filter(monthly_airdata, !(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East")))

plot_pollutants_z(data, "PM2.5", "PM10", "Monthly")

# Summary Insight
paste(" Queen Street shows the strongest PM2.5–PM10 correlation (R=0.87) with fewer outliers. Puni and Ellerslie South have moderate correlations with wider quantile ranges. Westlake exhibits weak correlation and high variability, suggesting localized influences. ")
```

```{r plot-weekly-and-monthly-pm2.5-vs-so2-group-by-sites}
# Plot weekly and monthly PM2.5 versus SO2 by site, remove sites not having data
data1 <- filter(weekly_airdata, sa2_name == "Ellerslie South")
data2 <- filter(monthly_airdata, sa2_name == "Ellerslie South")

plot1 <- plot_pollutants_z(data1, "PM2.5", "SO2", "Weekly") + labs(title = "Weekly Total", subtitle = "")
  
plot2 <- plot_pollutants_z(data2, "PM2.5", "SO2", "Monthly") + labs(title = "Monthly Total", subtitle = "")

plot1 + plot2 +
  plot_annotation(
    title = "Weekly and Monthly PM2.5 versus SO2 Pollutant Relationship",
    subtitle = "Vertical ribbon = 10–90th percentile for PM2.5; Horizontal ribbon = 10–90th percentile for SO2; Smooth Trendline LOESS Added to show overall Relationship",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Weekly plot show lower PM2.5 and SO2 variability than monthly plot, with fewer extreme outliers. Weekly plot exhibit tighter dispersion, aligning with stricter air quality standards. Monthly data reveals stronger correlations. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm2.5-vs-aqi}
# Plot z-anomalies of weekly PM2.5 versus AQI by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East"))

plot_pollutants_z(data, "z_PM2.5", "z_AQI", "Weekly") +
  labs(
    title = "Weekly Relationship of PM2.5 versus AQI Anomalies",
    x = "Weekly PM2.5 Anomaly", y = "Weekly AQI Anomaly"
  )

# Summary Insight
paste(" Quantiles highlight pollutant variability across site types, with traffic sites showing higher PM2.5 levels. Outliers reveal extreme AQI anomalies, suggesting localized emission sources or meteorological influences impacting pollutant dispersion. ")

# Plot z-anomalies of monthly PM2.5 versus AQI by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East"))

plot_pollutants_z(data, "z_PM2.5", "z_AQI", "Monthly") +
  labs(
    title = "Monthly Relationship of PM2.5 versus AQI Anomalies",
    x = "Monthly PM2.5 Anomaly", y = "Monthly AQI Anomaly"
  )

# Summary Insight
paste(" Traffic sites (Queen Street) show higher pollutant variability, with extreme outliers beyond residential and industrial ranges. Residential sites display consistent trends, but industrial sites exhibit wider quantile dispersion. Correlation varies across site types. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm2.5-vs-airtemp}
# Plot z-anomalies of weekly PM2.5 versus AirTemp by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East", "Puni"))

plot_pollutants_z(data, "z_PM2.5", "z_AirTemp", "Weekly") +
  labs(
    title = "Weekly Relationship of PM2.5 versus AirTemp Anomalies",
    x = "Weekly PM2.5 Anomaly", y = "Weekly AirTemp Anomaly"
  )

# Summary Insight
paste(" Ellerslie South shows wider PM2.5 quantile ranges and more outliers than Queen Street and Westlake. Westlake has the highest anomalies, while traffic sites display greater variability due to localized emission influences. ")

# Plot z-anomalies of monthly PM2.5 versus AirTemp by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East", "Puni"))

plot_pollutants_z(data, "z_PM2.5", "z_AirTemp", "Monthly") +
  labs(
    title = "Monthly Relationship of PM2.5 versus AirTemp Anomalies",
    x = "Monthly PM2.5 Anomaly", y = "Monthly AirTemp Anomaly"
  )

# Summary Insight
paste(" At Ellerslie South, lower PM2.5 quantiles correlate with lower temperatures. Queen Street has mid-range PM2.5 variations, with traffic influence. Westlake shows outliers in high PM2.5 quantiles, driven by meteorology and site-specific emissions. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm2.5-vs-relhum}
# Plot z-anomalies of weekly PM2.5 versus RelHum by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East", "Puni", "Queen Street"))

plot_pollutants_z(data, "z_PM2.5", "z_RelHum", "Weekly") +
  labs(
    title = "Weekly Relationship of PM2.5 versus RelHum Anomalies",
    x = "Weekly PM2.5 Anomaly", y = "Weekly RelHum Anomaly"
  )

# Summary Insight
paste(" These plots reveal distinct relationships between PM2.5 and relative humidity anomalies at two sites, with Ellerslie South showing a broader curve and Westlake a sharper, more concentrated trend. ")

# Plot z-anomalies of monthly PM2.5 versus RelHum by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East", "Puni", "Queen Street"))

plot_pollutants_z(data, "z_PM2.5", "z_RelHum", "Monthly") +
  labs(
    title = "Monthly Relationship of PM2.5 versus RelHum Anomalies",
    x = "Monthly PM2.5 Anomaly", y = "Monthly RelHum Anomaly"
  )

# Summary Insight
paste(" These plots show a generally similar curvilinear relationship between PM2.5 and relative humidity anomalies at both sites, though Westlake exhibits a slightly stronger correlation and more site type variation. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm2.5-vs-windspeed}
# Plot z-anomalies of weekly PM2.5 versus WindSpeed by site, remove sites not having data
data <- filter(weekly_airdata, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_pollutants_z(data, "z_PM2.5", "z_WindSpeed", "Weekly") +
  labs(
    title = "Weekly Relationship of PM2.5 versus WindSpeed Anomalies",
    x = "Weekly PM2.5 Anomaly", y = "Weekly WindSpeed Anomaly"
  )

# Summary Insight
paste(" Residential sites show narrower PM2.5 quantile ranges, while traffic sites exhibit higher outliers. Westlake has more extreme PM2.5 anomalies, aligning with stronger correlations to wind speed. Ellerslie South shows weaker pollutant variability. ")

# Plot z-anomalies of monthly PM2.5 versus WindSpeed by site, remove sites not having data
data <- filter(monthly_airdata, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_pollutants_z(data, "z_PM2.5", "z_WindSpeed", "Monthly") +
  labs(
    title = "Monthly Relationship of PM2.5 versus WindSpeed Anomalies",
    x = "Monthly PM2.5 Anomaly", y = "Monthly WindSpeed Anomaly"
  )

# Summary Insight
paste(" Traffic sites show greater PM2.5 variability, with more outliers beyond the 90th percentile, while residential and industrial sites have fewer extreme values. Quantile ribbons suggest stronger pollutant dispersion differences due to localized emissions. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm2.5-vs-winddir}
# Plot z-anomalies of weekly PM2.5 versus WindDir by site, remove sites not having data
data <- filter(weekly_airdata, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_pollutants_z(data, "z_PM2.5", "z_WindDir", "Weekly") +
  labs(
    title = "Weekly Relationship of PM2.5 versus WindDir Anomalies",
    x = "Weekly PM2.5 Anomaly", y = "Weekly WindDir Anomaly"
  )

# Summary Insight
paste(" Ellerslie South has more outliers than Westlake. Residential, Industrial, NES sites show more outliers than Traffic, NES sites. Quantiles reveal PM2.5 anomalies mostly between -1 and 2. Site type influences dispersion patterns. ")

# Plot z-anomalies of monthly PM2.5 versus WindDir by site, remove sites not having data
data <- filter(monthly_airdata, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_pollutants_z(data, "z_PM2.5", "z_WindDir", "Monthly") +
  labs(
    title = "Monthly Relationship of PM2.5 versus WindDir Anomalies",
    x = "Monthly PM2.5 Anomaly", y = "Monthly WindDir Anomaly"
  )

# Summary Insight
paste(" Ellerslie South shows more outliers than Westlake. Residential, industrial NES sites have greater data density within the 10-90th percentile range, while traffic NES sites exhibit higher extremes, influencing overall pollutant variability. ")
```

## How PM10 Reacts Weekly and Monthly to Weather and Co-Pollutants
Explore how PM10 levels shift week-to-week and month-to-month across Auckland sites, revealing unique relationships with SO2, AQI, temperature, humidity, wind speed, and direction—uncovering hidden atmospheric dynamics.

```{r plot-weekly-and-monthly-pm10-vs-so2-group-by-sites}
# Plot weekly and monthly PM10 versus SO2 by site, remove sites not having data
data1 <- filter(weekly_airdata, sa2_name == "Ellerslie South")
data2 <- filter(monthly_airdata, sa2_name == "Ellerslie South")

plot1 <- plot_pollutants_z(data1, "PM10", "SO2", "Weekly") + labs(title = "Weekly Total", subtitle = "")
  
plot2 <- plot_pollutants_z(data2, "PM10", "SO2", "Monthly") + labs(title = "Monthly Total", subtitle = "")

plot1 + plot2 +
  plot_annotation(
    title = "Weekly and Monthly PM10 versus SO2 Pollutant Relationship",
    subtitle = "Vertical ribbon = 10–90th percentile for PM10; Horizontal ribbon = 10–90th percentile for SO2; Smooth Trendline LOESS Added to show overall Relationship",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Weekly plot show tighter PM10-SO2 quantile spreads, while monthly plot display wider variability. Outliers skew relationships, particularly in monthly data. Stronger R suggests monthly plot influences pollutant trends across quantiles. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm10-vs-aqi}
# Plot z-anomalies of weekly PM10 versus AQI by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East"))

plot_pollutants_z(data, "z_PM10", "z_AQI", "Weekly") +
  labs(
    title = "Weekly Relationship of PM10 versus AQI Anomalies",
    x = "Weekly PM10 Anomaly", y = "Weekly AQI Anomaly"
  )

# Summary Insight
paste(" Ellerslie South and Puni show lower PM10 variability, Queen Street has high outliers, and Westlake exhibits moderate spread. Traffic sites show stronger PM10-AQI correlation, highlighting localized emissions. All sites display distinct percentile patterns. ")

# Plot z-anomalies of monthly PM10 versus AQI by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East"))

plot_pollutants_z(data, "z_PM10", "z_AQI", "Monthly") +
  labs(
    title = "Monthly Relationship of PM10 versus AQI Anomalies",
    x = "Monthly PM10 Anomaly", y = "Monthly AQI Anomaly"
  )

# Summary Insight
paste(" Industrial and Residential sites (Ellerslie South, Puni) show lower PM10 variability, while traffic sites (Queen Street, Westlake) have wider quantile ranges, indicating greater pollutant extremes and localized emission influence. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm10-vs-airtemp}
# Plot z-anomalies of weekly PM10 versus AirTemp by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni"))

plot_pollutants_z(data, "z_PM10", "z_AirTemp", "Weekly") +
  labs(
    title = "Weekly Relationship of PM10 versus AirTemp Anomalies",
    x = "Weekly PM10 Anomaly", y = "Weekly AirTemp Anomaly"
  )

# Summary Insight
paste(" Queen Street’s traffic site shows stronger correlations, with outliers above the 90th percentile. Residential sites exhibit weaker trends and fewer extreme values. ")

# Plot z-anomalies of monthly PM10 versus AirTemp by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni"))

plot_pollutants_z(data, "z_PM10", "z_AirTemp", "Monthly") +
  labs(
    title = "Monthly Relationship of PM10 versus AirTemp Anomalies",
    x = "Monthly PM10 Anomaly", y = "Monthly AirTemp Anomaly"
  )

# Summary Insight
paste(" High-quantile PM10 levels differ across site types, with traffic sites showing elevated values. Outliers appear mostly in industrial areas, while residential sites have narrower distributions, reflecting localized meteorological and emission influences. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm10-vs-relhum}
# Plot z-anomalies of weekly PM10 versus RelHum by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_PM10", "z_RelHum", "Weekly") +
  labs(
    title = "Weekly Relationship of PM10 versus RelHum Anomalies",
    x = "Weekly PM10 Anomaly", y = "Weekly RelHum Anomaly"
  )

# Summary Insight
paste(" These plots reveal diverse weekly PM10 and RelHum relationships across five sites, from strong correlations in Ellerslie South to weaker ones in Henderson Lincoln South. ")

# Plot z-anomalies of monthly PM10 versus RelHum by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_PM10", "z_RelHum", "Monthly") +
  labs(
    title = "Monthly Relationship of PM10 versus RelHum Anomalies",
    x = "Monthly PM10 Anomaly", y = "Monthly RelHum Anomaly"
  )

# Summary Insight
paste(" Each site displays unique PM10-RelHum trends, from strong correlations to scattered points, highlighting diverse atmospheric influences. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm10-vs-windspeed}
# Plot z-anomalies of weekly PM10 versus WindSpeed by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_PM10", "z_WindSpeed", "Weekly") +
  labs(
    title = "Weekly Relationship of PM10 versus WindSpeed Anomalies",
    x = "Weekly PM10 Anomaly", y = "Weekly WindSpeed Anomaly"
  )

# Summary Insight
paste(" Higher quantiles show stronger pollutant anomalies in traffic and industrial sites. Residential sites exhibit lower variability. Outliers often skew correlations, particularly near transport corridors, impacting trend clarity across different site categories. ")

# Plot z-anomalies of monthly PM10 versus WindSpeed by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_PM10", "z_WindSpeed", "Monthly") +
  labs(
    title = "Monthly Relationship of PM10 versus WindSpeed Anomalies",
    x = "Monthly PM10 Anomaly", y = "Monthly WindSpeed Anomaly"
  )

# Summary Insight
paste(" PM10 quantiles vary by site type: Traffic sites show higher upper quantiles, while Residential sites have wider spread. Outliers emerge near transport corridors, influenced by meteorology and localized emissions. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-pm10-vs-winddir}
# Plot z-anomalies of weekly PM10 versus WindDir by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_PM10", "z_WindDir", "Weekly") +
  labs(
    title = "Weekly Relationship of PM10 versus WindDir Anomalies",
    x = "Weekly PM10 Anomaly", y = "Weekly WindDir Anomaly"
  )

# Summary Insight
paste(" Residential sites show lower PM10 variability, while traffic and industrial sites exhibit higher outlier frequency. Higher quantiles in traffic sites indicate stronger pollutant dispersion effects. Industrial sites show localized anomalies with seasonal shifts. ")

# Plot z-anomalies of monthly PM10 versus WindDir by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_PM10", "z_WindDir", "Monthly") +
  labs(
    title = "Monthly Relationship of PM10 versus WindDir Anomalies",
    x = "Monthly PM10 Anomaly", y = "Monthly WindDir Anomaly"
  )

# Summary Insight
paste(" Residential-traffic sites show wider PM10 variability across quantiles, while industrial sites exhibit stable trends. Outliers in windy months significantly impact correlations, skewing dispersion patterns and masking seasonal pollutant dynamics. ")
```

## Weekly and monthly relationship of SO2 versus Factors

```{r plot-weekly-and-monthly-anomalies-of-so2-vs-aqi}
# Plot weekly and monthly anomalies of SO2 versus AQI by site, remove sites not having data
data1 <- filter(weekly_airdata, sa2_name == "Ellerslie South")
data2 <- filter(monthly_airdata, sa2_name == "Ellerslie South")

plot1 <- plot_pollutants_z(data1, "z_SO2", "z_AQI", "Weekly") + labs(title = "Weekly Total", subtitle = "",
    x = "Weekly SO2 Anomaly", y = "Weekly AQI Anomaly")
  
plot2 <- plot_pollutants_z(data2, "z_SO2", "z_AQI", "Monthly") + labs(title = "Monthly Total", subtitle = "",
    x = "Monthly SO2 Anomaly", y = "Monthly AQI Anomaly")

plot1 + plot2 +
  plot_annotation(
    title = "Weekly and Monthly Pollutant Relationship of SO2 versus AQI Anomalies",
    subtitle = "Vertical ribbon = 10–90th percentile for SO2; Horizontal ribbon = 10–90th percentile for AQI; Smooth Trendline LOESS Added to show overall Relationship",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Ellerslie South being an industrial site show higher SO2 quantiles with greater AQI variability. The weekly data exhibit distinct outliers affecting air quality trends. The monthly data display stable quantiles, with fewer extreme deviations across weekly and monthly scales. ")
```

```{r plot-weekly-and-monthly-anomalies-of-so2-vs-airtemp}
# Plot weekly and monthly anomalies of SO2 versus AirTemp by site, remove sites not having data
data1 <- filter(weekly_airdata, sa2_name == "Ellerslie South")
data2 <- filter(monthly_airdata, sa2_name == "Ellerslie South")

plot1 <- plot_pollutants_z(data1, "z_SO2", "z_AirTemp", "Weekly") + labs(title = "Weekly Total", subtitle = "",
    x = "Weekly SO2 Anomaly", y = "Weekly AirTemp Anomaly")
  
plot2 <- plot_pollutants_z(data2, "z_SO2", "z_AirTemp", "Monthly") + labs(title = "Monthly Total", subtitle = "",
    x = "Monthly SO2 Anomaly", y = "Monthly AirTemp Anomaly")

plot1 + plot2 +
  plot_annotation(
    title = "Weekly and Monthly Pollutant Relationship of SO2 versus AirTemp Anomalies",
    subtitle = "Vertical ribbon = 10–90th percentile for SO2; Horizontal ribbon = 10–90th percentile for AirTemp; Smooth Trendline LOESS Added to show overall Relationship",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Higher SO2 anomalies align with industrial sites, skewing upper quantiles and shows moderate dispersion. Weekly plot exhibit lower variability, mostly within 10-90th percentiles. Outliers drive correlation shifts, especially in monthly trends. ")
```

```{r plot-weekly-and-monthly-anomalies-of-so2-vs-windspeed}
# Plot weekly and monthly anomalies of SO2 versus WindSpeed by site, remove sites not having data
data1 <- filter(weekly_airdata, sa2_name == "Ellerslie South")
data2 <- filter(monthly_airdata, sa2_name == "Ellerslie South")

plot1 <- plot_pollutants_z(data1, "z_SO2", "z_WindSpeed", "Weekly") + labs(title = "Weekly Total", subtitle = "",
    x = "Weekly SO2 Anomaly", y = "Weekly WindSpeed Anomaly")
  
plot2 <- plot_pollutants_z(data2, "z_SO2", "z_WindSpeed", "Monthly") + labs(title = "Monthly Total", subtitle = "",
    x = "Monthly SO2 Anomaly", y = "Monthly WindSpeed Anomaly")

plot1 + plot2 +
  plot_annotation(
    title = "Weekly and Monthly Pollutant Relationship of SO2 versus WindSpeed Anomalies",
    subtitle = "Vertical ribbon = 10–90th percentile for z_SO2; Horizontal ribbon = 10–90th percentile for z_WindSpeed; Smooth Trendline LOESS Added to show overall Relationship",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Weekly SO2 anomalies have a tighter spread in the 10–90th percentile, while monthly trends show a smoother relationship. Weekly windspeed anomalies exhibit extreme outliers, whereas monthly totals present more stable variations. ")
```

```{r plot-weekly-and-monthly-anomalies-of-so2-vs-relhum}
# Plot weekly and monthly anomalies of SO2 versus RelHum by site, remove sites not having data
data1 <- filter(weekly_airdata, sa2_name == "Ellerslie South")
data2 <- filter(monthly_airdata, sa2_name == "Ellerslie South")

plot1 <- plot_pollutants_z(data1, "z_SO2", "z_RelHum", "Weekly") + labs(title = "Weekly Total", subtitle = "",
    x = "Weekly SO2 Anomaly", y = "Weekly RelHum Anomaly")
  
plot2 <- plot_pollutants_z(data2, "z_SO2", "z_RelHum", "Monthly") + labs(title = "Monthly Total", subtitle = "",
    x = "Monthly SO2 Anomaly", y = "Monthly RelHum Anomaly")

plot1 + plot2 +
  plot_annotation(
    title = "Weekly and Monthly Pollutant Relationship of SO2 versus RelHum Anomalies",
    subtitle = "Vertical ribbon = 10–90th percentile for z_SO2; Horizontal ribbon = 10–90th percentile for z_RelHum; Smooth Trendline LOESS Added to show overall Relationship",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Weekly plot shows a stronger initial positive correlation with more scattered points, while the monthly plot displays a more consistent, smoother positive trend with less variability. ")
```

```{r plot-weekly-and-monthly-anomalies-of-so2-vs-winddir}
# Plot weekly and monthly anomalies of SO2 versus WindDir by site, remove sites not having data
data1 <- filter(weekly_airdata, sa2_name == "Ellerslie South")
data2 <- filter(monthly_airdata, sa2_name == "Ellerslie South")

plot1 <- plot_pollutants_z(data1, "z_SO2", "z_WindDir", "Weekly") + labs(title = "Weekly Total", subtitle = "",
    x = "Weekly SO2 Anomaly", y = "Weekly WindDir Anomaly")
  
plot2 <- plot_pollutants_z(data2, "z_SO2", "z_WindDir", "Monthly") + labs(title = "Monthly Total", subtitle = "",
    x = "Monthly SO2 Anomaly", y = "Monthly WindDir Anomaly")

plot1 + plot2 +
  plot_annotation(
    title = "Weekly and Monthly Pollutant Relationship of SO2 versus WindDir Anomalies",
    subtitle = "Vertical ribbon = 10–90th percentile for z_SO2; Horizontal ribbon = 10–90th percentile for z_WindDir; Smooth Trendline LOESS Added to show overall Relationship",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)))

# Summary Insight
paste(" Weekly data captures short-term fluctuations, with more dispersed SO2 outliers. Monthly data smooths trends but retains variability. Quantile ranges remain stable, with weak correlations (R = 0.057, 0.034). Outlier impacts persist across timescales. ")
```

## Weekly and monthly relationship of AQI versus Factors

```{r plot-z-anomalies-of-weekly-and-monthly-aqi-vs-airtemp}
# Plot z-anomalies of weekly AQI versus AirTemp by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni"))

plot_pollutants_z(data, "z_AQI", "z_AirTemp", "Weekly") +
  labs(
    title = "Weekly Relationship of AQI versus AirTemp Anomalies",
    x = "Weekly AQI Anomaly", y = "Weekly AirTemp Anomaly"
  )

# Summary Insight
paste(" Traffic sites show concentrated outliers, while residential sites have wider quantile spreads. Queen Street has fewer extreme deviations, while Glen Eden and Henderson Lincoln show notable anomalies, affecting AQI-AirTemp correlations differently across locations. ")

# Plot z-anomalies of monthly AQI versus AirTemp by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni"))

plot_pollutants_z(data, "z_AQI", "z_AirTemp", "Monthly") +
  labs(
    title = "Monthly Relationship of AQI versus AirTemp Anomalies",
    x = "Monthly AQI Anomaly", y = "Monthly AirTemp Anomaly"
  )

# Summary Insight
paste(" Higher AQI anomalies occur within 10-90th percentile bounds across sites. Trends show weak correlations with air temperature. Traffic sites show greater variability. Outliers cluster near extreme temperatures, differing by site type and season. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-aqi-vs-relhum}
# Plot z-anomalies of weekly AQI versus RelHum by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AQI", "z_RelHum", "Weekly") +
  labs(
    title = "Weekly Relationship of AQI versus RelHum Anomalies",
    x = "Weekly AQI Anomaly", y = "Weekly RelHum Anomaly"
  )

# Summary Insight
paste(" Some sites show a clear negative correlation between AQI and relative humidity anomalies, while others display varied or positive relationships. ")

# Plot z-anomalies of monthly AQI versus RelHum by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AQI", "z_RelHum", "Monthly") +
  labs(
    title = "Monthly Relationship of AQI versus RelHum Anomalies",
    x = "Monthly AQI Anomaly", y = "Monthly RelHum Anomaly"
  )

# Summary Insight
paste(" Most sites show a slight curve in AQI vs. RelHum, with varying point densities across different land uses and weak correlations. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-aqi-vs-winddir}
# Plot z-anomalies of weekly AQI versus WindDir by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AQI", "z_WindDir", "Weekly") +
  labs(
    title = "Weekly Relationship of AQI versus WindDir Anomalies",
    x = "Weekly AQI Anomaly", y = "Weekly WindDir Anomaly"
  )

# Summary Insight
paste(" Ellerslie South, Glen Eden Central, and Henderson Lincoln South show high AQI anomalies. Sunnyhills East has low AQI outliers. Westlake (Traffic) also shows high anomalies. Correlations range from R = 0.17 to 0.62. ")

# Plot z-anomalies of monthly AQI versus WindDir by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AQI", "z_WindDir", "Monthly") +
  labs(
    title = "Monthly Relationship of AQI versus WindDir Anomalies",
    x = "Monthly AQI Anomaly", y = "Monthly WindDir Anomaly"
  )

# Summary Insight
paste(" Higher pollutant quantiles align with traffic sites, showing distinct outliers. Residential locations exhibit lower variability. Industrial sites reveal moderate dispersions. Outliers skew NES-site trends, impacting correlation significance across wind-direction anomalies. ")
```

## Weekly and monthly relationship of air temperature (AirTemp) versus Factors

```{r plot-z-anomalies-of-weekly-and-monthly-airtemp-vs-windspeed}
# Plot z-anomalies of weekly AirTemp versus WindSpeed by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AirTemp", "z_WindSpeed", "Weekly") +
  labs(
    title = "Weekly Relationship of AirTemp versus WindSpeed Anomalies",
    x = "Weekly AirTemp Anomaly", y = "Weekly WindSpeed Anomaly"
  )

# Summary Insight
paste(" Quantile trends vary by site type: Industrial sites show wider dispersion, while traffic sites exhibit high peaks. Outliers cluster in residential sites, revealing localized emission effects on pollutant variability. ")

# Plot z-anomalies of monthly AirTemp versus WindSpeed by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AirTemp", "z_WindSpeed", "Monthly") +
  labs(
    title = "Monthly Relationship of AirTemp versus WindSpeed Anomalies",
    x = "Monthly AirTemp Anomaly", y = "Monthly WindSpeed Anomaly"
  )

# Summary Insight
paste(" Traffic sites show greater variability across quantiles, with extreme outliers at low wind speeds. Residential sites exhibit consistent trends. Westlake has fewer anomalies, while Sunnyhills East has weaker correlations and wider percentile spreads. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-airtemp-vs-winddir}
# Plot z-anomalies of weekly AirTemp versus WindDir by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AirTemp", "z_WindDir", "Weekly") +
  labs(
    title = "Weekly Relationship of AirTemp versus WindDir Anomalies",
    x = "Weekly AirTemp Anomaly", y = "Weekly WindDir Anomaly"
  )

# Summary Insight
paste(" Quantiles reveal pollutant distributions; site types shape local variability. Outliers highlight anomalies—traffic sites show extreme peaks, while residential areas exhibit smoother trends. Comparing quantiles improves understanding of spatial and temporal pollutant dynamics. ")

# Plot z-anomalies of monthly AirTemp versus WindDir by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AirTemp", "z_WindDir", "Monthly") +
  labs(
    title = "Monthly Relationship of AirTemp versus WindDir Anomalies",
    x = "Monthly AirTemp Anomaly", y = "Monthly WindDir Anomaly"
  )

# Summary Insight
paste(" Residential sites show smaller quantile spreads, while traffic sites display greater variability. Industrial locations exhibit distinct outliers. Quantiles highlight seasonal dispersion, with NES sites showing relatively stable patterns compared to traffic-related pollution spikes. ")
```

```{r plot-z-anomalies-of-weekly-and-monthly-airtemp-vs-relhum}
# Plot z-anomalies of weekly AirTemp versus RelHum by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AirTemp", "z_RelHum", "Weekly") +
  labs(
    title = "Weekly Relationship of AirTemp versus RelHum Anomalies",
    x = "Weekly AirTemp Anomaly", y = "Weekly RelHum Anomaly"
  )

# Summary Insight
paste(" Warm weather, more humidity! Clear positive trends everywhere, with some local variations in how tightly points cluster. ")

# Plot z-anomalies of monthly AirTemp versus RelHum by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_AirTemp", "z_RelHum", "Monthly") +
  labs(
    title = "Monthly Relationship of AirTemp versus RelHum Anomalies",
    x = "Monthly AirTemp Anomaly", y = "Monthly RelHum Anomaly"
  )

# Summary Insight
paste(" Air temp and humidity anomalies show strong inverse relationships across sites, with varied scatter around the LOESS trend lines. ")
```

## Weekly and monthly relationship of WindSpeed versus WindDir and RelHum

```{r plot-z-anomalies-of-weekly-and-monthly-windspeed-vs-winddir}
# Plot z-anomalies of weekly WindSpeed versus WindDir by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_WindSpeed", "z_WindDir", "Weekly") +
  labs(
    title = "Weekly Relationship of WindSpeed versus WindDir Anomalies",
    x = "Weekly WindSpeed Anomaly", y = "Weekly WindDir Anomaly"
  )

# Summary Insight
paste(" Residential sites (purple, blue, green) have tighter quantile ribbons and outliers. Traffic sites (yellow) show wider ribbons with more variability. Outliers are more frequent in all sites, indicating localized meteorological influences. ")

# Plot z-anomalies of monthly WindSpeed versus WindDir by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_WindSpeed", "z_WindDir", "Monthly") +
  labs(
    title = "Monthly Relationship of WindSpeed versus WindDir Anomalies",
    x = "Monthly WindSpeed Anomaly", y = "Monthly WindDir Anomaly"
  )

# Summary Insight
paste(" Higher wind anomalies at residential-traffic sites show wider quantile spreads. Industrial zones exhibit tighter distributions but contain extreme outliers. Residential sites display moderate variation. Outliers dominate Ellerslie South and Westlake trends. ")
```

```{r anomalies-of-weekly-and-monthly-windspeed-and-winddir-vs-relhum}
# Plot z-anomalies of weekly WindSpeed versus RelHum by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_WindSpeed", "z_RelHum", "Weekly") +
  labs(
    title = "Weekly Relationship of WindSpeed versus RelHum Anomalies",
    x = "Weekly WindSpeed Anomaly", y = "Weekly RelHum Anomaly"
  )

# Summary Insight
paste(" Most show a strong positive correlation, especially at higher wind speeds, with some sites exhibiting unique curve shapes and data point distributions. ")

# Plot z-anomalies of monthly WindSpeed versus RelHum by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_WindSpeed", "z_RelHum", "Monthly") +
  labs(
    title = "Monthly Relationship of WindSpeed versus RelHum Anomalies",
    x = "Monthly WindSpeed Anomaly", y = "Monthly RelHum Anomaly"
  )

# Summary Insight
paste(" Wind speed links to humidity shifts across sites with similar S-curve trends: low wind, variable humidity; high wind, lower humidity. ")

# Plot z-anomalies of weekly WindDir versus RelHum by site, remove sites not having data
data <- filter(weekly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_WindDir", "z_RelHum", "Weekly") +
  labs(
    title = "Weekly Relationship of WindDir versus RelHum Anomalies",
    x = "Weekly WindDir Anomaly", y = "Weekly RelHum Anomaly"
  )

# Summary Insight
paste(" Ellerslie South & Westlake show positive trends; others flat. Points clustered differently, revealing unique site-specific wind/humidity dynamics. ")

# Plot z-anomalies of monthly WindDir versus RelHum by site, remove sites not having data
data <- filter(monthly_airdata, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants_z(data, "z_WindDir", "z_RelHum", "Monthly") +
  labs(
    title = "Monthly Relationship of WindDir versus RelHum Anomalies",
    x = "Monthly WindDir Anomaly", y = "Monthly RelHum Anomaly"
  )

# Summary Insight
paste(" Looking at the plots, Westlake shows a strong positive trend. Ellerslie South and Henderson Lincoln South have slight positive trends, while Glen Eden Central and Sunnyhills East exhibit weak negative trends. Points vary across sites, indicating diverse local influences. ")
```

</details>

# Decoding Auckland's Air: Seasonal Shifts, Anomalies, and the COVID-19 Impact
Ever wondered how Auckland's air quality changes with the seasons? We dived into data from 2016-2024, analyzing pollutants like NO2 and PM2.5, alongside wind, temperature, and AQI. Our visuals highlight seasonal patterns and unusual spikes (anomalies) across monitoring sites. You'll see how factors like wind influence pollutant spread and even spot the impact of COVID-19 on our air. It's a fascinating look at our city's breathing patterns!

<details><summary>Read more...</summary>

## Seasonal Air Quality Anomaly Detection and Heatmap Visualization
This section processes daily air quality data to identify seasonal trends and anomalies across Auckland sites, using z-score categorization and heatmaps to visualize pollutant deviations by site and factor.

```{r wrangle-seasonal-concentration-data}
# Extract year (last two digits) and numeric month from the date
daily_airdata <- daily_airdata |>
  mutate(year = format(date, "%y"),
         month = as.integer(format(date, "%m")))

# Assign seasons based on month and create season-year identifier (e.g., "Wi22")
daily_airdata <- daily_airdata |>
  mutate(season = case_when(
    month %in% c(12, 1, 2) ~ "Su",
    month %in% c(3, 4, 5) ~ "Au",
    month %in% c(6, 7, 8) ~ "Wi",
    month %in% c(9, 10, 11) ~ "Sp"),
    season_year = paste0(season, year))

# Preserve chronological order of seasons for plotting
season_order <- unique(daily_airdata$season_year)

# Convert year and season_year to ordered factors
season_airdata <- daily_airdata |>
  mutate(
    year = factor(year),
    season_year = factor(season_year, levels = season_order, ordered = TRUE))

# Reshape data from wide to long format for selected variables
season_airdata_long <- season_airdata |>
  pivot_longer(
    cols = c("NO2", "NO", "PM10", "PM2.5", "SO2", "AQI", "WindSpeed", "WindDir", "AirTemp", "RelHum"),
    names_to = "variable",
    values_to = "value")

# Aggregate total concentration/values by season, site, and variable
season_airdata_long <- season_airdata_long |>
  group_by(season_year, season, year, sa2_name, site_type, variable) |>
  summarise(value = sum(value, na.rm = TRUE), .groups = "drop")

# Calculate z-scores (standardized values) for each variable across years per site
season_airdata_long <- season_airdata_long |>
  group_by(sa2_name, site_type, variable) |>
  mutate(
    z_value = (value - mean(value, na.rm = TRUE)) / sd(value, na.rm = TRUE)) |> ungroup()

# Categorize z-scores into descriptive levels
season_airdata_long <- season_airdata_long |>
  mutate(cat_z_value = case_when(
    z_value < -1 ~ "Low",
    z_value >= -1 & z_value <= 1 ~ "Normal",
    z_value > 1 ~ "High"))

# Reshape data back to wide format with original values and z-scores
season_airdata_total <- season_airdata_long |>
  pivot_wider(
    names_from = variable,
    values_from = c(value, z_value, cat_z_value))

# Rename columns: remove 'value_' prefix, replace 'z_value_' with 'z_', replace 'cat_z_value_' with 'cat_z_'
season_airdata_total <- season_airdata_total |>
  rename_with(~ gsub("^value_", "", .x), .cols = starts_with("value_")) |>
  rename_with(~ gsub("^z_value_", "z_", .x), .cols = starts_with("z_value_")) |>
  rename_with(~ gsub("^cat_z_value_", "cat_z_", .x), .cols = starts_with("cat_z_value_")) |>
  mutate(across(starts_with("cat_z_"), as.factor))

# Plot a tile map of seasonal air quality anomalies (z-score categories) by site and factor
ggplot(season_airdata_long, aes(x = season, y = variable, fill = cat_z_value)) +
  geom_tile(color = "white") +
  scale_fill_viridis_d(
    option = "mako", name = "Anomaly Level",
    na.value = "grey80", # color for NA tiles
    na.translate = TRUE, # include NA in legend
    labels = function(x) ifelse(is.na(x), "Missing", x)
    ) +
  facet_wrap(~ sa2_name) +
  labs(
    title = "Categorized Anomalies in Seasonal Air Quality",
    subtitle = "Factor Values classified by z-score deviations at multiple Auckland monitoring sites",
    x = "Season", y = "Factor", fill = "Anomaly Level") +
  theme_bw() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", size = 11),
    axis.text.y = element_text(size = 10, face = "bold"),
    axis.ticks.y = element_blank(),
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11, face = "bold"))

# Summary Insight
paste(" Seasonal air quality varies across Auckland. NO2/NO peak in winter for Henderson Lincoln South and Westlake, autumn for Puni. PM2.5 is a spring concern. Wind speed impacts dispersion, influencing regional trends. Missing data skews patterns. Relative humidity never significantly high. ")
```

## Seasonal Air Quality and Meteorological Patterns (2016–2024) with COVID-19 Impacts
This section visualizes seasonal trends in pollutants and meteorological variables across Auckland sites (2016–2024). Using faceted plots, it highlights site-type differences, seasonal patterns, and pre- vs post-COVID-19 changes (marked at "Au20"). The plot_season() function ensures consistency in style, enabling assessment of air quality trends, climatic variability, and COVID-19-related shifts in environmental conditions.

```{r func-to-visualize-seasonal-trends-in-variables}
# Plot seasonal total pollutant concentration across NZ monitoring sites (2016–2023)
plot_season <- function(data, xvar, yvar, color_var) {
  ggplot(data = data, aes(x = .data[[xvar]], y = .data[[yvar]])) +
    geom_point(aes(color = .data[[color_var]]), size = 2, alpha = 0.7) +
    geom_line(aes(group = .data[[color_var]], color = .data[[color_var]]), lwd = 1) +
    geom_vline(xintercept = which(levels(data$season_year) == "Au20"), lty = "dashed", color = "#CC79A7", lwd = 2) +
    facet_wrap(~ sa2_name, scales = "free") +
    scale_color_viridis_d(name = "Site Type", option = "D", begin = 0.1, end = 0.9) +
    theme_bw() +
    labs(
      title = paste("Seasonal Trends in ", yvar, " Across Auckland Monitoring Sites (2016-2024)"),
      subtitle = "Comparison of Pre- and Post-COVID-19 Periods with Site-Type Differentiation",
      x = "Season Year", y = paste(yvar, "(µg/m³)")
  ) +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text.x = element_text(angle = 60, hjust = 1),
      axis.text.y = element_text(size = 11, face = "bold"),
      strip.text = element_text(size = 11, face = "bold"),
      legend.position = "bottom",
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 11, face = "bold"))
}
```

```{r plot-seasonal-trends-by-pollutant-and-site, fig.width=12, fig.height=8}
# Filter common datasets
no_data <- filter(season_airdata_total, sa2_name != "Sunnyhills East")
no2_data <- no_data
pm25_data <- filter(season_airdata_total, 
                    !(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East")))
pm10_data <- season_airdata_total
so2_data <- filter(season_airdata_total, sa2_name == "Ellerslie South")
windspeed_data <- filter(season_airdata_total, !(sa2_name %in% c("Puni", "Queen Street")))
relhum_data <- windspeed_data
winddir_data <- windspeed_data
airtemp_data <- filter(season_airdata_total, sa2_name != "Puni")
aqi_data <- season_airdata_total

# === Plot: NO ===
plot_season(no_data, "season_year", "NO", "site_type")

paste(" Queen Street and Westlake show the highest NO with seasonal peaks pre-2020. Puni records the lowest. Most sites declined post-2020, reflecting reduced traffic emissions. ") 

# === Plot: NO2 ===
plot_season(no2_data, "season_year", "NO2", "site_type")

paste(" NO2 levels fell post-COVID, especially in traffic-heavy areas. Residential and mixed-use areas were more stable, indicating local variations in sources. ")

# === Plot: PM2.5 ===
plot_season(pm25_data, "season_year", "PM2.5", "site_type")

paste(" Post-2020 declines appear in Ellerslie South and Puni. Queen Street and Westlake fluctuate, likely due to local emissions or meteorology. Winter peaks remain consistent. ") 

# === Plot: PM10 ===
plot_season(pm10_data, "season_year", "PM10", "site_type")

paste(" Seasonal PM10 patterns vary; industrial zones show higher fluctuations. Some transport-adjacent sites declined post-COVID, with winter-autumn peaks prevailing. ") 

# === Plot: SO2 (Ellerslie South only) ===
plot_season(so2_data, "season_year", "SO2", "site_type")

paste(" SO2 in Ellerslie South fluctuated seasonally from 2016–2024, with a notable decline post-COVID, possibly reflecting reduced combustion activity. ") 

# === Plot: Wind Speed ===
plot_season(windspeed_data, "season_year", "WindSpeed", "site_type")

paste(" Sunnyhills East has the lowest wind speeds; Ellerslie South the highest. Post-COVID, fluctuations increased, with seasonal variability evident. ") 

# === Plot: Relative Humidity ===
plot_season(relhum_data, "season_year", "RelHum", "site_type")

paste(" Looking at the graphs, each Auckland site shows distinct seasonal trends in RelHum from 2016-2024, with varying patterns pre/post-COVID, highlighting diverse localized impacts. ") 

# === Plot: Wind Direction ===
plot_season(winddir_data, "season_year", "WindDir", "site_type")

paste(" WindDir varies by site. Glen Eden Central shows consistent patterns; Sunnyhills East fluctuates more. Subtle shifts post-COVID suggest evolving local wind behavior. ") 

# === Plot: Air Temperature ===
plot_season(airtemp_data, "season_year", "AirTemp", "site_type")

paste(" Urban traffic sites show higher summer temperatures. Residential zones have steadier seasonal trends. Minor post-COVID variation observed; warming trend persists. ") 

# === Plot: AQI ===
plot_season(aqi_data, "season_year", "AQI", "site_type") + 
  scale_y_continuous(labels = scales::scientific)

paste(" Traffic sites display persistently high AQI. Post-COVID, residential and NES zones stabilize, while industrial sites remain more variable. Seasonal peaks in winter/autumn. ") 
```

## Refining Pollutant Anomalies Across Seasons and Quantiles
Quantile rectangles reveal x-variable and y-variable distributions, highlighting seasonal shifts. Z-anomalies standardize comparisons across differing units, exposing nuanced pollutant interactions. Seasonal categories refine dispersion insights, revealing variability in correlation strength. These techniques enhance pollutant trend interpretation across diverse environmental conditions.

```{r func-to-visualize-seasonal-trends-between-pollutants}
# Plot seasonal total pollutant concentration across NZ monitoring sites (2016–2023)
plot_pollutants <- function(data, xvar, yvar, color_var) {
  # Compute 10-90% quantiles by site (facet variable)
  quantile_bands <- data |>
    group_by(sa2_name) |>
    summarise(
      q10_x = quantile(.data[[xvar]], 0.10, na.rm = TRUE),
      q90_x = quantile(.data[[xvar]], 0.90, na.rm = TRUE),
      q10_y = quantile(.data[[yvar]], 0.10, na.rm = TRUE),
      q90_y = quantile(.data[[yvar]], 0.90, na.rm = TRUE),
      .groups = "drop"
    )

  p <- ggplot(data = data, aes(x = .data[[xvar]], y = .data[[yvar]])) +
    # Vertical bands for x-variable quantiles
    geom_rect(data = quantile_bands, 
              aes(xmin = q10_x, xmax = q90_x, ymin = -Inf, ymax = Inf), fill = "#FEE08B", alpha = 0.3, inherit.aes = FALSE) +
    # Horizontal bands for y-variable quantiles
    geom_rect(data = quantile_bands,
              aes(xmin = -Inf, xmax = Inf, ymin = q10_y, ymax = q90_y), fill = "#88CCAA", alpha = 0.2, inherit.aes = FALSE) +
    geom_point(aes(color = .data[[color_var]]), size = 2.5, alpha = 0.9) +
    geom_smooth(method = "loess", se = FALSE, color = "#4D4D4D", lwd = 1, alpha = 0.8) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top") +
    facet_wrap(~ sa2_name, scales = "free") +
    scale_color_viridis_d(option = "D") +
    theme_bw() +
    labs(
      title = paste("Seasonal Co-variation of ", xvar, " and ", yvar, " Across Monitoring Sites in New Zealand (2016–2024)"), 
      subtitle = "Loess trendlines and 10–90 percentile bands reveal spatial and seasonal variability in air pollutant relationships",
      x = paste(xvar, "(µg/m³)"), y = paste(yvar, "(µg/m³)"),
      color = "Season") +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text.x = element_text(size = 12, hjust = 1, face = "bold"),
      axis.text.y = element_text(size = 12, face = "bold"),
      strip.text = element_text(size = 11, face = "bold"),
      legend.position = "bottom",
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 12, face = "bold"))
  return(p)
  }
```

## Seasonal Air Quality: PM2.5 and Pollutant Relationships
This analysis explores the complex seasonal relationships between PM2.5 and key air pollutants like NO, NO2, PM10, SO2, and the Air Quality Index (AQI) across various Auckland sites. We examine how these pollutants co-vary, highlighting winter's typical higher concentrations and site-specific patterns, giving insights into local air quality dynamics throughout the year.

```{r plot-seasonal-categories-of-pm2.5-vs-pollutants}
# Plot PM2.5 versus NO by site, remove sites not having data
data <- filter(season_airdata_total, !(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East")))

plot_pollutants(data, "PM2.5", "NO", "season")

paste(" Percentile rectangles and outliers demonstrate varying PM2.5-NO distributions across sites. Winter often shows higher concentrations and stronger correlations, likely due to heating, while summer may be lower. A general positive trend exists, but its strength and seasonal/spatial patterns differ due to unique factors. ") 

# Plot PM2.5 versus NO2 by site, remove sites not having data
data <- filter(season_airdata_total, !(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East")))

plot_pollutants(data, "PM2.5", "NO2", "season")

paste(" Ellerslie South shows strong PM2.5-NO2 co-variation (R = 0.63). Puni, Queen Street, and Westlake show weaker non-significant correlations. Outliers occur across all seasons, with winter and summer displaying higher variability. Trends are generally stable, with percentile bands capturing seasonal dispersion. ")

# Plot PM2.5 versus PM10 by site, remove sites not having data
data <- filter(season_airdata_total, !(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East")))

plot_pollutants(data, "PM2.5", "PM10", "season")

paste(" Queen Street shows the strongest significant PM2.5-PM10 correlation (R = 0.91). Ellerslie South, Puni and Westlake has moderate and weak non-significant relationships. Outliers appear in winter. Percentiles widen in summer. Trendlines indicate increased dispersion in urban sites. ")

# Plot PM2.5 versus SO2 by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name == "Ellerslie South")

plot_pollutants(data, "PM2.5", "SO2", "season")

paste(" PM2.5 and SO2 show moderate seasonal non-significant correlation (R = 0.34), with stronger co-variation in winter due to combustion sources. Loess trends highlight localized emission influences. ")

# Plot PM2.5 versus AQI by site, remove sites not having data
data <- filter(season_airdata_total, !(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East")))

plot_pollutants(data, "PM2.5", "AQI", "season") + 
  labs(y = "Air Quality Index")

# Summary Insight
paste("Queen Street shows the strongest significant PM2.5-AQI correlation (R = 0.8). Ellerslie South, Puni and Westlake has moderate and weak non-significant relationships. Outliers appear in winter and spring. Percentiles widen in summer. Trendlines indicate increased dispersion in urban sites.")
```

## Unmasking Auckland's Air: How Seasons Shape Our PM2.5 and What That Means for You
Ever wondered why Auckland's air quality feels different throughout the year? We dive into how seasonal changes influence PM2.5 pollution and explore its connections with other environmental factors, helping you breathe easier.

```{r plot-z-anomalies-of-pm2.5-vs-variables-group-by-season}
# Plot z-anomalies of PM2.5 versus z-anomalies of AQI by site, remove sites not having data
data <- filter(season_airdata_total, !(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East")))

plot_pollutants(data, "z_PM2.5", "z_AQI", "season") + 
  labs(
    title = "Seasonal Co-variation of Anomalies of PM2.5 and AQI Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM2.5 Anomalies", y = "Air Quality Index Anomalies")

paste(" PM2.5 strongly influences AQI, with higher concentrations correlating to worsening air quality. Seasonal fluctuations impact PM2.5 levels, driving AQI variability. Outliers reveal extreme pollution events. Trends indicate varied pollutant dynamics across sites. ") 

# Plot z-anomaly of PM2.5 versus z-anomaly of AirTemp by site, remove sites not having data
data <- filter(season_airdata_total, !(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East", "Puni")))

plot_pollutants(data, "z_PM2.5", "z_AirTemp", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of PM2.5 and AirTemp Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM2.5 Anomalies", y = "Air Temperature Anomalies")

paste(" Queen Street, Ellerslie South, and Westlake shows no significant correlation, suggesting local meteorological or emission influences disrupt expected temperature-pollution dynamics. ") 

# Plot z-anomaly of PM2.5 versus z-anomaly of WindSpeed by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_pollutants(data, "z_PM2.5", "z_WindSpeed", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of PM2.5 and WindSpeed Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM2.5 Anomalies", y = "Wind Speed Anomalies")

paste(" Ellerslie South shows a mild downward PM2.5 trend, with winter peaks and occasional outliers in spring. Westlake has a more stable trend, with winter spikes and a few high outliers. Seasonal variations are more pronounced at Ellerslie South, especially in colder months. ") 

# Plot z-anomaly of PM2.5 versus z-anomaly of WindDir by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_pollutants(data, "z_PM2.5", "z_WindDir", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of PM2.5 and WindDir Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM2.5 Anomalies", y = "Wind Direction Anomalies")

paste(" Ellerslie South has more extreme wind anomalies. Both sites show a positive PM2.5 non-significant correlation. Winter data is widely scattered, while summer points scatter in middle 80% of data. ") 

# Plot z-anomaly of PM2.5 versus z-anomaly of RelHum by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name %in% c("Ellerslie South", "Westlake"))

plot_pollutants(data, "z_PM2.5", "z_RelHum", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of PM2.5 and RelHum Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM2.5 Anomalies", y = "Relative Humidity Anomalies")

paste(" Ellerslie South vs. Westlake: Both show humidity dips with lower PM2.5, but Westlake has a stronger correlation! ") 
```

## Unpacking New Zealand's Air Quality: A Deep Dive into PM10 and Its Influencers
This analysis explores PM10 dynamics across NZ, examining its relationship with pollutants and weather (2016-2024). We uncover seasonal trends, site variations, and anomalies, offering critical insights into local air quality challenges and their drivers.

```{r plot-season-pm10-vs-pollutants-aqi-weather}
# Plot PM10 versus NO by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants(data, "PM10", "NO", "season")

# Summary Insight
paste("Quantiles highlight seasonal PM10 and NO variability, with winter peaks across sites. Westlake shows moderate significant positive correlation and the rest shows no relation. Outliers are present in all seasons, notably high NO levels at Ellerslie South and Westlake, and elevated PM10 at Queen Street, indicating localized emissions or meteorological influences.")

# Plot PM10 versus NO2 by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Sunnyhills East"))

plot_pollutants(data, "PM10", "NO2", "season")

# Summary Insight
paste(" Westlake shows significant positive correlation while the rest shows no relation. Queen Street shows the highest NO2 levels. Outliers deviates from expected seasonal trends, suggesting local meteorological or emission influences disrupting pollutant relationships. Variability across sites highlights dispersion and emission dynamics. ")

# Plot PM10 versus PM2.5 by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Sunnyhills East", "Glen Eden Central", "Henderson Lincoln South"))

plot_pollutants(data, "PM10", "PM2.5", "season")

# Summary Insight
paste("Queen Street shows the strongest significant PM10-PM2.5 correlation (R = 0.91), with minimal outliers. Ellerslie South has wider quantile spread. Puni and Westlake shows scattered outliers, indicating site-specific influences.")

# Plot PM10 versus SO2 by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name == "Ellerslie South")

plot_pollutants(data, "PM10", "SO2", "season")

# Summary Insight
paste("The plot highlights pollutant dispersion, seasonal variability, and extreme deviations. Outliers suggest localized influences, while quantile bands indicate distribution consistency.")

# Plot PM10 versus AQI by site, remove sites not having data
data <- season_airdata_total

plot_pollutants(data, "PM10", "AQI", "season") +
  labs(y = "Air Quality Index")

# Summary Insight
paste("Quantiles differ across sites, with Queen Street showing higher AQI values. Outliers are prominent in winter, indicating seasonal variability. Moderate correlations (R = 0.39–0.61, p < 0.05) suggest site-specific pollutant interactions.")

# Plot z-anomaly of PM10 versus z-anomaly of AQI by site, remove sites not having data
data <- season_airdata_total

plot_pollutants(data, "z_PM10", "z_AQI", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of PM10 and AQI Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM10 Anomalies", y = "Air Quality Index Anomalies")

# Summary Insight
paste("10-90 percentile bands show seasonal co-variation. Outliers, points beyond these bands, highlight extreme pollutant events. Glen Eden Central exhibits more outliers, suggesting localized influences, while Queen Street’s tighter spread shows stronger pollutant correlation and fewer anomalies.")

# Plot z-anomaly of PM10 versus z-anomaly of AirTemp by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name != "Puni")

plot_pollutants(data, "z_PM10", "z_AirTemp", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of PM10 and AirTemp Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM10 Anomalies", y = "Air Temperature Anomalies")

# Summary Insight
paste("Quantiles, shown as shaded 10-90 percentile bands, highlight central pollutant trends across seasons. Outliers fall outside these bands, revealing extreme anomalies. All sites show no relationship at 0.001 significance.")

# Plot z-anomaly of PM10 versus z-anomaly of WindSpeed by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants(data, "z_PM10", "z_WindSpeed", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of PM10 and WindSpeed Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM10 Anomalies", y = "Wind Speed Anomalies")

# Summary Insight
paste("Quantiles highlight seasonal PM10-wind speed trends; 10-90 percentile bands show typical variability. Outliers exist beyond these bands, indicating unusual pollutant dynamics or meteorological influences. Weak non-significant correlations across sites suggest site-specific factors drive fluctuations rather than broad co-variation trends.")

# Plot z-anomaly of PM10 versus z-anomaly of RelHum by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants(data, "z_PM10", "z_RelHum", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of PM10 and RelHum Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM10 Anomalies", y = "Relative Humidity Anomalies")

# Summary Insight
paste("NZ air quality data shows varied PM10-humidity trends across sites, with some clear seasonal patterns and others less defined.")

# Plot z-anomaly of PM10 versus z-anomaly of WindDir by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Puni", "Queen Street"))

plot_pollutants(data, "z_PM10", "z_WindDir", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of PM10 and WindDir Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "PM10 Anomalies", y = "Wind Direction Anomalies")

# Summary Insight
paste("The plot’s 10-90 percentile bands highlight seasonal PM10 and wind direction patterns. Outliers exceed these bands, showing extreme variations. PM10 dispersion increases with wind shifts, driven by site-specific factors. Most data clusters within the middle 80%, with non-significant correlations indicating no clear relationship.")
```

## How Seasonal Changes Shape NO Pollution and Its Environmental Links
Explore how NO pollution varies across Auckland’s seasons, revealing dynamic relationships with co-pollutants and weather patterns like temperature, wind, and humidity from 2016–2024.

```{r seasonal-no-correlations-vs-pollutants-weather}
# Plot NO versus NO2 by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name != "Sunnyhills East")

plot_pollutants(data, "NO", "NO2", "season")

# Summary Insight
paste(" Queen Street shows the strongest NO-NO2 correlation (R = 0.93). Summer typically has lower NO2 across sites. Outliers mostly appear in winter, summer, and spring. Puni exhibits weaker correlations. ")

# Plot NO versus SO2 by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name == "Ellerslie South")

plot_pollutants(data, "NO", "SO2", "season")

# Summary Insight
paste(" Outliers are mostly in spring and winter and quantiles show higher SO2, lower in spring and summer. NO trends follow. ")

# Plot NO versus AQI by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name != "Sunnyhills East")

plot_pollutants(data, "NO", "AQI", "season")

# Summary Insight
paste(" All sites show summer-Autumn-Winter outliers; Puni sees Autumn extremes. Loess trends indicate variable NO-AQI relationships, with 10-90 percentile bands capturing seasonal dispersion patterns across sites. Correlation strength varies with only Queen Street showing significance. ")

# Plot z-anomaly of NO versus z-anomaly of AQI by site, remove sites not having data
data <- filter(season_airdata_total, sa2_name != "Sunnyhills East")

plot_pollutants(data, "z_NO", "z_AQI", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO and AQI Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "NO Anomalies", y = "Air Quality Index Anomalies")

# Summary Insight
paste(" High NO anomalies in Puni and displays inverse trends. Outliers cluster in high AQI events, mostly during colder months. ")

# Plot z-anomaly of NO versus z-anomaly of AirTemp by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Puni", "Sunnyhills East"))

plot_pollutants(data, "z_NO", "z_AirTemp", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO and AirTemp Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "NO Anomalies", y = "Air Temperature Anomalies")

# Summary Insight
paste(" The 10–90% quantile bands align well with seasonal clustering—Winter (Wi) and Autumn (Au) dominate lower NO anomalies, while Summer (Su) outliers extend beyond the upper quantile, indicating potential emission spikes or meteorological influences during warmer periods. ")

# Plot z-anomaly of NO versus z-anomaly of WindSpeed by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants(data, "z_NO", "z_WindSpeed", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO and WindSpeed Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "NO Anomalies", y = "Wind Speed Anomalies")

# Summary Insight
paste(" In all sites, most seasonal anomalies cluster within the 10–90% quantile bands, highlighting typical variability. Winter and spring often shows outliers with higher NO anomalies, especially in Ellerslie South, Westlake, and Glen Eden Central. Summer outliers exhibit lower NO, in all sites. ")

# Plot z-anomaly of NO versus z-anomaly of WindDir by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants(data, "z_NO", "z_WindDir", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO and WindDir Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "NO Anomalies", y = "Wind Direction Anomalies")

# Summary Insight
paste(" Winter and spring show broader NO anomaly distributions with more outliers, in all sites. Winter dominate higher quantiles in Westlake, suggesting seasonal shifts in pollutant-wind relationships. ")

# Plot z-anomaly of NO versus z-anomaly of RelHum by site, remove sites not having data
data <- filter(season_airdata_total, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))

plot_pollutants(data, "z_NO", "z_RelHum", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO and RelHum Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "NO Anomalies", y = "Relative Humidity Anomalies")

# Summary Insight
paste(" In four NZ sites, NO and Relative Humidity anomalies show varying seasonal relationships, from strong (Ellerslie) to weaker (Glen Eden), highlighted by loess trends and clustered points. ")
```

## Unpacking NO2: Seasonal Dance with Air Quality and Weather
Explore how NO2 levels fluctuate with air quality and meteorological factors across New Zealand, revealing distinct seasonal patterns and key insights.

```{r seasonality-and-co-variation-of-no2-with-air-quality-and-weather}
# Filter shared base data
base_data <- season_airdata_total

# 1. NO2 vs AQI (raw values)
data1 <- filter(base_data, sa2_name != "Sunnyhills East")
p1 <- plot_pollutants(data1, "NO2", "AQI", "season") +
  labs(y = "Air Quality Index (AQI)")
print(p1)

# Summary Insight
paste(" Quantiles reveal seasonal NO₂–AQI variability across sites. Outliers are frequent, with autumn and winter showing extreme AQI spikes. ")

# 2. z(NO2) vs z(AQI)
data2 <- filter(base_data, sa2_name != "Sunnyhills East")
p2 <- plot_pollutants(data2, "z_NO2", "z_AQI", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO₂ and AQI Across Monitoring Sites in New Zealand (2016–2024)", 
    x = "NO2 Anomalies", y = "AQI Anomalies")
print(p2)

# Summary Insight
paste(" NO2 anomalies show strong urban correlations (e.g., Queen Street). Winter has highest deviations; outliers cluster in transitional seasons. ")

# 3. z(NO2) vs z(AirTemp)
data3 <- filter(base_data, !sa2_name %in% c("Puni", "Sunnyhills East"))
p3 <- plot_pollutants(data3, "z_NO2", "z_AirTemp", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO₂ and Air Temperature", 
    x = "NO2 Anomalies", y = "Air Temperature Anomalies")
print(p3)

# Summary Insight
paste(" Tighter quantile spreads in summer suggest stable NO2–temperature relationships; broader spreads in winter reflect stagnant conditions. ")

# 4. z(NO2) vs z(WindSpeed)
data4 <- filter(base_data, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))
p4 <- plot_pollutants(data4, "z_NO2", "z_WindSpeed", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO2 and Wind Speed", 
    x = "NO2 Anomalies", y = "Wind Speed Anomalies")
print(p4)

# Summary Insight
paste(" Wind speed impacts dispersion: summer dilutes pollutants, while winter retains them. Wider quantile bands indicate episodic extremes. ")

# 5. z(NO2) vs z(WindDir)
data5 <- filter(base_data, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))
p5 <- plot_pollutants(data5, "z_NO2", "z_WindDir", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO2 and Wind Direction", 
    x = "NO2 Anomalies", y = "Wind Direction Anomalies")
print(p5)

# Summary Insight
paste(" Wind direction shows weak overall correlation with NO2, except in Westlake. Seasonal cycles shape dispersion, especially in winter and spring. ")

# 6. z(NO2) vs z(RelHum)
data6 <- filter(base_data, !sa2_name %in% c("Puni", "Queen Street", "Sunnyhills East"))
p6 <- plot_pollutants(data6, "z_NO2", "z_RelHum", "season") +
  labs(
    title = "Seasonal Co-variation of Anomalies of NO2 and Relative Humidty", 
    x = "NO2 Anomalies", y = "Relative Humidity Anomalies")
print(p6)

# Summary Insight
paste(" Trends vary, points show seasonal clusters and spread, particularly at anomaly extremes. ")
```

## Decoding Ellerslie South's Seasonal SO2 Shifts
Uncover how SO2 anomalies in Ellerslie South dance with environmental factors like air quality, temperature, and wind speed/direction across seasons, revealing fascinating insights into pollutant behavior from 2016-2024.

```{r seasonal_so2_analysis}
# Use a consistent dataset: Ellerslie South
data <- filter(season_airdata_total, sa2_name == "Ellerslie South")

# 1. SO2 vs AQI
p1 <- plot_pollutants(data, "z_SO2", "z_AQI", "season") +
  labs(
    title = "SO2 vs AQI Anomalies (2016–2024)",
    x = "SO2 Anomalies", y = "Air Quality Index Anomalies")
print(p1)

paste(" Winter outliers skew SO2–AQI correlation. Summer shows stable trends. Median SO2 anomaly aligns with AQI variability. Quantiles reveal seasonal dispersion. ") 

# 2. SO2 vs Air Temperature
p2 <- plot_pollutants(data, "z_SO2", "z_AirTemp", "season") +
  labs(
    title = "SO2 vs Air Temperature Anomalies (2016–2024)",
    x = "SO2 Anomalies", y = "Air Temperature Anomalies")
print(p2)

paste(" Quantiles reveal seasonal pollutant variability. Summer and spring show lower SO2 dispersion. Outliers persist across seasons, indicating irregular temperature effects. ") 

# 3. SO2 vs Wind Speed
p3 <- plot_pollutants(data, "z_SO2", "z_WindSpeed", "season") +
  labs(
    title = "SO2 vs Wind Speed Anomalies (2016–2024)",
    x = "SO2 Anomalies", y = "Wind Speed Anomalies")
print(p3)

paste(" Autumn shows more consistent behavior. Spring, winter, and summer display outlier-heavy quantiles, indicating seasonal variability in dispersion mechanisms. ") 

# 4. SO2 vs Wind Direction
p4 <- plot_pollutants(data, "z_SO2", "z_WindDir", "season") +
  labs(
    title = "SO2 vs Wind Direction Anomalies (2016–2024)",
    x = "SO2 Anomalies", y = "Wind Direction Anomalies")
print(p4)

paste(" Spring and summer exhibit more outliers; autumn and winter show tighter quantile bands. Seasonal cycles appear to shape SO2–wind direction interaction. ")

# 5. SO2 vs Relative Humidity
p5 <- plot_pollutants(data, "z_SO2", "z_RelHum", "season") +
  labs(
    title = "SO2 vs Relative Humidity Anomalies (2016–2024)",
    x = "SO2 Anomalies", y = "Relative Humidity Anomalies")
print(p5)

paste(" Trends show general direction; points are specific data instances. ")
```

## Unpacking Seasonal Meteorological Anomalies: A Data Dive
Explore how air temperature, wind, and humidity anomalies co-vary across seasons in Auckland (2016-2024), revealing distinct patterns and site-specific influences.

```{r seasonal-anomaly-covariation-meteorological-pairs}
# Filter out sites with insufficient data
data <- filter(season_airdata_total, !sa2_name %in% c("Puni", "Queen Street"))

# 1. AirTemp vs WindSpeed
p1 <- plot_pollutants(data, "z_AirTemp", "z_WindSpeed", "season") +
  labs(
    title = "AirTemp vs WindSpeed Anomalies (2016–2024)",
    x = "Air Temperature Anomalies", y = "Wind Speed Anomalies")
print(p1)

paste(" In all sites, 10–90 percentile bands show seasonal variability, with higher dispersion in winter. Outliers cluster in summer, linked to peak wind events. Ellerslie South and Glen Eden Central show strong seasonal co-variation, while Westlake exhibits consistent percentile spread across seasons. ") 

# 2. AirTemp vs WindDir
p2 <- plot_pollutants(data, "z_AirTemp", "z_WindDir", "season") +
  labs(
    title = "AirTemp vs WindDir Anomalies (2016–2024)",
    x = "Air Temperature Anomalies", y = "Wind Direction Anomalies")
print(p2)

paste(" Quantiles highlight pollutant distribution shifts across seasons—winter shows broader variability, summer has tighter ranges. Outliers reveal extreme deviations from seasonal trends, often linked to meteorological or localized emissions. Percentile bands capture season-specific dispersion, enhancing interpretation of pollutant anomalies and site-specific influences. ") 

# 3. WindSpeed vs WindDir
p3 <- plot_pollutants(data, "z_WindSpeed", "z_WindDir", "season") +
  labs(
    title = "WindSpeed vs WindDir Anomalies (2016–2024)",
    x = "Wind Speed Anomalies", y = "Wind Direction Anomalies")
print(p3)

paste(" Quantiles shift across seasons, with wider dispersion in summer and tighter clustering in winter. Outliers appear in all sites, indicating localized influences. Seasonal variations affect pollutant trends, emphasizing meteorological and site-specific emissions. ")

# 4. AirTemp vs RelHum
p4 <- plot_pollutants(data, "z_AirTemp", "z_RelHum", "season") +
  labs(
    title = "AirTemp vs RelHum Anomalies (2016–2024)",
    x = "Air Temperature Anomalies", y = "Relative Humidity Anomalies")
print(p4)

paste(" This chart shows that generally, as air temperature increases, relative humidity decreases across all locations and seasons, with strong correlations observed. Clusters of Winter and Spring points are observed. ")

# 5. WindSpeed vs RelHum
p5 <- plot_pollutants(data, "z_WindSpeed", "z_RelHum", "season") +
  labs(
    title = "WindSpeed vs RelHum Anomalies (2016–2024)",
    x = "Wind Speed Anomalies", y = "Relative Humidity Anomalies")
print(p5)

paste(" Quantiles highlight varied regimes; scattered points show seasonal variability, while loess trends reveal dynamic, site-specific relationships between wind and humidity. ")

# 6. WindDir vs RelHum
p6 <- plot_pollutants(data, "z_WindDir", "z_RelHum", "season") +
  labs(
    title = "WindDir vs RelHum Anomalies (2016–2024)",
    x = "Wind Direction Anomalies", y = "Relative Humidity Anomalies")
print(p6)

paste(" Across Auckland, most sites show weak, non-linear relationships between wind direction and relative humidity anomalies, with considerable seasonal variability. Westlake stands out with a stronger, positive correlation. ")
```
</details>

# Mapping Auckland's Pulse: Traffic and Air Quality Insights
Dive into our process of transforming raw traffic counts and air quality readings into insightful maps of Auckland! We meticulously loaded, cleaned, and spatially merged vehicle data with monitoring site locations. By aligning timeframes and converting everything into spatial objects, we created a comprehensive visualization. The result? A clear, captivating map revealing average pollutant concentrations and traffic volumes across Auckland's key areas, offering a unique glimpse into the city's dynamic environment.

<details><summary>Read more...</summary>

## Unpacking Auckland's Traffic: Filtering and Cleaning Data
Here, I am loading and refining a massive traffic dataset, specifically zeroing in on Auckland's traffic counts. I am also cleaning and simplifying the data by removing unnecessary columns and preparing it for further analysis, likely spatial joining with air quality data.

```{r load-and inspect-traffic-dataset}
# Read traffic file
traffic <- read.csv("data/traffic/TMS_traffic_counts/TMS_traffic_counts.csv") |>
  filter(regionName == "02 - Auckland")

# Preview data structure
glimpse(traffic)

paste(" There are 1,315,767 observations of 9 feature variables of startDate, regionName, siteReference, classWeight, siteDescription of data type character, siteID, laneNumber, flowDirection of data type integer and trafficCount of data type numeric. ")

# Clean names using janitor 
traffic <- traffic |>
  clean_names()

# Preview column names of traffic
colnames(traffic)

# Remove region_name, lane_number, flow_direction, site_description
traffic <- traffic |>
  select(-region_name, -lane_number, -flow_direction, -site_description)

# Check the data range covered by traffic dataset
range(traffic$start_date)

paste(" Range of the date for traffic data is from 01/01/2018 to 31/07/2023, this helps to reduce the airdata set to match these dates before performing the spatial join. ")

# Count distinct site_reference and site_description
n_distinct(traffic$site_reference)
```

## Loading Auckland State Highway Traffic Data
I am loading state highway traffic monitoring site data, then filtering it to focus specifically on Auckland and selecting key site information.

```{r read-auckland-traffic-monitoring-sites}
# Replace with your actual file path
shapefile_path <- "data/traffic/State_highway_traffic_monitoring_sites/State_highway_traffic_monitoring_sites.shp"

# Read the shapefile into an sf object
traffic_sites <- st_read(shapefile_path) |>
  filter(region == "02 - Auckland")

glimpse(traffic_sites)

# Select site reference and geometry
traffic_sites <- traffic_sites |>
  select(siteref, geometry)

colnames(traffic_sites)
```

## Merging Traffic and Air Quality Data in Space and Time
In this step, we enrich Auckland’s daily traffic counts by joining them with site metadata, enabling spatial context. After cleaning date formats and resolving anomalies, the dataset is converted to a spatial object, preparing it for seamless integration with air quality data.

```{r traffic-left-join-traffic-sites-and-convert-to-sf-object}
# Merge traffic data with site metadata
traffic <- traffic |>
  left_join(traffic_sites, by = c("site_reference" = "siteref"))

# Examine structure of merged dataset
skim(traffic)

paste(" The resulting dataset contains over 1.3 million observations with 6 columns. It includes no missing values and contains mostly complete and unique site identifiers. ") 

# Drop duplicate site ID
traffic <- traffic |>
  select(-site_id)

# Convert start_date to proper Date format
traffic <- traffic |>
  mutate(date = dmy(start_date))

# Check date anomalies
range(traffic$start_date)
range(traffic$date)

# Check unique max dates
max(traffic$start_date)  # Still character
max(traffic$date)        # Actual Date object

# Inspect entries with dates beyond expected range
traffic |> 
  filter(date > as.Date("2022-12-31")) |> 
  count(date, start_date) |> 
  arrange(desc(start_date)) |>
  glimpse()

# Some start_date values were non-standard but parsed correctly. 246 records extended into 2023.

# Convert traffic dataset into an sf object for spatial operations
traffic <- st_as_sf(traffic)
```

## Aligning Datasets in Space and Time
To ensure accurate comparisons, we synchronized traffic and air quality datasets by aligning date ranges and coordinate systems. We then aggregated site-level averages and mapped pollutant concentrations and traffic intensity across Auckland using spatial joins and geofacets.

```{r align-date-and-crs-for-airdata-and-traffic-and-aggregate}
# Check date range alignment
range(merged_airdata$date) == range(traffic$date)

# Convert airdata to sf object
filtered_airdata <- st_as_sf(merged_airdata)
if (st_crs(filtered_airdata) != st_crs(traffic)) {
  traffic <- st_transform(traffic, crs = st_crs(filtered_airdata))
}

# Aggregate average concentration per site
airdata_grouped <- filtered_airdata |>
  pivot_longer(cols = c(NO, NO2, PM10, PM2.5, SO2),
               names_to = "pollutant",
               values_to = "concentration") |>
  group_by(sa2_name, geometry) |>
  summarize(avg_conc = mean(concentration,  na.rm = TRUE),
            .groups = "drop")

# Aggregate average traffic per location
filtered_traffic <- traffic |>
  group_by(geometry) |>
  summarize(
    avg_traffic = mean(traffic_count, na.rm = TRUE),
    .groups = "drop")

# Generate spatial map of monitoring sites and traffic
plot_sensor <- ggplot() +
  geom_sf(data = sa2_nz, fill = "grey95", color = "grey40") +
  geom_sf(data= filtered_traffic, aes(color = avg_traffic)) + # traffic data points 
  geom_sf(data = airdata_grouped, aes(fill = avg_conc), size = 4) + # airdata points
  geom_sf_text(
    data = airdata_grouped, aes(label = sa2_name),
    size = 5, vjust = 0.2,
    position = position_jitter(width = 0.001, height = 0.03),
    max.overlaps = Inf) +
  coord_sf(xlim = c(174.4, 175.2), ylim = c(-37.25, -36.7), expand = FALSE) +
  scale_color_viridis_c(option = "plasma", name = "Traffic Count", trans = "log10") +
  scale_fill_viridis_c(option = "G", name = "Avg. conc. (µg/m³)") +
  theme_bw() + 
  labs(
    title = "Sensor Locations and Air Quality Patterns Across Auckland",
    subtitle = "SA2-level pollutant concentrations and traffic volumes (2016–2024) with labeled monitoring sites",
    x = "Longitude", y = "Latitude") +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
    axis.text.y = element_text(face = "bold")) +
  annotation_scale(location = "br", width_hint = 0.3) +  # Adds scale bar
  annotation_north_arrow(location = "tl", which_north = "true", style = north_arrow_fancy_orienteering())

plot_sensor

paste(" The map displays sensor locations by SA2 area with color-coded concentrations and traffic volumes, offering a clear overview of spatial environmental dynamics in Auckland. ")

# Free RAM
rm(merged_airdata)
gc() # Force garbage collection
```
</details>

# Unpacking Auckland's Traffic and Air Quality: A Data Journey
Ever wondered how Auckland's traffic flows, and how it impacts our air? We've crunched years of traffic data, spatially linking it to local SA2 areas and revealing trends from 2018-2023 – including those curious dips during COVID-19 lockdowns! Plus, we've aligned this with air quality data. This allows us to explore the fascinating connections between vehicle movements and the air we breathe, bringing powerful insights to light.

<details><summary>Read more...</summary>

## Spatial Linking of Traffic Data to SA2 Areas & Temporal Analysis of Traffic Volume (2018–2023)
This analysis links Auckland traffic counts to SA2 geographic zones within 1 km, then visualizes daily light and heavy vehicle volumes across selected areas. It reveals traffic patterns and sharp declines during COVID-19 lockdowns in 2020 and 2021.

```{r join-traffic-sa2-and-plot-sa2-traffic-trends-and-lockdown}
# Ensure 'traffic' and 'sa2_nz' datasets have matching CRS before spatial operations
if (st_crs(sa2_nz) != st_crs(traffic)) {
  traffic <- st_transform(traffic, crs = st_crs(sa2_nz))
}

# Confirm EPSG codes for both layers
st_crs(traffic)$epsg
st_crs(sa2_nz)$epsg

# Perform a spatial join: link each traffic point to the nearest SA2 polygon within 1000 meters
distance_threshold <- 1000  # Distance in meters

# Perform the distance-based join
traffic_with_sa2 <- st_join(
  traffic,
  sa2_nz,
  join = function(x, y) st_is_within_distance(x, y, dist = distance_threshold),
  left = TRUE
)

# Preview SA2 names attached to traffic points
glimpse(traffic_with_sa2$sa2_name)

# Free RAM
rm(traffic)
gc() # Force garbage collection

# Set seed to make random sampling reproducible
set.seed(123)
  
# Randomly select 10 SA2 areas for visualization
sample_sa2 <-
    sample(unique(traffic_with_sa2$sa2_name), 10)
  
# Filter traffic data to the selected SA2s and create a composite group for faceting
sampled_traffic <- traffic_with_sa2 |>
  filter(sa2_name %in% sample_sa2) |>
  mutate(sa2_class = paste0(sa2_name, "_", class_weight))

# Define dates for New Zealand's Level 4 COVID-19 lockdowns
lockdown_dates <- as.Date(c(
  "2020-03-25", # First national Level 4
  "2021-08-17" # Second large Level 4
))

# Plot log-scaled daily traffic counts (Heavy vs Light) by SA2 area, highlighting COVID-19 lockdowns
plot_daily_traffic <- ggplot(data = sampled_traffic, aes(x = date, y = traffic_count)) +
  geom_jitter(aes(color = class_weight)) +
  facet_wrap(~ sa2_name, scales = "free_y") +
  scale_color_manual(values = setNames(brewer.pal(n = 2, name = "Dark2"), c("Heavy", "Light"))) +
  scale_x_date(
    breaks = seq(as.Date("2018-01-01"), as.Date("2023-12-31"), by = "6 months"),
    date_labels = "%b %y") +
    scale_y_log10(labels = scales::label_scientific()) +
    labs(
      title = "Traffic Volume Trends by Vehicle Class in Auckland SA2s (2018–2023)",
      subtitle = "Daily vehicle counts (log-scaled) for heavy and light vehicles across key sites, with COVID-19 lockdown periods (black dashed line)",
      x = "Date", y = "Daily Vehicle Count (log scale)",
      color = "Class Weight") +
  geom_vline(
    xintercept = lockdown_dates, linetype = "dashed", 
    color = "#000000", size = 1.2) +
  theme(
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust =1),
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11, face = "bold"))

# Display the traffic trend plot
plot_daily_traffic

# Free RAM
rm(sampled_traffic)
gc() # Force garbage collection

# Summary Insight
paste("The plots show consistently higher light vehicle counts across all sites. Heavy traffic volumes vary more, especially in sites like Penrose and Mount Wellington West. COVID-19 lockdowns triggered sharp drops in traffic, most noticeably in Silverdale and Waihoukou Valley.")
```

## Aligning Traffic and Air Quality Data for Spatial Integration

To integrate air pollution and traffic datasets, I filtered and harmonized their spatial identifiers (sa2_name) and aggregated values daily. This preparation enables meaningful spatial joins and comparative visualisations across selected Auckland suburbs, strengthening environmental pattern analyses.

```{r clean-align-traffic-airdata}
# Count number of records in traffic dataset for selected SA2 suburbs
traffic_with_sa2 |>
  filter(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East", "Puni", "Ellerslie South", "Queen Street", "Westlake")) |>
  count(sa2_name)

# Check if "Patumahoe" is already present in the traffic dataset
traffic_with_sa2 |>
  filter(sa2_name == "Patumahoe") |>
  count(sa2_name)

# Rename "Puni" to "Patumahoe" in the air quality dataset (they are geographically close)
filtered_airdata <- filtered_airdata |>
  mutate(sa2_name = ifelse(sa2_name == "Puni", "Patumahoe", sa2_name))

# Select relevant columns for traffic analysis, including geometry
filtered_traffic <- traffic_with_sa2 |>
  select(date, sa2_name, class_weight, traffic_count, pop2018, geometry)

# Display all unique SA2 names in the air quality dataset
unique(filtered_airdata$sa2_name)

# Filter traffic data to retain only SA2 regions present in the air quality dataset
filtered_traffic <- filtered_traffic |>
  filter(sa2_name %in% c("Glen Eden Central", "Henderson Lincoln South", "Sunnyhills East", "Patumahoe", "Ellerslie South", "Queen Street", "Westlake"))

# Display unique SA2 names in the filtered traffic dataset
unique(filtered_traffic$sa2_name)

# Free RAM
rm(traffic_with_sa2)
gc() # Force garbage collection
```

## Aggregating and Mapping Daily Traffic Counts to SA2 Areas
This step sums daily traffic by vehicle class and SA2, resolves duplicate geometries by merging, and links aggregated counts with spatial centroids, creating a clean, mapped dataset for further spatial analysis.

```{r aggregate-for-daily-traffic-and-link-with-centroids}
# Aggregate daily traffic counts for each SA2 
daily_traffic <- st_drop_geometry(filtered_traffic) |>
  group_by(date, sa2_name, class_weight, pop2018) |>
  summarise(traffic_count = sum(traffic_count, na.rm = TRUE),
            .groups = "drop")

# Preview the aggregated dataset
glimpse(daily_traffic)

# Extract distinct SA2 names and geometry for spatial referencing
traffic_geom <- filtered_traffic |>
  count(sa2_name, geometry) |> select(-n)

# Check for duplicate SA2 names in the extracted geometry dataset
st_drop_geometry(traffic_geom) |> count(sa2_name) |> filter(n > 1)

# Duplicates exist, merge multiple geometries within the same SA2 region
traffic_geom <- traffic_geom |>
  group_by(sa2_name) |>
  summarise(geometry = st_centroid(st_union(geometry)),
            .groups = "drop")

# Confirm unique SA2 names after geometry merging
traffic_geom |> count(sa2_name, geometry)

# Left join daily traffic data with spatial geometry to ensure correct mapping
daily_traffic <- left_join(daily_traffic, traffic_geom, by = "sa2_name")

# Convert the dataset to an `sf` object for spatial operations
daily_traffic <- st_as_sf(daily_traffic)

# Free RAM
rm(filtered_traffic)
gc() # Force garbage collection
```

## Cleaning and Combining Air Quality Data for Selected Suburbs
Here, we summarize daily air quality measures for key Auckland suburbs, prepare the data for spatial analysis, and carefully check population and location details to ensure everything aligns correctly for accurate insights.

```{r aggregate-and-validate-airdata}
# Aggregate air quality metrics by site type, SA2 name, and date
daily_airdata <- st_drop_geometry(filtered_airdata) |>
  filter(sa2_name %in% c("Westlake", "Queen Street", "Ellerslie South", "Patumahoe")) |>
  group_by(date, site_type, sa2_name, pop2018) |>
  summarise(
    AQI = mean(AQI, na.rm = TRUE), 
    NO2 = mean(NO2, na.rm = TRUE), 
    NO = mean(NO, na.rm = TRUE), 
    PM10 = mean(PM10, na.rm = TRUE), 
    PM2.5 = mean(PM2.5, na.rm = TRUE),
    SO2 = mean(SO2, na.rm = TRUE),
    AirTemp = mean(AirTemp, na.rm = TRUE),
    WindSpeed = mean(WindSpeed, na.rm = TRUE),
    WindDir = mean(WindDir, na.rm = TRUE),
    RelHum = mean(RelHum, na.rm = TRUE),
    .groups = "drop")

# Extract distinct SA2 names and geometry for spatial referencing
airdata_geom <- filtered_airdata |>
  count(sa2_name, site_type, geometry) |> select(-n)

# Confirm unique SA2 names after geometry merging
airdata_geom |> count(sa2_name, site_type, geometry)

# Left join daily airdata with spatial geometry to ensure correct mapping
daily_airdata <- left_join(daily_airdata, airdata_geom, by = c("sa2_name", "site_type"))

# Convert to sf object for spatial analysis
daily_airdata <- st_as_sf(daily_airdata)

# Confirm included suburbs
unique(daily_airdata$sa2_name)

# Check pop2018 for Patumahoe (note: originally Puni, values are valid for Patumahoe)
daily_airdata |> 
  count(sa2_name, geometry, pop2018)

# Remove pop2018 since it's invalid for one site
daily_airdata <- daily_airdata |> select(-pop2018)

# Validate traffic data geometry and population count
daily_traffic |> 
  count(sa2_name, geometry, pop2018)
```
</details>

# Auckland's Air: Unpacking Traffic and Pollution Trends (2016-2024)
Ever wondered how Auckland's traffic impacts our air? We've crunched the numbers! This blog explores annual and seasonal air quality and traffic data across Auckland's suburbs. From static maps revealing pollutant hotspots and traffic flow to an interactive tool showcasing seasonal changes, we dive into the urban-rural air quality gradient. Discover how vehicle emissions, weather, and location shape the air you breathe.

<details><summary>Read more...</summary>

## Exploring Yearly Traffic and Air Quality Trends Across Auckland Suburbs (2016–2024)
This analysis calculates annual averages of traffic volumes and air pollution levels by neighborhood. Using detailed maps, it reveals how vehicle activity and key pollutants like NO2, PM2.5, and SO2 vary across Auckland’s suburbs over time, highlighting spatial patterns and temporal shifts.

```{r aggregate-traffic-by-year-and-reattach-geometry}
# Drop geometry and aggregate traffic
temp_daily_traffic <- st_drop_geometry(daily_traffic) |>
  mutate(year = format(date, "%Y")) |>
  group_by(year, sa2_name, class_weight) |>
  summarize(traffic_count = mean(traffic_count, na.rm = TRUE), .groups = "drop") |>
  pivot_wider(names_from = class_weight, 
              values_from = traffic_count)

# Extract one geometry per SA2
sa2_geoms <- daily_traffic |>
  group_by(sa2_name) |>
  slice(1) |>
  select(sa2_name)

# Join geometry back to the temp_daily_traffic
temp_daily_traffic <- left_join(temp_daily_traffic, sa2_geoms, by = "sa2_name") |>
  st_as_sf()
```

```{r summarize-airdata-by-year-and-reattach-geometry}
# Drop geometry before pivoting daily_airdata
temp_daily_airdata <- st_drop_geometry(daily_airdata) |>
  pivot_longer(cols = c(NO2, NO, PM2.5, PM10, SO2, AQI, AirTemp, WindSpeed, WindDir, RelHum),
               names_to = "factor",
               values_to = "value") |>
  mutate(year = format(date, "%Y")) |>
  group_by(year, sa2_name, factor) |>
  summarize(value = mean(value, na.rm = TRUE), .groups = "drop")|>
  pivot_wider(names_from = factor, values_from = value)

# Extract one geometry per sa2_name
sa2_geoms <- daily_airdata |>
  group_by(sa2_name) |>
  slice(1) |>
  select(sa2_name)

# Join geometry back to temp_daily_airdata
temp_daily_airdata <- left_join(temp_daily_airdata, sa2_geoms, by = "sa2_name") |>
  st_as_sf()
```

```{r yearly-traffic-air-quality-spatial-trends}
# Create spatial map with traffic data, pollutant concentrations, and monitoring sites
aq_traffic_sf_map <- function(data, color_var, facet_var, facet_col, units, title_var) {
  ggplot() +
    geom_sf(data = sa2_nz, fill = "grey95", color = "grey90") +
    geom_sf(data = data, aes(color = .data[[color_var]]), size = 4) +
    geom_sf_text(data = data, aes(label = sa2_name),
                 size = 4, nudge_y = 0.02, color = "#000000") +
    facet_wrap(vars(!!sym(facet_var)), ncol = facet_col) +
    coord_sf(xlim = c(174.6, 175.2), ylim = c(-37.3, -36.6), expand = FALSE) +
    scale_color_viridis_c(option = "C", name = paste("Mean ", color_var, units)) +
    theme_bw() +
    labs(
      title = paste("Spatial Patterns of Average ", title_var, " ", color_var, " Concentrations Across Selected Suburbs in Auckland (2016–2024)"),
      subtitle = paste("SA2-level Monitoring of ", color_var, " Highlighting Temporal Trends and Geographic Variation"),
      x = "Longitude", y = "Latitude") +
    theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      strip.text = element_text(size = 12, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
      axis.text.y = element_text(face = "bold")
    ) +
    annotation_scale(location = "br", width_hint = 0.3) +
    annotation_north_arrow(
      location = "tr", which_north = "true",
      height = unit(0.6, "cm"), width = unit(0.6, "cm"),
      style = north_arrow_fancy_orienteering())
}
```

## Mapping Yearly Air Quality and Traffic Trends Across Auckland Suburbs
Here we dive into yearly maps showing how air pollution, weather, and traffic volumes change across Auckland neighborhoods from 2016 to 2024. These visuals reveal clear urban–rural contrasts, seasonal shifts, and evolving patterns in both vehicle activity and air quality factors over time.

```{r display-yearly-average-spatial-maps-for-each-factor, fig.width=12, fig.height=10}
# NO2
aq_traffic_sf_map(temp_daily_airdata, "NO2", "year", 4, "(µg/m³)", "Yearly")

paste("From 2017 to 2024, Queen Street consistently recorded the highest NO2 levels, reflecting dense urban activity. Westlake showed moderate concentrations, while Ellerslie South exhibited minor variation. Patumahoe maintained the lowest levels, highlighting its rural characteristics. Overall, urban sites experienced greater NO2 exposure.") 

# NO
aq_traffic_sf_map(temp_daily_airdata, "NO", "year", 4, "(µg/m³)", "Yearly")

paste("Between 2017 and 2023, NO levels peaked at Queen Street in 2018 and 2019 before declining. Westlake showed moderate levels with slight variability. Ellerslie South and Patumahoe maintained consistently low concentrations. Post-2020 reductions likely reflect changes in traffic and emissions patterns.") 

# PM2.5
aq_traffic_sf_map(temp_daily_airdata, "PM2.5", "year", 4, "(µg/m³)", "Yearly")

paste("PM2.5 levels were consistently high at Queen Street and Westlake, with notable peaks in 2019 and 2023. Ellerslie South remained moderate, recording the lowest value in 2023. Patumahoe showed the lowest overall concentrations.") 

# PM10
aq_traffic_sf_map(temp_daily_airdata, "PM10", "year", 4, "(µg/m³)", "Yearly")

paste(" Queen Street and Ellerslie South showed elevated PM10 levels, especially in 2019 and 2023. Westlake and Patumahoe recorded the lowest values with minor fluctuations. These trends reflect urban pollution patterns and site-specific meteorological influences. ") 

# SO2
aq_traffic_sf_map(temp_daily_airdata, "SO2", "year", 4, "(µg/m³)", "Yearly")

paste(" SO2 was only recorded at Ellerslie South, peaking in 2017, then declining before rising again between 2021 and 2023. Other sites (Queen Street, Westlake, Patumahoe) lacked SO2 data and appear greyed out. ") 

# AQI
aq_traffic_sf_map(temp_daily_airdata, "AQI", "year", 4, "", "Yearly")

paste(" Queen Street had the highest AQI values, peaking between 2017 and 2021 and declining post-COVID. Westlake showed stable AQI with mild fluctuations from 2020 to 2023. Ellerslie South exhibited moderate AQI with seasonal variability, while Patumahoe consistently recorded low AQI, consistent with its low-emission rural setting. ") 

# AirTemp
aq_traffic_sf_map(temp_daily_airdata, "AirTemp", "year", 4, "(°C)", "Yearly")

paste(" From 2018 to 2023, Queen Street consistently experienced the highest air temperatures, followed by Ellerslie South and Westlake. Air temperature data was also available for Patumahoe. Elevated temperatures in urban areas reflect the urban heat island effect. ") 

# WindSpeed
aq_traffic_sf_map(temp_daily_airdata, "WindSpeed", "year", 4, "(m/s)", "Yearly")

paste(" Ellerslie South recorded the highest average wind speeds (2.2–2.8 m/s), while Westlake ranged from 2.0–2.6 m/s. Both sites showed a decline in 2023. Wind speed data was unavailable for Queen Street and Patumahoe. ") 

# WindDir
aq_traffic_sf_map(temp_daily_airdata, "WindDir", "year", 4, "(°)", "Yearly")

paste(" Westlake showed consistently higher mean wind directions (~195°), influenced by urban airflow, with a decline post-2020 and a rise again in 2023. Ellerslie South recorded lower values (~180°), likely shaped by local terrain. Wind direction data was unavailable for Queen Street and Patumahoe. ") 

# RelHum
aq_traffic_sf_map(temp_daily_airdata, "RelHum", "year", 4, "(%)", "Yearly")

paste("Overall, yearly average relative humidity in Auckland suburbs shows some fluctuations from 2016 to 2023, with variations across locations like Westlake and Ellerslie South. Westlake and Ellerslie South shows highest relative humidity in 2023 compared to lowest since 2019.") 

# Free RAM
rm(temp_daily_airdata)
gc() # Force garbage collection
```

```{r visualize-yearly-average-traffic-count-by-class-weight, fig.width=12, fig.height=10}
# Display map for "Heavy" traffic count
aq_traffic_sf_map(temp_daily_traffic, "Heavy", "year", 3, "traffic", "") + 
  labs(
    title = "Spatial Patterns of Average Yearly Heavy Traffic Count Across Selected Suburbs in Auckland (2018–2023)",
    subtitle = "SA2-level Monitoring of Heavy Traffic")

paste(" From 2018 to 2023, Queen Street consistently recorded the highest heavy traffic volumes, except in 2022 when Westlake surpassed it. In 2021, both areas showed similar levels. Ellerslie South and Patumahoe had the lowest counts, reflecting an urban–rural traffic gradient. ") 

# Display map for "Light" traffic count
aq_traffic_sf_map(temp_daily_traffic, "Light", "year", 3, "traffic", "") + 
  labs(
    title = "Spatial Patterns of Average Yearly Light Traffic Count Across Selected Suburbs in Auckland (2018–2023)",
    subtitle = "SA2-level Monitoring of Light Traffic")

paste(" From 2018 to 2023, Westlake consistently recorded the highest light traffic volumes, while Queen Street showed moderate levels initially but dropped to the lowest by 2023. In contrast, Ellerslie South and Patumahoe maintained consistently low traffic, reflecting their suburban and rural characteristics. ") 

# Free RAM
rm(temp_daily_traffic)
gc() # Force garbage collection
```

## Unveiling Seasonal Patterns: Integrating Traffic and Air Quality Data
We're diving deep into Auckland's environment by combining daily traffic and air quality data! This exciting step involves transforming raw measurements into seasonal averages, allowing us to uncover fascinating spatial and temporal trends across selected suburbs and see how they interact.

```{r join-airdata-and-traffic-by-season-and-year}
# Create season dataset of daily_traffic and daily_airdata with seasonal average
season_traffic <- daily_traffic |>
  mutate(
    month = format(date, "%m"), year = format(date, "%Y"),
    season = case_when(
      month %in% c(12, "01", "02") ~ "Su", # Summer
      month %in% c("03", "04", "05") ~ "Au", # Autumn
      month %in% c("06", "07", "08") ~ "Wi", # Winter
      month %in% c("09", 10, 11) ~ "Sp" # Spring
    )) |> # include valid season
  group_by(season, year, sa2_name, class_weight) |>
  summarize(traffic_count = mean(traffic_count, na.rm = TRUE),
            .groups = "drop")

# For the pivot_wider form of column class_weight
season_traffic <- season_traffic |>
  pivot_wider(names_from = class_weight,
              values_from = traffic_count)

# Form long form of factors in daily_airdata
season_airdata <- st_drop_geometry(daily_airdata) |>
  pivot_longer(cols = c(NO2, NO, PM2.5, PM10, SO2, AQI, AirTemp, WindSpeed, WindDir, RelHum),
               names_to = "factor",
               values_to = "value") |>
  mutate(month = format(date, "%m"), 
         year = format(date, "%Y"),
         season = case_when(
           month %in% c(12, "01", "02") ~ "Su", # Summer
           month %in% c("03", "04", "05") ~ "Au", # Autumn
           month %in% c("06", "07", "08") ~ "Wi", # Winter
           month %in% c("09", 10, 11) ~ "Sp" # Spring
           )) |>
  group_by(season, year, sa2_name, factor) |>
  summarize(value = mean(value, na.rm = TRUE), 
            .groups = "drop")

# Form wide form of factors in season_airdata
season_airdata <- season_airdata |>
  pivot_wider(names_from = factor, values_from = value)

# Join season_airdata and season_traffic
season_aq_tr <- season_airdata |>
  left_join(season_traffic, by = c("season", "year", "sa2_name"))

# Create season_year and convert season to an ordered factor
season_aq_tr <- season_aq_tr |>
  mutate(
    season_year = paste(season, year),
    season = factor(season, levels = c("Su", "Au", "Wi", "Sp")))

# Arrange by year and season to determine the correct order
ordered_levels <- season_aq_tr |>
  arrange(as.integer(year), season) |>
  distinct(season_year) |>
  pull(season_year)

# Convert season_year to an ordered factor with the correct levels
season_aq_tr <- season_aq_tr |>
  mutate(season_year = factor(season_year, levels = ordered_levels))

# Convert to sf object
season_aq_tr <- st_as_sf(season_aq_tr)

# Filter out rows with POINT EMPTY geometries in season_aq_tr
season_aq_tr <- season_aq_tr |> 
  filter(!st_is_empty(geometry))

# Free RAM
rm(season_traffic, season_airdata)
gc() # Force garbage collection
```

## Watching the Seasons: How Traffic Changes Across Auckland Suburbs (2018–2023)
Here we explore how heavy and light vehicle traffic shifts with the seasons across Auckland neighborhoods. Queen Street and Westlake stand out as busy hubs with clear seasonal ups and downs, while quieter suburbs like Ellerslie South and Patumahoe show steady, low traffic all year round.

```{r visualize-seasonal-average-light-heavy-traffic-count, fig.width=15, fig.height=12}
# Display seasonal average static map for "Heavy" traffic count
aq_traffic_sf_map(season_aq_tr, "Heavy", "season_year", 6, "traffic", "") + 
  scale_color_viridis_c(
    option = "C", trans = "log10", 
    name = "Mean Heavy traffic",
    labels = scales::label_log()) +
  labs(
    title = "Seasonal Trends in Heavy Vehicle Traffic Across Selected Auckland Suburbs (2018–2023)",
    subtitle = "SA2-Level Analysis Revealing Spatial and Temporal Variations")

paste(" Queen Street consistently records the highest seasonal heavy traffic, except in autumn and winter of 2023 when Westlake led. Westlake generally has moderate traffic, with autumn and winter slightly lower, except in 2023. Ellerslie South and Patumahoe remain steady, with both experiencing the lowest volumes. ") 

# Display seasonal average static map for "Light" traffic count
aq_traffic_sf_map(season_aq_tr, "Light", "season_year", 6, "traffic", "") + 
  scale_color_viridis_c(
    option = "C", trans = "log10", 
    name = "Mean Light traffic",
    labels = scales::label_log()) +
  labs(
    title = "Seasonal Trends in Light Vehicle Traffic Across Selected Auckland Suburbs (2018–2023)",
    subtitle = "SA2-Level Analysis Revealing Spatial and Temporal Variations")

paste(" Westlake consistently records the highest light vehicle counts, peaking across all seasons. Queen Street ranks second but saw declines in all seasons during 2023. Ellerslie South and Patumahoe exhibit moderate fluctuations, with both maintaining the lowest traffic. Urban sites display greater seasonal variation than suburban areas. ") 
```

##  Interactive Map of Seasonal Traffic and Pollution Indicators (2018–2023)
This interactive map visualizes seasonal average pollutant values and traffic counts across SA2 regions in New Zealand between 2018 and 2023.

- Marker size reflects average traffic count

- Marker color also represents traffic count (using the Plasma color scale)

- Hover tooltips provide a detailed breakdown of key variables including NO2, NO, PM2.5, PM10, SO2, AQI, temperature, humidity, and wind characteristics.

```{r interactive-traffic-pollution-of-global-seasonal-averages}
# Extract lat/lon from geometry
season_aq_tr <- season_aq_tr |>
  mutate(
    longitude = st_coordinates(geometry)[, 1],
    latitude = st_coordinates(geometry)[, 2])

# Create Plotly map: marker size = total concentration, color = per capita concentration
traffic_pollution_map <- plot_ly(
  data = season_aq_tr, type = 'scattermapbox', mode = 'markers',
  lat = ~latitude, lon = ~longitude,
  name = NULL, showlegend = FALSE,
  text = ~paste0(
    "SA2: ", sa2_name, 
    "\nHeavy Traffic: ", round(Heavy, 2), 
    "\nLight Traffic: ", round(Light, 2), 
    "\nNO2: ", round(NO2, 2), "\nNO: ", round(NO, 2), 
    "\nPM2.5: ", round(PM2.5, 2), "\nPM10: ", round(PM10, 2), 
    "\nSO2: ", round(SO2, 2), "\nAQI: ", round(AQI, 2), 
    "\nAirTemp: ", round(AirTemp, 2), "\nWindSpeed: ", round(WindSpeed, 2),
    "\nWindDir: ", round(WindDir, 2), "\nRelHum: ", round(RelHum, 2)),
  marker = list(
    size = 11, 
    color = ~Light, colorscale = 'Viridis',  # More accessible color scale
    opacity = 0.8, showscale = TRUE,
    colorbar = list(
      title = "Mean Light Traffic Count",
      x = 0.95, xanchor = "left", len = 0.75))
  ) |>
  layout(
    title = list(
      text = paste0(
        "<b>Seasonal Mean Traffic, Air Pollution, and Meteorological Factors (2018–2023)</b><br>",
        "<span style='font-size:13px;'>Color: Mean Light Traffic Count | Hover: Heavy/Light Traffic, Pollutants, AQI, Weather</span>"),
    x = 0.5,
    font = list(
      size = 14  # Main title font size
    )
  ),
    mapbox = list(
      style = "open-street-map", zoom = 8,
      center = list(
        lat = median(season_aq_tr$latitude, na.rm = TRUE),
        lon = median(season_aq_tr$longitude, na.rm = TRUE)))
    )

# Display plot
traffic_pollution_map

paste(" Global seasonal average light traffic count is highest in Westlake, then Queen Street. Lowest is in Ellerslie South and Patumahoe. ") 
```
</details>

# Auckland's Air: A Deep Dive into Traffic, Pollution, and Weather (2018–2023)
Ever wondered how Auckland's bustling traffic, air pollution, and even the weather intertwine? We've crunched data from 2018-2023, revealing fascinating connections, especially during COVID-19 lockdowns. See how vehicle numbers impacted NO, NO2, PM2.5, PM10, and SO2 levels, with urban vs. rural areas showing distinct patterns. It's a complex dance where every car, every gust of wind, plays a part in the air we breathe.

<details><summary>Read more...</summary>

## Traffic, Air Pollution, and Weather: Uncovering Their Dynamic Links
This section combines traffic, air quality, and weather data to reveal how vehicle volumes—especially during COVID-19 lockdowns—affected pollution levels across Auckland, exposing clear seasonal, spatial, and urban–rural differences.

```{r merge-daily-traffic-and-daily-airdata}
# Merge daily_airdata and daily_traffic
colnames(daily_traffic)
colnames(daily_airdata)

merged_aq_tr <- st_drop_geometry(daily_airdata) |>
  left_join(daily_traffic, by = c("date", "sa2_name"))

# Form pivot_wider form of class_weight
merged_aq_tr <- merged_aq_tr |>
  pivot_wider(names_from = class_weight, values_from = traffic_count)

skim(merged_aq_tr)

# Remove the NA column
merged_aq_tr <- merged_aq_tr |>
  select(-"NA")

paste(" This dataset merges traffic, air quality, meteorological, and population data by date and location. It enables temporal-spatial analysis of how traffic levels and site type relate to pollutant concentrations, AQI, and weather conditions across Auckland SA2 regions. ")

# Free RAM
rm(daily_traffic, daily_airdata)
gc() # Force garbage collection
```

## How Pollution, Traffic, and Weather Interact in Auckland’s Air
This section digs into the connections between air pollutants, vehicle traffic, and weather conditions. Visualizations reveal how traffic surges boost NO2 and PM10, while wind and humidity shape pollution patterns across the city’s neighborhoods.

```{r pairwise-correlations-plot}
# Select numeric columns for correlation analysis
numeric_data <- merged_aq_tr |> select(where(is.numeric))

# Custom function to visualize correlation with viridis fill
cor_col <- function(data, mapping, ...) {
  p <- ggally_cor(data, mapping, size = 4, show.legend = TRUE) +
    scale_fill_viridis(option = "D", direction = -1)
  return(p)
}

# Create ggpairs plot
ggpairs(numeric_data, 
        title = "Pairwise Relationships of Air Quality Data",
        upper = list(continuous = cor_col),
        lower = list(continuous = wrap("points", alpha = 0.5, color = viridis(1, option = "D"))),
        diag = list(continuous = wrap("barDiag", fill = viridis(1, option = "D")))) +
  theme(plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
        strip.text = element_text(face = "bold", size = 12))

paste("This captivating pairs plot unveils how seasonal pollutant variations, traffic, and wind dictate air quality. Delving deeper, discover RelHum's weak ties to most variables, especially its inverse dance with AirTemp, and its inconsistent dance with NO2, NO, and PM2.5. Fascinating insights!")
```

## Pollution and Traffic Volume Trends at High-Traffic Auckland Sites (2018–2023)
This section explores how vehicle traffic and pollution levels fluctuated over time, especially during COVID-19 lockdowns. It categorizes pollution into levels and visualizes daily and seasonal traffic patterns alongside air quality changes across key urban locations.

```{r traffic-versus-date-categorised-by-pollutants}
# Plot traffic trends by date categorised by pollutants
plot_traffic <- function(data, xvar, yvar, color_var) {
  ggplot(data = data, aes(x = .data[[xvar]], y = .data[[yvar]])) +
    geom_point(aes(color = .data[[color_var]]), size = 3) +
    scale_color_manual(
    values = c("Low" = "#56B4E9", "Medium" = "#999999", "High" = "#D55E00",  "Missing" = "#f0f0f0")) +
    stat_cor(method = "pearson", size = 4, face = "bold", label.x.npc = "left", label.y.npc = 0.1) +
    geom_smooth(method = "gam", color = "#000000", se = FALSE) +
    facet_wrap(~ sa2_name, scales = "free") +
    scale_y_log10(labels = scales::scientific) +
    theme_bw() +
    labs(
      title = paste("Average ", yvar, " Vehicle Traffic Volume and Average Air Pollution Trends During COVID-19 (2018–2023)"),
      subtitle = paste0(
        "GAM smoothing shows trends across sites. Dashed lines mark two major COVID-19 lockdown periods. ",
        "Points colored by ", color_var, " levels to compare pollution with traffic volume."),
      x = xvar, y = paste("Daily average ", yvar, " vehicle traffic count")) +
    theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.labels = element_text(size = 12, face = "bold"),
      axis.title = element_text(size = 12, face = "bold"), 
      axis.text = element_text(size = 11, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1),
      strip.text = element_text(size = 12, face = "bold"),
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 11))
  }
```

## How Traffic Patterns Influence Nitrogen Monoxide (NO) Pollution Over Time
This section examines daily heavy and light traffic trends alongside categorized NO pollution levels (low, medium, high) in Auckland from 2018 to 2023. It highlights COVID-19 lockdown impacts, site-specific patterns, and imputed data revealing traffic’s variable influence on NO pollution.

```{r traffic-no-level-trends-and-arima-imputation}
# Categorize NO levels
merged_aq_tr <- merged_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    NO_cat = case_when(
      is.na(NO) ~ "Missing",
      NO <= quantile(NO, 0.10, na.rm = TRUE) ~ "Low",
      NO >= quantile(NO, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Plot heavy traffic volumes with NO pollution category
plot_traffic(merged_aq_tr, "date", "Heavy", "NO_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "NO Level Category")

paste(" Heavy traffic volumes dropped significantly during COVID-19 lockdowns, particularly in Queen Street and Westlake. NO pollution peaked in Queen Street before the pandemic, stabilized during lockdowns, and rose sharply again by March 2023. ") 

# Plot light traffic volumes with NO pollution category
plot_traffic(merged_aq_tr, "date", "Light", "NO_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
  xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
  linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "NO Level Category")

paste(" Traffic volume declined during COVID-19 lockdowns, notably in Queen Street and Westlake, with NO fluctuations varying by site. Queen Street showed the strongest correlation—NO peaked pre-COVID, stabilized in lockdowns but high in between, dropped in the second, then spiked to extremes in March 2023. At Patumahoe, NO increased from low between the first and second lockdowns to medium during the second, sustaining that level thereafter. ")

# Categorize NO by quantiles for seasonal data
season_aq_tr <- season_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    NO_cat = case_when(
      is.na(NO) ~ "Missing",
      NO <= quantile(NO, 0.10, na.rm = TRUE) ~ "Low",
      NO >= quantile(NO, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Visualize seasonal heavy traffic colored by NO
plot_traffic(season_aq_tr, "season_year", "Heavy", "NO_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", color = "NO Level Category")

paste(" Traffic patterns dropped during COVID seasons, with varying NO trends: Queen Street and Ellerslie South saw enduring pollution drops, but Patumahoe retained medium to high levels, reflecting possible rural-residential traffic resilience. ")

# Fill in missing heavy traffic data using ARIMA
season_aq_tr <- season_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    arima_Heavy = na_kalman(Heavy, model = "auto.arima")) |> ungroup()

# Visualize ARIMA-imputed traffic
plot_traffic(season_aq_tr, "season_year", "arima_Heavy", "NO_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "ARIMA approximated average Heavy traffic count", color = "NO Level Category")

paste(" ARIMA imputation improved continuity for analysis. Westlake consistently had lower traffic volumes, though NO levels remained stable. This contrast suggests local pollution might be influenced by non-traffic sources or atmospheric conditions. ")

# Plot seasonal Light traffic colored by NO
plot_traffic(season_aq_tr, "season_year", "Light", "NO_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "Average Light vehicle traffic count", color = "NO Level Category")

paste(" Light traffic and NO pollution declined sharply during major lockdowns in urban zones like Queen Street and Westlake. Post-lockdown NO levels remained low in urban areas but persisted at medium-to-high levels in Patumahoe—suggesting site-specific recovery patterns. ")
```

## Daily and Seasonal Traffic Trends Categorized by NO2 Levels
Understanding how traffic patterns relate to air pollution is central to this analysis. In this section, I categorize nitrogen dioxide (NO2) concentrations into quantile-based levels and visualize how these relate to light and heavy vehicle counts—both daily and seasonally. This helps tease apart traffic-pollution dynamics across urban and rural Auckland.

```{r plot-daily-and-season-traffic-categorized-by-no2}
# Categorize NO2 concentrations into quantiles
merged_aq_tr <- merged_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    NO2_cat = case_when(
      is.na(NO2) ~ "Missing",
      NO2 <= quantile(NO2, 0.10, na.rm = TRUE) ~ "Low",
      NO2 >= quantile(NO2, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Plot daily Heavy traffic count, colored by NO2 category
plot_traffic(merged_aq_tr, "date", "Heavy", "NO2_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "NO2 Level Category")

paste(" The relationship between heavy vehicle counts and NO2 is particularly strong in Queen Street and Westlake. Queen Street saw elevated NO2 just before the first lockdown in 2020, a sharp drop during lockdowns, and another increase post-2023. Patumahoe, in contrast, showed little variation in heavy traffic or NO2. ")

# Plot daily Light traffic count, colored by NO2 ctegory
plot_traffic(merged_aq_tr, "date", "Light", "NO2_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "NO2 Level Category")

paste(" Light vehicles followed similar trends to heavy ones, though at much higher volumes. This supports the hypothesis that overall vehicle activity—not just heavy transport—is a key driver of NO2 levels in urban centers. ")

# Re-classify NO2 for seasonal data
season_aq_tr <- season_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    NO2_cat = case_when(
      is.na(NO2) ~ "Missing",
      NO2 <= quantile(NO2, 0.10, na.rm = TRUE) ~ "Low",
      NO2 >= quantile(NO2, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Plot seasonal Heavy traffic count, colored by NO2 for sites
plot_traffic(season_aq_tr, "season_year", "arima_Heavy", "NO2_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", color = "NO2 Level Category")

paste(" Queen Street consistently exhibits the highest pollution and traffic volumes. Patumahoe, with its sparse traffic, showed a curious bump in NO2 following the first lockdown—possibly due to regional air circulation or farming emissions. NO2 declined again later but rebounded to medium levels by autumn 2023. ")

# Plot seasonal Light traffic count, colored by NO2 for sites
plot_traffic(season_aq_tr, "season_year", "Light", "NO2_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", color = "NO2 Level Category")

paste(" Lockdowns left clear imprints in seasonal patterns. Patumahoe remained largely unaffected traffic-wise, but NO2 fluctuations suggest other sources may be influencing rural air quality. Westlake and Ellerslie South showed quick rebounds post-lockdown, whereas Queen Street retained moderate NO2 well into 2023. ")
```

## Daily & Seasonal Traffic Trends Categorized by PM2.5 Levels
As part of our exploration of how traffic patterns relate to PM2.5 air pollution, I created visualizations showing daily and seasonal vehicle counts (both heavy and light) at various Auckland sites. PM2.5 values were categorized into Low, Medium, and High based on their 10th and 90th percentiles to emphasize extremes.

```{r plot-daily-and-seasonal-traffic-categorized-by-pm25}
# Add PM2.5 category based on quantiles
merged_aq_tr <- merged_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    PM2.5_cat = case_when(
      is.na(PM2.5) ~ "Missing",
      PM2.5 <= quantile(PM2.5, 0.10, na.rm = TRUE) ~ "Low",
      PM2.5 >= quantile(PM2.5, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Plot daily Heavy traffic counts, color-coded by PM2.5 levels
plot_traffic(merged_aq_tr, "date", "Heavy", "PM2.5_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "PM2.5 Level Category")

paste(" Queen Street experienced a clear PM2.5 drop following the initial COVID-19 lockdown but spiked again after March 2023. Patumahoe displayed more variable patterns, particularly post-lockdown. Westlake, meanwhile, showed erratic but seasonal fluctuation. ")  

# Plot daily Light traffic count, colored by PM2.5 category
plot_traffic(merged_aq_tr, "date", "Light", "PM2.5_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "PM2.5 Level Category")

paste(" Ellerslie South and Patumahoe saw drops in PM2.5 levels after the initial lockdown, with more stable low-to-medium levels. Queen Street and Westlake dipped post-2021 lockdown but rebounded sharply by 2023. These shifts suggest the PM2.5 response is not purely traffic-driven—perhaps influenced by weather or other emissions. ") 

# Add 10-90% quantile category for PM2.5 in season_aq_tr 
season_aq_tr <- season_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    PM2.5_cat = case_when(
      is.na(PM2.5) ~ "Missing",
      PM2.5 <= quantile(PM2.5, 0.10, na.rm = TRUE) ~ "Low",
      PM2.5 >= quantile(PM2.5, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Plot seasonal Heavy traffic count, colored by PM2.5 for sites
plot_traffic(season_aq_tr, "season_year", "arima_Heavy", "PM2.5_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "ARIMA approximated average Heavy vehicle traffic count", color = "PM2.5 Level Category")

paste(" Ellerslie South showed steady traffic growth after lockdowns, while Patumahoe’s trend was less predictable. Queen Street's traffic dropped significantly post-lockdown before recovering in autumn 2022. Westlake’s pattern reflects cyclical seasonality. ") 

# Plot seasonal Light traffic count, colored by PM2.5 for sites
plot_traffic(season_aq_tr, "season_year", "Light", "PM2.5_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "Average Light vehicle traffic count", color = "PM2.5 Level Category")

paste(" Lockdowns led to sharp declines in light traffic across sites—except for Patumahoe, which saw a counterintuitive increase. Interestingly, PM2.5 dropped in Patumahoe even as traffic rose, suggesting that rural air quality may be shaped by agricultural activity, wind, or regional dispersion, not just local traffic. ") 
```

## Daily Traffic Patterns Categorized by PM10 Levels
To explore how PM10 air pollution levels relate to vehicle traffic, I categorized daily PM10 values into "Low", "Medium", and "High" using the 10th and 90th percentiles as thresholds. Days with missing PM10 values were flagged as "Missing". I then visualized daily counts of Heavy and Light vehicles, colored by PM10 level, to examine temporal trends and lockdown-related effects.

```{r plot-daily-and-seasonal-traffic-with-pm10-categorised}
# Categorize PM10 levels into quantile-based categories
merged_aq_tr <- merged_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    PM10_cat = case_when(
      is.na(PM10) ~ "Missing",
      PM10 <= quantile(PM10, 0.10, na.rm = TRUE) ~ "Low",
      PM10 >= quantile(PM10, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Plot daily Heavy vehicle traffic coloured by PM10 category
plot_traffic(merged_aq_tr, "date", "Heavy", "PM10_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "PM10 Level Category")

paste(" Ellerslie South and Westlake show positive correlations between PM10 and heavy traffic. In contrast, Queen Street exhibits a negative trend, where traffic decreases post-lockdowns while PM10 fluctuates. Patumahoe shows a rebound in traffic after the first lockdown, but PM10 levels dropped in March 2020, suggesting cleaner air during restricted movement. ") 

# Plot daily Light traffic count
plot_traffic(merged_aq_tr, "date", "Light", "PM10_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "PM10 Level Category")

paste(" PM10 and light vehicle traffic correlations are more variable. Queen Street, Westlake, and Ellerslie South all show decreasing traffic trends over time with fluctuating or declining PM10 levels. Notably, Patumahoe had more Low PM10 days during and after the second lockdown—possibly due to reduced commuting and local emissions. ") 

# Categorise seasonal PM10 levels
season_aq_tr <- season_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    PM10_cat = case_when(
      is.na(PM10) ~ "Missing",
      PM10 <= quantile(PM10, 0.10, na.rm = TRUE) ~ "Low",
      PM10 >= quantile(PM10, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Plot seasonal Heavy traffic (ARIMA-smoothed) vs season_year
plot_traffic(season_aq_tr, "season_year", "arima_Heavy", "PM10_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "ARIMA approximated average Heavy vehicle traffic count", color = "PM10 Level Category")

paste(" In Queen Street and Ellerslie South, PM10 remained medium to high despite heavy traffic fluctuations. Patumahoe recorded clusters of low PM10 seasons post-lockdown, aligning with its rural, lower-emission context. Westlake exhibited a clear PM10 drop during the first lockdown. ")

# Plot seasonal Light traffic vs PM10
plot_traffic(season_aq_tr, "season_year", "Light", "PM10_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "Average Light vehicle traffic count", color = "PM10 Level Category")

paste(" Across sites, PM10 levels peaked in spring, possibly due to pollen or seasonal pollutants. During lockdowns, light traffic declined everywhere except in Patumahoe. In Westlake, traffic and PM10 fell sharply, highlighting the short-term environmental benefits of mobility restrictions. ")
```

## Traffic Trends Categorized by SO2 Levels (2018–2023)
This analysis explores how traffic volumes from 2018–2023 relate to SO2 pollution. Using quantile-based categories, clear patterns emerged, especially around COVID-19 lockdowns and urban traffic spikes.

```{r plot-daily-and-seasonal-traffic-categorized-by-so2}
# Categorise SO2 levels
merged_aq_tr <- merged_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    SO2_cat = case_when(
      is.na(SO2) ~ "Missing",
      SO2 <= quantile(SO2, 0.10, na.rm = TRUE) ~ "Low",
      SO2 >= quantile(SO2, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Plot Heavy vehicle traffic over time
plot_traffic(merged_aq_tr, "date", "Heavy", "SO2_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "SO2 Level Category")

paste(" Ellerslie South is the only site reporting SO2 levels, making it the focal point for pollution-traffic trends. Before the first lockdown, SO2 peaked alongside increasing traffic volumes. A sharp drop followed the first lockdown, with a recovery and second spike around the second lockdown. Meanwhile, traffic in Westlake consistently led all sites, followed by Queen Street, Ellerslie South, and Patumahoe. This trend aligns with expectations of urban traffic density. ") 

# Plot Light vehicle traffic over time
plot_traffic(merged_aq_tr, "date", "Light", "SO2_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03")),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Date", color = "SO2 Level Category")

paste(" Light vehicle traffic dipped significantly during lockdowns, as expected. Interestingly, the inverse relationship between SO2 and light traffic was clearest at Queen Street, suggesting a direct human mobility effect on pollution concentration. These daily plots make the pandemic’s environmental imprint quite visible. ") 

# Categorise SO2 levels seasonally
season_aq_tr <- season_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    SO2_cat = case_when(
      is.na(SO2) ~ "Missing",
      SO2 <= quantile(SO2, 0.10, na.rm = TRUE) ~ "Low",
      SO2 >= quantile(SO2, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Plot seasonal Heavy vehicle traffic
plot_traffic(season_aq_tr, "season_year", "arima_Heavy", "SO2_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "ARIMA approximated average Heavy vehicle traffic count", color = "SO2 Level Category")

paste(" Seasonal smoothing revealed key patterns not obvious in daily data. Pre-lockdown, SO2 at Ellerslie South was consistently low to medium. Post-lockdown, we see a gradual climb to medium-high levels, hinting at a delayed environmental rebound as activity resumed. ") 

# Plot seasonal Light vehicle traffic
plot_traffic(season_aq_tr, "season_year", "Light", "SO2_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "Average Light vehicle traffic count", color = "SO2 Level Category")

paste(" SO2 categories for light traffic tell a similar story: mostly low or medium prior to 2020, spiking during lockdown periods — possibly due to reduced dispersion of pollutants. Seasonal traffic peaks varied by site, but COVID's suppression effect was sharp across all. ") 
```

## Daily and Seasonal Traffic Trends Categorized by AQI
Here, I am analyzing how air quality categories affect heavy and light traffic trends across Auckland, revealing how COVID-19 lockdowns shifted vehicle movements and improved pollution levels differently across urban and rural sites.

```{r plot-daily-traffic-categorized-by-AQI}
# Categorize AQI into quantile-based levels
merged_aq_tr <- merged_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    AQI_cat = case_when(
      is.na(AQI) ~ "Missing",
      AQI <= quantile(AQI, 0.10, na.rm = TRUE) ~ "Low",
      AQI >= quantile(AQI, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Define lockdown periods
lockdown_dates <- as.Date(c("2020-03-25", "2020-05-13", "2021-08-17", "2021-12-03"))

# Visualize Heavy traffic with AQI category
plot_traffic(merged_aq_tr, "date", "Heavy", "AQI_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = lockdown_dates, linetype = "dashed",
    color = "#000000", lwd = 1) +
  labs(x = "Date", color = "AQI Level Category")

paste(" Ellerslie South and Westlake exhibit weak positive correlations, while Queen Street trends strongly negative. Patumahoe shows no clear relationship. Ellerslie South has high AQI variability; Queen Street shifts from medium-high pre-lockdown to clustered low post-lockdown. Westlake fluctuates moderately; Patumahoe favors low-medium AQI post-lockdown. ") 

# Visualize Light traffic with AQI category
plot_traffic(merged_aq_tr, "date", "Light", "AQI_cat") +
  scale_x_date(
      limits = c(as.Date("2018-01-01"), as.Date("2023-09-30")),
      date_breaks = "3 months", date_labels = "%b%y") +
  geom_vline(
    xintercept = lockdown_dates, linetype = "dashed", 
    color = "#000000", lwd = 1) +
  labs(x = "Date", color = "AQI Level Category")

paste(" Queen Street shows the strongest negative correlation (-0.29), indicating traffic dropped over time. Patumahoe's weak positive correlation (0.09) is non-significant. Ellerslie South (-0.17) and Westlake (-0.16) show moderate negative trends. AQI fell sharply during lockdowns, especially in urban areas. Patumahoe saw light traffic increase, with low AQI clusters post-lockdown. Queen Street had high AQI clusters until March 2022, followed by more low-AQI clusters thereafter. ")
```

## Seasonal Trends and Lockdown Effects
To smooth short-term noise, I aggregated traffic data by season-year and examined how AQI categories aligned with traffic volumes over longer periods.

```{r plot-seasonal-traffic-categorized-by-AQI}
# Apply AQI categorization to seasonal traffic 
season_aq_tr <- season_aq_tr |>
  group_by(sa2_name) |>
  mutate(
    AQI_cat = case_when(
      is.na(AQI) ~ "Missing",
      AQI <= quantile(AQI, 0.10, na.rm = TRUE) ~ "Low",
      AQI >= quantile(AQI, 0.90, na.rm = TRUE) ~ "High",
      TRUE ~ "Medium")) |> ungroup()

# Seasonal plot: Heavy traffic vs AQI category
plot_traffic(season_aq_tr, "season_year", "arima_Heavy", "AQI_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "ARIMA smoothed Heavy traffic", color = "AQI Level Category")

paste(" Traffic and AQI trends show seasonal shifts, with COVID-19 lockdowns reducing pollution and vehicle counts—except in Patumahoe (second lockdown) and Westlake (first lockdown) where traffic rose. Post-2021, traffic rebounded, except in Ellerslie South and Patumahoe, while AQI varied by site. During lockdowns, AQI fell to low levels, except in Queen Street, where it dropped to medium. From Autumn 2022, Queen Street AQI remained low but rose to high in winter 2023, reflecting localized pollution dynamics. ") 

# Seasonal plot: Light traffic vs AQI category
plot_traffic(season_aq_tr, "season_year", "Light", "AQI_cat") +
  geom_line(
    aes(group = sa2_name), color = "grey40", alpha = 0.7) +
  geom_vline(
    xintercept = c("Au 2020", "Sp 2021"),
    linetype = "dashed", color = "#000000", lwd = 1) +
  labs(x = "Season Year", y = "Average Light vehicle traffic count", color = "AQI Level Category")

paste(" Traffic and AQI trends varied across sites. Queen Street’s pollution dropped to low AQI in autumn 2022, rising in winter 2023. Patumahoe had low AQI in winter 2020, lockdowns, and spring 2022, with post-lockdown traffic declining while AQI stayed medium. ") 
```
</details>

# Traffic & Pollution: Auckland's Air Under Temperature's Eye (2018-2023)
Explore how daily traffic volumes and air pollution (NO, NO2, PM2.5, PM10, SO2) intertwine in Auckland. This analysis reveals the significant role of air temperature in shaping pollutant concentrations across urban and rural sites.

<details><summary>Read more...</summary>

```{r define-plot-function-traffic-vs-pollutants}
# Free RAM
rm(season_aq_tr)
gc() # Force garbage collection

# Create new column of sa2_name and site_type combined
merged_aq_tr <- merged_aq_tr |>
  mutate(sa2_name_type = paste(sa2_name, "_", site_type))

# Function to plot traffic versus pollutants colored by meteorological factors
plot_tr_aq <- function(data, xvar, yvar, color_var, col_cat, x_npc, y_npc) {
  ggplot(data = data, aes(x = .data[[xvar]], y = .data[[yvar]])) +
    geom_point(aes(color = .data[[color_var]]), size = 3) +
    scale_color_manual(values = col_cat) +
    stat_cor(method = "pearson", size = 5, face = "bold", label.x.npc = x_npc, label.y.npc = y_npc) +
    geom_smooth(method = "loess", color = "#000000", se = FALSE) +
    facet_wrap(~ sa2_name_type, scales = "free") +
    scale_y_log10(labels = scales::scientific) +
    scale_x_log10(labels = scales::scientific) +
    theme_bw() +
    labs(
      title = paste("Daily Average ", xvar, " Vehicle Traffic Volume Versus Average ", yvar, " Pollutant Trend (2018–2023)"),
      subtitle = paste0(
        "LOESS smoothing shows trends across sites.",
        "Points colored by ", color_var, " levels to compare pollution with traffic volume."),
      x = xvar, y = paste("Daily Average ", yvar, " (µg/m³)")) +
    theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.labels = element_text(size = 12, face = "bold"),
      axis.title = element_text(size = 12, face = "bold"), 
      axis.text = element_text(size = 11, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1),
      strip.text = element_text(size = 12, face = "bold"),
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 11), face = "bold")
  }
```

```{r categorize-airtemp}
# AirTemp category logic
merged_aq_tr <- merged_aq_tr |>
  group_by(sa2_name_type) |>
  mutate(
    AirTemp_cat = case_when(
      is.na(AirTemp) ~ "Missing",
      AirTemp <= quantile(AirTemp, 0.10, na.rm = TRUE) ~ "Cool",
      AirTemp >= quantile(AirTemp, 0.90, na.rm = TRUE) ~ "Hot",
      TRUE ~ "Moderate")) |> ungroup()
```

```{r plot-traffic-vs-pollutants-by-airtemp}
# Define colours for AirTemp categories
col_cat <- c("Cool" = "#56B4E9", "Moderate" = "#999999", "Hot" = "#D55E00",  "Missing" = "#f0f0f0")

# Visualize Heavy Traffic vs NO
plot_tr_aq(merged_aq_tr, "Heavy", "NO", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(color = "AirTemp category")

paste(" Queen Street-traffic site and Patumahoe show significant positive correlations, while the rest shows negligible trends. Pollution levels generally higher under cooler conditions. At Ellerslie South and Westlake, Hot days are linked to low NO levels. ")

# Select sa2_name for which AirTemp data is available
data <- filter(merged_aq_tr, sa2_name != "Patumahoe")

# Visualize AirTemp vs NO
plot_tr_aq(data, "AirTemp", "NO", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(
    title = "Daily Average Air Temperature Versus NO Pollutant Trend (2018–2023)", x = "AirTemp (°C)", color = "AirTemp category")

paste(" NO levels generally decrease with rising air temperatures across sites. Strong negative correlations are observed at residential sites, especially Westlake. Queen Street Traffic shows a weak, non-significant relationship, suggesting other dominant pollution sources. ")

# Visualize Light Traffic vs NO
plot_tr_aq(merged_aq_tr, "Light", "NO", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(color = "AirTemp category")

paste(" Westlake sites show the strongest positive correlation between traffic volume and NO levels. Patumahoe shows moderate correlation, while Queen Street Residential exhibits a weak negative non-significant trend. Cool temperature are linked with high NO level. ")

# Visualize Heavy Traffic vs NO2
plot_tr_aq(merged_aq_tr, "Heavy", "NO2", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(color = "AirTemp category")

paste(" Queen Street (Traffic) has the highest correlation (R=0.39), while Ellerslie South (Residential, Industrial) and Westlake (Residential, Traffic) shows non-significant correlation. Queen Street (Residential) shows moderate correlations, while Patumahoe (Reidential) has weaker correlations. High air temperatures are linked with high NO2. ")

# Visualize AirTemp vs NO2
plot_tr_aq(data, "AirTemp", "NO2", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(
    title = "Daily Average Air Temperature Versus NO2 Pollutant Trend (2018–2023)", x = "Daily Average AirTemp (°C)", color = "AirTemp category")

paste(" All sites show a negative correlation between temperature and NO2 levels. LOESS smooth trend is in upward direction for Queen Street (Traffic) due to an outlier. Queen Street (Residential) has the strongest correlation (-0.67), while Queen Street (Traffic) has the weakest (-0.3). ")

# Visualize Light Traffic vs NO2
plot_tr_aq(merged_aq_tr, "Light", "NO2", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(color = "AirTemp category")

paste(" Westlake Residential (R = 0.32) and Westlake Traffic (R = 0.31) show strongest NO2-traffic links. Queen Street Residential (R = 0.097) has non-significant correlation. Cold air temperature's show high NO2 level. Missing air temperatures are shaded white. ")

# Visualize Heavy traffic vs PM2.5
plot_tr_aq(merged_aq_tr, "Heavy", "PM2.5", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(color = "AirTemp category")

paste(" Westlake (Traffic) is the only site showing significant negative correlation between heavy vehicle traffic and PM2.5. Other sites show weak, or no correlation, suggesting site-specific pollutant dynamics influenced by local conditions. ")

# Visualize AirTemp vs PM2.5
plot_tr_aq(data, "AirTemp", "PM2.5", "AirTemp_cat", col_cat, "center", 1) + 
  labs(
    title = "Daily Average Air Temperature Versus PM2.5 Pollutant Trend (2018–2023)", x = "Daily Average AirTemp (°C)", color = "AirTemp category")

paste(" Ellerslie South and Westlake show decreasing PM2.5 with rising temperature, strongest at Westlake. Queen Street trends fluctuate and shows very weak or no relationship. Higher temperature generally coincides with lower pollution, especially outside urban zones. ")

# Visualize Light Traffic vs PM2.5
plot_tr_aq(merged_aq_tr, "Light", "PM2.5", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(color = "AirTemp category")

paste(" Ellerslie South, Westlake (Traffic), and Queen Street (Traffic) show slight increases, while Patumahoe, Queen Street (Residential), and Westlake (Residential) shows very weak decline or no correlation. Westlake (Traffic) remains stable. Temperature influences vary across sites and correlations are weak overall because of extreme outliers. ")

# Visualize Heavy Traffic vs PM10
plot_tr_aq(merged_aq_tr, "Heavy", "PM10", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(color = "AirTemp category")

paste(" Westlake (Traffic) site show weak negative PM10-traffic correlation, while other sites show weak or negligible trends. Temperature segmentation reveals limited influence. Traffic volume alone doesn't determine PM10 fluctuations. ")

# Visualize AirTemp vs PM10
plot_tr_aq(data, "AirTemp", "PM10", "AirTemp_cat", col_cat, "left", 0.9) + 
  labs(
    title = "Daily Average Air Temperature Versus PM10 Pollutant Trend (2018–2023)", x = "Daily Average AirTemp (°C)", color = "AirTemp category")

paste("Westlake (Traffic) is only site shows negative correlations between air temperature and PM10, while the others show neglible correlations.")

# Visualize Light Traffic vs PM10
plot_tr_aq(merged_aq_tr, "Light", "PM10", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(color = "AirTemp category")

paste(" Ellerslie South and Westlake (Traffic) show positive correlations between traffic volume and PM10 levels, while the rest shows negligible correlation. Missing values are shown using white point colors. ")

# Filter SO2 data for Ellerslie South
data <- merged_aq_tr |>
  filter(sa2_name == "Ellerslie South")

# Visualize SO2: Traffic & AirTemp (Ellerslie South)
plot_Heavy <- plot_tr_aq(data, "Heavy", "SO2", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(title = "Heavy vs. SO2", subtitle = "", color = "AirTemp category")

plot_Light <- plot_tr_aq(data, "Light", "SO2", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(title = "Light vs. SO2", subtitle = "", color = "AirTemp category")

plot_airtemp_aq <- plot_tr_aq(data, "AirTemp", "SO2", "AirTemp_cat", col_cat, "left", 0.1) + 
  labs(
    title = "Daily Average Air Temperature Versus SO2 Trend (2018–2023)",
    subtitle = "LOESS smoothing shows trends across sites., Points colored by AirTemp levels to compare with SO2 levels.",   
    x = "Daily Average AirTemp (°C)", color = "AirTemp category")

(plot_Heavy + plot_Light) / plot_airtemp_aq +
  plot_layout(guides = "collect") + # Collect legend
  plot_annotation(
    title = "Daily Average Heavy and Light Vehicle Traffic Volume Versus Average SO2 Pollutant Trend (2018–2023)",
    subtitle = "LOESS smoothing shows trends across sites., Points colored by AirTemp levels to compare pollution with traffic volume.",
    theme = theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5), 
      plot.subtitle = element_text(size = 12, hjust = 0.5)
    ))

paste(" SO2 correlates weakly with heavy traffic (R = 0.069, p = 0.026) and inversely with light traffic (R = -0.1, p = 0.00012) and air temperature (R = -0.26, p < 2.2e-16), suggesting seasonal influences. ")
```
</details>

# Decoding Air Quality: Advanced Modeling with GAM and Random Forest
Ever wondered what truly impacts our air quality? We dove deep, using Generalized Additive Models (GAM) and Random Forest to unravel the complex relationships between environmental factors, traffic, and Auckland's Air Quality Index (AQI). GAM uncovers nuanced, non-linear trends, while Random Forest provides a robust benchmark and pinpoints the most crucial variables—like heavy vehicle traffic, NO2, and PM2.5—driving our city's air quality.

<details><summary>Read more...</summary>

```{r perform-feature-engineering-on-date-and-geometry}
# Extract coordinates from geometry column and add as separate numeric fields
coords <- st_coordinates(merged_aq_tr$geometry)
merged_aq_tr$longitude <- coords[,1]
merged_aq_tr$latitude <- coords[,2]

# Create temporal features to support seasonal and weekday trends
merged_aq_tr <- merged_aq_tr |>
  mutate(year = format(date, "%Y"),
         month = format(date, "%m"),
         day = format(date, "%d"),
         week = format(date, "%U"),
         weekday = weekdays(date),
         weekend = ifelse(weekday %in% c("Saturday", "Sunday"), TRUE, FALSE),
         season = case_when(
           month %in% c("12", "01", "02") ~ "summer",
           month %in% c("03", "04", "05") ~ "autumn",
           month %in% c("06", "07", "08") ~ "winter",
           month %in% c("09", "10", "11") ~ "spring"))
```

```{r prepare-data-for-modelling}
# Interpolate missing values for key pollutants and weather metrics, then drop remaining NA rows
filtered_merged <- merged_aq_tr |>
  select(-geometry, -AQI_cat) |>
  mutate(across(
    c(NO, NO2, PM2.5, PM10, SO2, AirTemp, WindSpeed, WindDir, RelHum, AQI, latitude, longitude),
    ~ zoo::na.approx(., na.rm = FALSE)
  )) |>
  drop_na() 

# Confirm no missing values remain
sum(is.na(filtered_merged))  # should return 0

# Confirm variable richness before modeling
s_vars <- c("NO", "NO2", "PM2.5", "PM10", "SO2", "AirTemp", 
            "WindSpeed", "WindDir", "RelHum", "pop2018", "latitude", 
            "longitude", "Heavy", "Light", "date")

sapply(filtered_merged[s_vars], function(x) length(unique(x)))
```

## Linear Model (Baseline)
To establish a baseline, I first fit a linear regression model using pollutant levels, meteorological variables, and engineered date features. This model assumes additive and linear relationships between predictors and AQI.

```{r fit-baseline-linear-model}
# Fit linear model
model_lm <- lm(AQI ~ NO + NO2 + PM2.5 + PM10 + SO2 + AirTemp + WindSpeed + WindDir + RelHum + pop2018 + latitude + longitude + Heavy + Light + as.numeric(date) + factor(season) + factor(weekday) + factor(year) + factor(day) + factor(month) + factor(week) + factor(weekend) +  factor(AirTemp_cat) + factor(NO_cat) + factor(NO2_cat) + factor(PM2.5_cat) + factor(PM10_cat) + factor(SO2_cat), data = filtered_merged)
```

## Generalized Additive Model (GAM)
Linear models often fall short when relationships aren't strictly straight lines. Here, I use mgcv::gam() to allow smooth terms like s(NO) and s(WindSpeed) to flexibly learn patterns in the data. I also included traffic, weather, spatial, and temporal variables, along with engineered categories, to capture more context.

```{r fit-generalised-additive-model} 
# Fit a GAM to model non-linear AQI relationships
model_gam <- gam(
  AQI ~ s(NO) + s(NO2) + s(PM2.5) + s(PM10) + s(SO2) + s(AirTemp) + s(WindSpeed) + s(WindDir) + s(RelHum) + pop2018 + latitude + longitude + s(Heavy) + s(Light) + s(as.numeric(date)) + season + weekday + year + day + month + week + weekend + AirTemp_cat + NO_cat + NO2_cat + PM2.5_cat + PM10_cat + SO2_cat, 
  data = filtered_merged, 
  method = "REML")

# Summary Insight
paste(" This model structure helped account for the non-linearities in AQI levels across weather, emissions, and seasonal cycles. It also offered interpretable smooth terms, which are especially valuable for uncovering threshold effects and plateaus. ")
```

## Visualizing Non-Linear Effects in a GAM Model of AQI Drivers
Using gratia::draw(), we visualize smooth terms from a GAM modeling AQI as a function of key pollutants, weather, traffic, and time—revealing complex non-linear relationships across variables.

```{r draw-gam-smooths}
# Plot GAM smooth terms with custom title/subtitle
draw(model_gam) +
  labs(x = "Predictor Variables", y = "Effect on AQI") +
  theme_bw() +
  scale_color_viridis_c(option = "magma") +
  plot_annotation(
    title = "Non-Linear Effects of Environmental & Traffic Predictors on AQI",
    subtitle = "GAM smooth terms estimated via REML",
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 11, hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold")
    )
  )

# Summary Insight
paste("This fascinating graph reveals the non-linear impacts of environmental and traffic factors on AQI. Notice how some pollutants like NO and PM2.5 show increasing effects, while WindDir, have complex, fluctuating relationships. Temperature and humidity also exhibit varied, non-monotonic influences.")
```

## Random Forest: A Non-Parametric Benchmark
To check how well we could predict AQI without assuming functional forms, I fitted a Random Forest model. It’s resilient to multicollinearity, outliers, and complex interactions.

```{r fit-random-forest-model-using-500-trees}
# Fit a random forest model for AQI prediction
model_rf <- randomForest(
  AQI ~ ., 
  data = filtered_merged, 
  importance = TRUE, 
  ntree = 500
)

# Summary Insight
paste(" The forest's ensemble nature gives a more robust fit, though it's less interpretable than GAM. Still, it tells us which predictors matter most — and sometimes, that’s enough. ")
```

## What Drives AQI? — Variable Importance from the Random Forest
The next plot shows which variables were most important for predicting AQI, measured by how much accuracy drops when each is permuted. Traffic density (especially heavy vehicles), NO2, and PM2.5 emerged as key drivers.

```{r plot-top15-variable-importance-aqi-rf}
# Format and visualise top variable importance scores
importance_df <- as.data.frame(importance(model_rf))

# Rename column name with special character
colnames(importance_df)[colnames(importance_df) == "%IncMSE"] <- "IncMSE"

importance_df$variable <- rownames(importance_df)
importance_df <- importance_df |>
  arrange(desc(IncMSE)) |>
  slice(1:15)  # Top 15 variables

# Visualise top variables
ggplot(importance_df, aes(x = reorder(variable, IncMSE), y = IncMSE)) +
  geom_col(fill = "#0072B2", alpha = 0.85) +
  coord_flip() +
  labs(
    title = "Top 15 Predictor Importance for AQI in Random Forest Model",
    x = "variable",
    y = "Mean Decrease in Accuracy (IncMSE)"
  ) +
  theme_bw(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 15, hjust = 0.5),
    axis.title = element_text(face = "bold", size = 12),
    axis.text = element_text(face = "bold", size = 11),
    axis.title.y = element_blank())

# Summary Insight
paste(" The most important predictors for AQI are PM10 and date, significantly outweighing other factors like PM10 categories, week, and various pollutants and environmental conditions, which show progressively less importance. ")
```

## Predicted vs Actual AQI — LM, GAM, and Random Forest
Let’s compare model predictions against observed AQI values. I created a generic function to do this across models and facets.

```{r generic-function-to-plot-predicted-versus-actual-aqi}
# Compare model predictions against observed AQI
plot_model <- function(xvar, yvar, facet_var) {
  ggplot(filtered_merged, aes(x = {{xvar}}, y = {{yvar}})) +
    geom_smooth(method = "loess", se = FALSE, color = "#000000") +
    stat_cor(method = "pearson", size = 4, fontface = "bold", label.x.npc = "left", label.y.npc = "top") +
    scale_y_log10(labels = scales::scientific) +
    scale_x_log10(labels = scales::scientific) +
    facet_wrap(vars({{facet_var}}), scales = "free") +
    labs(x = "Actual AQI", y = "Predicted AQI") +
    theme_bw() +
    theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.labels = element_text(size = 12, face = "bold"),
      axis.title = element_text(size = 12, face = "bold"), 
      axis.text = element_text(size = 11, face = "bold"),
      strip.text = element_text(size = 12, face = "bold"),
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 11, face = "bold"))
}
```

```{r plot-actual-aqi-versus-predicted-aqi}
# Plot predicted versus actual for linear model
plot_model(AQI, predict(model_lm), sa2_name_type) +
  geom_point(size = 1.8, alpha = 0.7, color = viridis(5)[1]) +
  geom_abline(slope = 1, intercept = 0, lty = "dashed", color = "grey70", lwd = 1.3) + # Contrast line
  labs(title = "Predicted vs Actual AQI in Linear Model with LOESS Smooth Line")

# Summary Insight
paste(" Across six sites, actual AQI aligns well with predictions, particularly Queen Street Traffic (R = 0.84) and Westlake Traffic (R = 0.75). Residential sites show moderate correlations (R ≈ 0.59), except Westlake Residential (R ≈ 0.23), indicating weaker predictive reliability. ")

# Plot predicted versus actual for GAM model
plot_model(AQI, predict(model_gam), sa2_name_type) +
  geom_point(size = 1.8, alpha = 0.7, color = viridis(5)[2]) +
  geom_abline(slope = 1, intercept = 0, lty = "dashed", color = "grey70", lwd = 1.3) + # Contrast line
  labs(title = "Predicted vs Actual AQI in GAM Model with LOESS Smooth Line")

# Summary Insight
paste(" Actual AQI aligns with predicted AQI across sites, though correlations vary. Strong agreement in Queen Street traffic (R = 0.85) contrasts weaker alignment in Westlake residential (R = 0.23). LOESS smoothing highlights deviations, emphasizing nonlinear pollutant dynamics influenced by site-specific traffic and environmental factors. ")

# Plot predicted versus actual for Random Forest model
plot_model(AQI, predict(model_rf), sa2_name_type) +
  geom_point(size = 1.8, alpha = 0.7, color = viridis(5)[4]) +
  geom_abline(slope = 1, intercept = 0, lty = "dashed", color = "grey70", lwd = 1.3) +
  labs(title = "Predicted vs Actual AQI in Random Forest Model with LOESS Smooth Line")

# Summary Insight
paste(" The Random Forest model predicts AQI well, with R values from 0.76 to 0.97. The LOESS smooth line reveals deviations, especially in lower ranges. Predictions align closely at higher values, but site-specific variations exist. Westlake traffic shows the largest discrepancy. ")
```

## Unveiling the Unseen: Residual Analysis Deep Dive!
Ever wonder what your model missed? We're diving into residual analysis to unearth the "noise" left behind. This crucial step flags outliers and uncovers hidden patterns in our AQI predictions, ensuring our models aren't just fitting, but truly understanding the data's nuances. Join us as we scrutinize the remaining mystery!

```{r add_outlier_flags-and-plot_residuals_vs_fitted}
# Add residual flags to identify outliers (>2× SD)
filtered_merged <- filtered_merged |>
  mutate(
    resid_rf = AQI - predict(model_rf),
    large_lm = abs(resid(model_lm)) > 2 * sd(resid(model_lm), na.rm = TRUE),
    large_gam = abs(resid(model_gam)) > 2 * sd(resid(model_gam), na.rm = TRUE),
    large_rf = abs(resid_rf) > 2 * sd(resid_rf, na.rm = TRUE))

# Plot residuals vs fitted values
plot_model(predict(model_lm), resid(model_lm), sa2_name_type) +
  geom_point(aes(color = large_lm), alpha = 0.8, size = 2) +
  scale_color_manual(
    values = c("FALSE" = "#0072B2", "TRUE" = "#D55E00")) +
  geom_hline(yintercept = 0, lty = "dashed", color = "grey30", lwd = 1.3) +
  scale_y_continuous() + 
  labs(
    title = "Fitted versus Residuals of Air Quality Index (AQI) in Linear Model with LOESS Smooth Line",
    subtitle = "Residual Outliers are highlighted in red",
    x = "Fitted AQI", y = "Residuals", color = "Outlier Residual")

# Summary Insight
paste(" Fitted AQI values exhibit site-specific residual correlations, with Queen Street Residential showing the strongest negative trend (R = -0.66), indicating under/overfitting. Residuals fluctuate around zero, revealing non-uniform error structures. Ellerslie South, Patumahoe, and Queen Street Traffic show near-zero correlations. LOESS smoothing captures nonlinear pollutant variations. ")

# Residual plot for generalised additive model
plot_model(predict(model_gam), resid(model_gam), sa2_name_type) +
  geom_point(aes(color = large_gam), alpha = 0.8, size = 2) +
  scale_color_manual(
    values = c("FALSE" = "#0072B2", "TRUE" = "#D55E00")) +
  geom_hline(yintercept = 0, lty = "dashed", color = "grey30", lwd = 1.3) + # Contrast line
  scale_y_continuous() + 
  labs(
    title = "Residuals versus Fitted in GAM Model with LOESS Smooth Line",
    subtitle = "Residual Outliers are highlighted in red",
    x = "Fitted AQI", y = "Residuals", color = "Outlier Residual")

# Summary Insight
paste(" Queen Street (Residential) exhibits the strongest negative correlation, suggesting potential underfitting or overfitting. Ellerslie South has the weakest correlation, indicating stability. Patumahoe shows slight negative trends, but the correlation is near zero, implying well-distributed residuals. Westlake sites present mixed results with non-significant correlations; Westlake (Traffic) has a better correlation closer to zero, though still non-significant. Outliers vary across locations, influencing residual distributions. ")

# Residual plot for random forest model
plot_model(predict(model_rf), resid_rf, sa2_name_type) +
  geom_point(aes(color = large_rf), alpha = 0.8, size = 2) +
  scale_color_manual(
    values = c("FALSE" = "#0072B2", "TRUE" = "#D55E00")) +
  geom_hline(yintercept = 0, lty = "dashed", color = "grey30", lwd = 1.3) + 
  scale_y_continuous() + 
  labs(
    title = "Residuals versus Fitted in Random Forest Model with LOESS Smooth Line",
    subtitle = "Residual Outliers are highlighted in red",
    x = "Fitted AQI", y = "Residuals", color = "Outlier Residual")

# Summary Insight
paste(" Residuals vary across sites, with weak residential correlations (R ≤ 0.43) and minimal trends in traffic zones (R = 0.023, 0.064). LOESS smoothing highlights nonlinear mispredictions in dense urban areas. Ellerslie South and Patumahoe show clustering, while Queen Street (Traffic), Westlake (Traffic) approach random distribution. ")
```

# Session Information and Environment Details
This section captures the R session details, including loaded packages and versions, to support reproducibility and ensure consistent results across computing environments.

<details><summary>Read more...</summary>

```{r session-info}
# Display session information to track package versions and environment details
sessionInfo() 

# Summary Insight
paste("This sessionInfo() output shows the R version (4.4.3), system details, locale, and all currently loaded packages. It documents the analytical environment used for reproducible air quality and traffic analysis involving spatial, statistical, and time series methods.")
```

# Ensuring Reproducibility
To promote reproducibility, set.seed() was used wherever randomness occurred, ensuring consistent results. The final .html report—rendered with Quarto for enhanced features—and all figures were published to a public Git repository for transparency and accessibility. Relative file paths prevented system-specific errors, and code was structured into well-labeled, readable chunks. Memory was reclaimed with gc() after removing large datasets. Although datasets weren’t serialized, the environment was cleared using rm(list = ls()) before knitting, required packages were explicitly loaded, and sessionInfo() documented the computing environment to support cross-system reproducibility.

# Technical Challenges
Several technical challenges affected performance and reproducibility. Aggregating large sf objects slowed knitting; using st_drop_geometry() before summarization and rejoining geometries afterward significantly improved speed. Conflicts from interactively created objects were resolved by clearing the environment with rm(list = ls()). The floating Table of Contents overlapped content after “Read more…” clicks, requiring layout tweaks. Filenames containing special characters disrupted zipping processes and needed renaming. Restarting the RStudio project before knitting avoided persistent caching issues. Large datasets were removed using rm() and gc() to reclaim memory. Rendering with Quarto enhanced efficiency, particularly for complex visualizations and multi-panel spatial plots.

# Performance Limitation
Rendering spatial plots with faceted sf geometries significantly increased knitting time, particularly when using geom_sf() and geom_sf_text() across multiple years. Each facet triggered a full redraw of base maps and labels, contributing to long rendering times during HTML generation. While these visuals provided valuable insights, the computational cost limited scalability for larger or more detailed datasets. Future improvements could include simplifying geometries, limiting the number of facets, or using interactive map libraries (e.g., leaflet) to maintain interpretability while improving performance and user experience.

# Concluding Insights on Air Pollution and Traffic Patterns Across Auckland Regions
Between 2017 and 2024, urban locations like Queen Street consistently exhibited the highest pollutant concentrations and traffic volumes, highlighting the influence of dense development and the urban heat island effect. In contrast, rural sites such as Patumahoe maintained low pollution and traffic, emphasizing stark regional disparities. COVID-19 lockdowns led to notable reductions in both traffic and pollution, especially in urban centers, with varying post-lockdown recovery patterns. Heavy vehicle traffic strongly influenced NO2 and AQI trends in urban areas, while rural pollution patterns indicated contributions from non-traffic sources. A Random Forest model accurately predicted AQI, identifying PM10 and date as key predictors, underscoring the complex interactions between traffic, weather, and air quality dynamics.
</details>